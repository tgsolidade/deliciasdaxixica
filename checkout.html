<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Pedido</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* TIPO DE ENTREGA */
        .entrega-switch { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .entrega-option { flex: 1; text-align: center; cursor: pointer; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 12px; background: white; transition: 0.2s; }
        .entrega-option:hover { border-color: #ddd; }
        .entrega-option.selected { border-color: var(--cor-primaria); background: #fff0ed; color: var(--cor-primaria); font-weight: 700; box-shadow: 0 4px 10px rgba(230, 57, 70, 0.15); }
        .entrega-icon { font-size: 1.5rem; display: block; margin-bottom: 0.5rem; }

        /* RESUMO DE VALORES */
        .resumo-linha { display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: #666; font-size: 0.9rem; }
        .resumo-total { display: flex; justify-content: space-between; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; font-size: 1.3rem; font-weight: 800; color: var(--cor-primaria); }

        /* PAGAMENTO */
        .pagamento-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; }
        .pagamento-opcao input { display: none; }
        .pagamento-card { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem; padding: 1rem; background: var(--cor-fundo); border: 2px solid transparent; border-radius: 12px; transition: all 0.2s; height: 100%; text-align: center; cursor: pointer; }
        .pagamento-opcao input:checked + .pagamento-card { background: #fff0ed; border-color: var(--cor-primaria); color: var(--cor-primaria); font-weight: 700; }

        .hidden { display: none !important; }
        .pix-container { text-align: center; background: #f0fdf4; border: 1px dashed #16a34a; padding: 1.5rem; border-radius: 12px; margin-top: 1rem; }
        .pix-code { word-break: break-all; font-family: monospace; background: white; padding: 10px; border-radius: 8px; border: 1px solid #bbf7d0; margin: 10px 0; color: #166534; font-size: 0.8rem; }
        #qr-code-canvas { border: 5px solid white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    </style>
</head>
<body>
    
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <div class="logo-icon">üçï</div>
                <span>Finalizar Pedido</span>
            </a>
            <a href="index.html" style="text-decoration: none; color: var(--cor-texto);">Voltar</a>
        </div>
    </header>

    <main class="container" style="max-width: 800px;">
        <form id="form-checkout">
            <div style="background: white; padding: 1.5rem; border-radius: 16px; box-shadow: var(--sombra-card); margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">üìç Como deseja receber?</h3>
                <div class="entrega-switch">
                    <div class="entrega-option selected" id="opt-entrega" onclick="mudarEntrega('entrega')">
                        <span class="entrega-icon">üõµ</span> Entrega
                    </div>
                    <div class="entrega-option" id="opt-retirada" onclick="mudarEntrega('retirada')">
                        <span class="entrega-icon">üè™</span> Retirar no Local
                    </div>
                </div>

                <div id="box-endereco">
                    <div style="display: grid; gap: 1rem;">
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="cep" class="form-input" placeholder="CEP" style="width: 120px;">
                            <button type="button" class="btn btn-secundario" id="buscar-cep">üîç</button>
                            <input type="text" id="endereco" class="form-input" placeholder="Rua / Avenida" style="flex: 1;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="numero" class="form-input" placeholder="N¬∫" style="width: 80px;">
                            <input type="text" id="bairro" class="form-input" placeholder="Bairro" style="flex: 1;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="cidade" class="form-input" placeholder="Cidade" style="flex: 1;">
                            <input type="text" id="complemento" class="form-input" placeholder="Complemento (Opcional)">
                        </div>
                    </div>
                </div>
                
                <div id="box-retirada" class="hidden" style="text-align: center; color: #666; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <p>‚úÖ Voc√™ retirar√° o pedido no balc√£o assim que estiver pronto.</p>
                </div>
            </div>

            <div style="background: white; padding: 1.5rem; border-radius: 16px; box-shadow: var(--sombra-card); margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">üë§ Seus Dados</h3>
                <div style="display: grid; gap: 1rem;">
                    <input type="text" id="nome" class="form-input" placeholder="Seu Nome Completo" required>
                    <input type="tel" id="telefone" class="form-input" placeholder="WhatsApp (DDD) 99999-9999" required>
                </div>
            </div>

            <div style="background: white; padding: 1.5rem; border-radius: 16px; box-shadow: var(--sombra-card); margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">üì¶ Resumo do Pedido</h3>
                <div id="lista-itens"></div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #eee;">
                    <div class="resumo-linha">
                        <span>Subtotal Itens</span>
                        <span id="valor-subtotal">R$ 0,00</span>
                    </div>
                    <div class="resumo-linha">
                        <span>Taxa de Entrega</span>
                        <span id="valor-entrega">R$ 0,00</span>
                    </div>

                    <div id="resumo-encomenda" class="hidden" style="background: #fff7ed; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px dashed #f97316;">
                        <p style="font-size: 0.85rem; color: #ea580c; margin-bottom: 10px; text-align: center;">
                            ‚ö†Ô∏è Este pedido cont√©m itens sob encomenda. <br>
                            √â necess√°rio pagar <strong>50% de sinal</strong> agora.
                        </p>
                        <div class="resumo-linha" style="color: #c2410c; font-weight: 700; font-size: 1.1rem;">
                            <span>Sinal (Pagar Agora)</span>
                            <span id="valor-sinal">R$ 0,00</span>
                        </div>
                        <div class="resumo-linha" style="color: #444;">
                            <span>Restante (Na Entrega)</span>
                            <span id="valor-restante">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="resumo-total">
                        <span id="label-total">Total</span>
                        <span id="valor-total">R$ 0,00</span>
                    </div>
                </div>

                <h3 style="margin: 2rem 0 1rem;">üí≥ Forma de Pagamento (Sinal)</h3>
                
                <div class="pagamento-grid">
                    <label class="pagamento-opcao">
                        <input type="radio" name="pagamento" value="pix" required>
                        <div class="pagamento-card"><span style="font-size: 1.5rem;">üí†</span> PIX</div>
                    </label>
                    <label class="pagamento-opcao">
                        <input type="radio" name="pagamento" value="cartao_maquina">
                        <div class="pagamento-card"><span style="font-size: 1.5rem;">üì†</span> Maquininha</div>
                    </label>
                    <label class="pagamento-opcao">
                        <input type="radio" name="pagamento" value="dinheiro">
                        <div class="pagamento-card"><span style="font-size: 1.5rem;">üíµ</span> Dinheiro</div>
                    </label>
                </div>

                <div id="box-pix" class="hidden">
                    <div class="pix-container">
                        <p style="font-weight: 600; color: #166534; margin-bottom: 1rem;">Escaneie para pagar o Sinal:</p>
                        <canvas id="qr-code-canvas"></canvas>
                        <div class="pix-code" id="pix-copia-cola">Gerando...</div>
                        <button type="button" class="btn btn-outline" id="btn-copiar-pix">üìã Copiar C√≥digo</button>
                    </div>
                </div>

                <div id="box-dinheiro" class="hidden" style="margin-top: 1rem;">
                    <label class="form-label">Troco para quanto?</label>
                    <input type="number" id="troco" class="form-input" placeholder="Ex: 50.00">
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-bottom: 3rem;">
                <button type="button" onclick="window.location.href='index.html'" class="btn" style="flex: 1; background: #e5e7eb;">‚ùå Cancelar</button>
                <button type="submit" class="btn btn-primario" id="btn-finalizar" style="flex: 2; padding: 1.2rem; font-size: 1.1rem;">‚úÖ Finalizar Pedido</button>
            </div>
        </form>
    </main>

    <div id="toast-container"></div>

    <script type="module">
        import { db, collection, addDoc, getDocs, doc, query, where, orderBy, limit, formatarPreco, mostrarNotificacao, buscarEnderecoPorCEP, validarCEP, COLLECTIONS, STATUS_PEDIDO } from '../assets/js/firebase-config.js';

        let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
        if (carrinho.length === 0) window.location.href = 'index.html';

        let configLoja = { taxaEntrega: 0, chavePix: '', nomePix: '', cidadePix: '' };
        let tipoEntrega = 'entrega';
        let subtotal = carrinho.reduce((acc, item) => acc + (item.preco * item.quantidade), 0);
        let pixCode = '';
        
        // VARI√ÅVEIS NOVAS PARA L√ìGICA DE 50%
        let temEncomenda = carrinho.some(item => item.sobEncomenda);
        let valorSinal = 0;
        let valorRestante = 0;
        let valorPagarAgora = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            await carregarConfig();
            renderizarItens();
            atualizarValores();
            configurarEventos();
        });

        async function carregarConfig() {
            try {
                const snap = await getDocs(collection(db, COLLECTIONS.CONFIGURACOES));
                if (!snap.empty) {
                    const d = snap.docs[0].data();
                    configLoja = { taxaEntrega: d.taxaEntrega || 0, chavePix: d.chavePix || '', nomePix: d.nomeBeneficiario || '', cidadePix: d.cidadeBeneficiario || '' };
                }
            } catch (e) { console.error(e); }
        }

        window.mudarEntrega = (tipo) => {
            tipoEntrega = tipo;
            document.querySelectorAll('.entrega-option').forEach(el => el.classList.remove('selected'));
            document.getElementById(`opt-${tipo}`).classList.add('selected');
            
            if (tipo === 'entrega') {
                document.getElementById('box-endereco').classList.remove('hidden');
                document.getElementById('box-retirada').classList.add('hidden');
                document.getElementById('endereco').required = true;
                document.getElementById('bairro').required = true;
            } else {
                document.getElementById('box-endereco').classList.add('hidden');
                document.getElementById('box-retirada').classList.remove('hidden');
                document.getElementById('endereco').required = false;
                document.getElementById('bairro').required = false;
            }
            atualizarValores();
        };

        function atualizarValores() {
            const taxa = tipoEntrega === 'entrega' ? configLoja.taxaEntrega : 0;
            const totalCheio = subtotal + taxa;

            document.getElementById('valor-subtotal').textContent = formatarPreco(subtotal);
            document.getElementById('valor-entrega').textContent = tipoEntrega === 'entrega' ? formatarPreco(taxa) : 'Gr√°tis';

            // L√ìGICA DE ENCOMENDA
            if (temEncomenda) {
                // 50% de sinal + 50% restante
                valorSinal = totalCheio / 2;
                valorRestante = totalCheio - valorSinal;
                valorPagarAgora = valorSinal;

                document.getElementById('resumo-encomenda').classList.remove('hidden');
                document.getElementById('valor-sinal').textContent = formatarPreco(valorSinal);
                document.getElementById('valor-restante').textContent = formatarPreco(valorRestante);
                
                document.getElementById('label-total').textContent = "Total a Pagar Agora";
                document.getElementById('valor-total').textContent = formatarPreco(valorPagarAgora);
            } else {
                // Pedido Normal
                valorSinal = totalCheio; 
                valorRestante = 0;
                valorPagarAgora = totalCheio;

                document.getElementById('resumo-encomenda').classList.add('hidden');
                document.getElementById('label-total').textContent = "Total";
                document.getElementById('valor-total').textContent = formatarPreco(valorPagarAgora);
            }

            // Regenera PIX se necess√°rio
            if(document.querySelector('input[name="pagamento"]:checked')?.value === 'pix') {
                gerarPixVisual(valorPagarAgora);
            }
        }

        function renderizarItens() {
            const div = document.getElementById('lista-itens');
            carrinho.forEach(item => {
                let info = '';
                if(item.sobEncomenda) info += '<span style="background:#3b82f6;color:white;font-size:0.7rem;padding:2px 5px;border-radius:4px;margin-left:5px">Encomenda</span>';
                if(item.encomenda) info += `<br><small style="color:#1e40af">üìÖ Agendado: ${new Date(item.encomenda.data+'T00:00:00').toLocaleDateString('pt-BR')} √†s ${item.encomenda.hora}</small>`;
                
                div.innerHTML += `
                    <div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:5px; padding-bottom:5px; border-bottom:1px solid #eee">
                        <div>
                            <span>${item.quantidade}x ${item.nome}</span>
                            ${info}
                        </div>
                        <span style="font-weight:600">${formatarPreco(item.preco * item.quantidade)}</span>
                    </div>
                `;
            });
        }

        // GERA√á√ÉO DE ID DI√ÅRIO
        async function gerarProximoIdDiario() {
            try {
                const hoje = new Date(); hoje.setHours(0,0,0,0);
                const q = query(collection(db, COLLECTIONS.PEDIDOS), where("criadoEm", ">=", hoje), orderBy("criadoEm", "desc"), limit(1));
                const snap = await getDocs(q);
                let seq = 1;
                if(!snap.empty && snap.docs[0].data().idDisplay) seq = parseInt(snap.docs[0].data().idDisplay.replace('#','')) + 1;
                return '#' + seq.toString().padStart(4, '0');
            } catch(e) { return '#' + Math.floor(Math.random()*9999); }
        }

        // SUBMIT DO PEDIDO
        document.getElementById('form-checkout').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-finalizar');
            const formaPag = document.querySelector('input[name="pagamento"]:checked')?.value;
            
            if (!formaPag) return mostrarNotificacao('Selecione o pagamento!', 'erro');
            
            btn.disabled = true; btn.textContent = 'Enviando...';

            try {
                const taxa = tipoEntrega === 'entrega' ? configLoja.taxaEntrega : 0;
                const totalCheio = subtotal + taxa;
                const idVisual = await gerarProximoIdDiario();

                const pedido = {
                    idDisplay: idVisual,
                    cliente: {
                        nome: document.getElementById('nome').value,
                        telefone: document.getElementById('telefone').value.replace(/\D/g, '')
                    },
                    tipoEntrega: tipoEntrega,
                    endereco: tipoEntrega === 'entrega' ? {
                        cep: document.getElementById('cep').value,
                        logradouro: document.getElementById('endereco').value,
                        numero: document.getElementById('numero').value,
                        bairro: document.getElementById('bairro').value,
                        cidade: document.getElementById('cidade').value,
                        complemento: document.getElementById('complemento').value
                    } : null,
                    itens: carrinho,
                    
                    // DADOS FINANCEIROS ATUALIZADOS
                    total: totalCheio,
                    isEncomenda: temEncomenda,
                    valorSinal: valorSinal,       // Quanto pagou hoje
                    valorRestante: valorRestante, // Quanto falta pagar
                    saldoDevedor: valorRestante > 0, // Flag simples para o admin
                    
                    pagamento: {
                        forma: formaPag,
                        status: temEncomenda ? 'parcial_sinal' : 'total_pago',
                        troco: document.getElementById('troco').value || null,
                        pixCode: formaPag === 'pix' ? pixCode : null
                    },
                    status: STATUS_PEDIDO.RECEBIDO,
                    criadoEm: new Date(),
                    atualizadoEm: new Date(),
                    dataEntregaRealizada: null // Ser√° preenchido na entrega
                };

                const docRef = await addDoc(collection(db, COLLECTIONS.PEDIDOS), pedido);
                
                // Salva ID Local
                let meusPedidos = JSON.parse(localStorage.getItem('meus_pedidos_ids')) || [];
                meusPedidos.push(docRef.id);
                localStorage.setItem('meus_pedidos_ids', JSON.stringify(meusPedidos));

                localStorage.removeItem('carrinho');
                enviarWhatsApp(pedido);
                mostrarNotificacao('Pedido Realizado!', 'sucesso');
                setTimeout(() => window.location.href = 'index.html', 2000);

            } catch (error) {
                console.error(error);
                mostrarNotificacao('Erro ao enviar pedido.', 'erro');
                btn.disabled = false; btn.textContent = '‚úÖ Finalizar Pedido';
            }
        });

        // Eventos de Pagamento
        document.querySelectorAll('input[name="pagamento"]').forEach(el => {
            el.addEventListener('change', (e) => {
                const val = e.target.value;
                document.getElementById('box-pix').classList.add('hidden');
                document.getElementById('box-dinheiro').classList.add('hidden');
                
                if(val === 'pix') {
                    document.getElementById('box-pix').classList.remove('hidden');
                    gerarPixVisual(valorPagarAgora); // Gera apenas do valor a pagar agora
                }
                if(val === 'dinheiro') document.getElementById('box-dinheiro').classList.remove('hidden');
            });
        });

        document.getElementById('btn-copiar-pix').onclick = () => {
            navigator.clipboard.writeText(pixCode);
            mostrarNotificacao('Copiado!', 'sucesso');
        };

        // --- WHATSAPP ---
        function enviarWhatsApp(p) {
            let msg = `üçï *NOVO PEDIDO ${p.idDisplay}*\n`;
            msg += `üë§ ${p.cliente.nome}\n`;
            msg += `üì¶ *Tipo:* ${p.tipoEntrega === 'entrega' ? 'üõµ Entrega' : 'üè™ Retirada'}\n\n`;
            
            p.itens.forEach(i => {
                msg += `‚ñ™Ô∏è ${i.quantidade}x ${i.nome}`;
                if(i.sobEncomenda) msg += ` ‚è≥`;
                msg += `\n`;
                if(i.encomenda) msg += `   üìÖ *Agendado:* ${new Date(i.encomenda.data+'T00:00:00').toLocaleDateString('pt-BR')} √†s ${i.encomenda.hora}\n`;
            });

            msg += `\nüí∞ *Financeiro:*`;
            if (p.isEncomenda) {
                msg += `\nüîµ *Sinal Pago:* ${formatarPreco(p.valorSinal)}`;
                msg += `\nüî¥ *Restante na Entrega:* ${formatarPreco(p.valorRestante)}`;
            } else {
                msg += `\n‚úÖ Total: ${formatarPreco(p.total)}`;
            }
            
            msg += `\nüí≥ Pagamento Atual: ${p.pagamento.forma.toUpperCase()}`;
            if(p.pagamento.troco) msg += ` (Troco p/ ${p.pagamento.troco})`;

            if(p.tipoEntrega === 'entrega') {
                msg += `\n\nüìç *Endere√ßo:*\n${p.endereco.logradouro}, ${p.endereco.numero}\n${p.endereco.bairro}`;
                if(p.endereco.complemento) msg += `\nComp: ${p.endereco.complemento}`;
            }

            getDocs(collection(db, COLLECTIONS.CONFIGURACOES)).then(snap => {
                let tel = '';
                if(!snap.empty) tel = snap.docs[0].data().whatsapp || '';
                if(tel) window.open(`https://wa.me/${tel.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
            });
        }

        // Fun√ß√µes PIX e CEP (Mantidas iguais)
        document.getElementById('buscar-cep').onclick = async () => {
            const cep = document.getElementById('cep').value;
            if (validarCEP(cep)) {
                const end = await buscarEnderecoPorCEP(cep);
                if (end) {
                    document.getElementById('endereco').value = end.logradouro;
                    document.getElementById('bairro').value = end.bairro;
                    document.getElementById('cidade').value = end.cidade;
                    document.getElementById('numero').focus();
                }
            } else mostrarNotificacao('CEP Inv√°lido', 'erro');
        };

        function gerarPixVisual(valor) {
            if(!configLoja.chavePix) return;
            const payload = gerarPayloadPix(configLoja.chavePix, configLoja.nomePix, configLoja.cidadePix, valor.toFixed(2));
            pixCode = payload;
            document.getElementById('pix-copia-cola').textContent = payload;
            new QRious({ element: document.getElementById('qr-code-canvas'), value: payload, size: 200 });
        }

        function gerarPayloadPix(chave, nome, cidade, valor) {
            const nomeTratado = nome.substring(0, 25).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
            const cidadeTratada = cidade.substring(0, 15).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
            const payload = [
                formatField("00", "01"),
                formatField("26", [formatField("00", "BR.GOV.BCB.PIX"), formatField("01", chave)].join("")),
                formatField("52", "0000"), formatField("53", "986"), formatField("54", valor),
                formatField("58", "BR"), formatField("59", nomeTratado), formatField("60", cidadeTratada),
                formatField("62", formatField("05", "***")), "6304"
            ].join("");
            return payload + crc16(payload);
        }
        function formatField(id, value) { return id + value.length.toString().padStart(2, "0") + value; }
        function crc16(payload) {
            let crc = 0xFFFF;
            for (let i = 0; i < payload.length; i++) {
                crc ^= payload.charCodeAt(i) << 8;
                for (let j = 0; j < 8; j++) {
                    if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021; else crc = crc << 1;
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, "0");
        }
    </script>
</body>
</html>