<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card√°pio Online</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* --- SISTEMA SPA --- */
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- GERAL --- */
        body { background-color: #f3f4f6; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        
        /* Cabe√ßalho */
        .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; display: inline-flex; align-items: center; gap: 5px; }
        .status-aberta { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status-fechada { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* --- LAYOUT GRID --- */
        .layout-grid { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .sidebar-desktop { display: none; }

        @media (min-width: 1024px) {
            .layout-grid { display: grid; grid-template-columns: 1fr 380px; gap: 30px; align-items: start; padding-top: 20px; }
            .sidebar-desktop { display: block; background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; border: 1px solid #e5e7eb; }
            .btn-flutuante { display: none !important; }
            .produtos-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important; }
            /* Ajuste Whats no PC */
            .whats-float { bottom: 20px !important; }
        }

        /* --- COMPONENTES --- */
        .categoria-nav { position: sticky; top: 0; z-index: 80; background: #f3f4f6; padding: 10px 0; overflow-x: auto; white-space: nowrap; margin-bottom: 10px; }
        .categoria-lista { display: flex; gap: 10px; padding: 0 5px; list-style: none; }
        .cat-btn { padding: 8px 16px; border-radius: 20px; background: white; border: 1px solid #e5e7eb; color: #4b5563; font-weight: 600; font-size: 0.9rem; transition: 0.2s; white-space: nowrap; cursor: pointer; }
        .cat-btn.active { background: var(--cor-primaria); color: white; border-color: var(--cor-primaria); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .secao-categoria { margin-bottom: 2rem; scroll-margin-top: 80px; }
        .secao-titulo { font-size: 1.4rem; font-weight: 800; margin: 0 0 1rem 0; color: #1f2937; border-left: 4px solid var(--cor-primaria); padding-left: 10px; }
        .produtos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }

        .produto-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.1s; position: relative; display: flex; flex-direction: column; height: 100%; cursor: pointer; }
        .produto-card:active { transform: scale(0.98); }
        .produto-imagem { width: 100%; height: 140px; object-fit: cover; background: #eee; }
        .produto-info { padding: 12px; display: flex; flex-direction: column; flex-grow: 1; }
        .produto-titulo { font-size: 0.95rem; font-weight: 700; color: #1f2937; margin-bottom: 5px; line-height: 1.3; }
        .produto-descricao { font-size: 0.8rem; color: #6b7280; margin-bottom: 10px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1; }
        .produto-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .produto-preco { font-weight: 800; color: #1f2937; font-size: 1.1rem; }
        .preco-antigo { text-decoration: line-through; color: #9ca3af; font-size: 0.8rem; margin-right: 5px; }
        .preco-novo { color: #dc2626; }
        .btn-add { width: 32px; height: 32px; border-radius: 50%; background: var(--cor-primaria); color: white; border: none; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .badge-encomenda { position: absolute; top: 8px; right: 8px; background: #2563eb; color: white; font-size: 0.7rem; font-weight: 700; padding: 3px 8px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; }

        /* --- CHECKOUT --- */
        .checkout-container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .checkout-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .entrega-switch { display: flex; gap: 10px; margin-bottom: 15px; }
        .entrega-option { flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 600; color: #6b7280; transition: 0.2s; }
        .entrega-option.selected { border-color: var(--cor-primaria); background: #fff0ed; color: var(--cor-primaria); }
        .pagamento-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .pagamento-option { border: 2px solid #e5e7eb; border-radius: 10px; padding: 15px 5px; text-align: center; cursor: pointer; }
        .pagamento-option.selected { border-color: var(--cor-primaria); background: #fff0ed; color: var(--cor-primaria); font-weight: 700; }
        
        .resumo-linha { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: #4b5563; }
        .resumo-desconto { color: #16a34a; font-size: 0.9rem; }
        .resumo-total { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #e5e7eb; font-weight: 900; font-size: 1.4rem; color: #1f2937; }

        /* Bot√£o Flutuante Carrinho */
        .btn-flutuante { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: var(--cor-primaria); color: white; padding: 15px; border-radius: 50px; text-align: center; font-weight: 700; font-size: 1.1rem; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; transition: transform 0.2s; cursor: pointer; }
        .btn-flutuante:active { transform: translateX(-50%) scale(0.95); }

        /* Bot√£o Flutuante WhatsApp */
        .whats-float { position: fixed; bottom: 90px; right: 20px; width: 55px; height: 55px; background: #25D366; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 99; transition: transform 0.2s; }
        .whats-float:hover { transform: scale(1.1); }
        .whats-float img { width: 35px; height: 35px; }
        
        /* Modais */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; animation: slideUp 0.3s ease-out; max-height: 90vh; overflow-y: auto; }
        @media(min-width: 768px) { .modal { border-radius: 16px; align-self: center; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Bot√£o Novo Endere√ßo */
        .btn-novo-end { background: none; border: 1px solid #ddd; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; color: #666; cursor: pointer; float: right; }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; animation: fadeIn 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .toast.sucesso { background: #10b981; } .toast.erro { background: #ef4444; }
    </style>
</head>
<body>
    
    <header class="header">
        <div class="header-container">
            <a href="#" onclick="trocarTela('cardapio')" class="logo">
                <img id="logo-img" src="" style="width: 40px; height: 40px; border-radius: 50%; display: none; margin-right: 10px;" onerror="this.style.display='none'; document.getElementById('logo-text').style.display='inline';">
                <span id="logo-text" style="font-size: 1.5rem;">üçï</span>
                <span id="nome-restaurante" style="font-weight: 700; font-size: 1.1rem;">Carregando...</span>
            </a>
            <button onclick="abrirRastreio()" style="background:white; color:var(--cor-primaria); border:1px solid var(--cor-primaria); padding:6px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
                <span>üõµ</span> Acompanhar Pedido
            </button>
        </div>
    </header>

    <div style="background: white; padding: 10px 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
        <span id="status-loja" class="status-badge status-fechada">‚óè Verificando...</span>
        <span id="tempo-entrega" style="color: #6b7280;">üïí -- min</span>
    </div>

    <div id="view-cardapio" class="view-section active">
        <div class="layout-grid">
            <div class="coluna-produtos">
                <nav class="categoria-nav"><ul class="categoria-lista" id="nav-categorias"></ul></nav>
                <div style="margin-bottom: 15px;"><p id="slogan-texto" style="color: #6b7280; font-size: 0.9rem;"></p></div>
                <main>
                    <div id="loading" style="text-align: center; padding: 40px;"><div class="loading"></div></div>
                    <div id="catalogo"></div>
                    <div id="sem-produtos" class="hidden" style="text-align: center; padding: 50px 20px; color: #9ca3af;"><h3>Card√°pio em atualiza√ß√£o</h3></div>
                </main>
            </div>
            
            <aside class="sidebar-desktop">
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h3 style="font-size: 1.2rem; color: #1f2937;">üõí Seu Pedido</h3>
                </div>
                <div id="lista-carrinho-desktop">
                    <p style="text-align: center; color: #9ca3af; padding: 20px;">Seu carrinho est√° vazio üò¢</p>
                </div>
                <div id="footer-carrinho-desktop" class="hidden" style="margin-top: 20px; border-top: 2px dashed #eee; padding-top: 15px;">
                    <div class="resumo-linha"><span>Subtotal (Itens)</span><span id="dsk-subtotal">R$ 0,00</span></div>
                    <div class="resumo-linha resumo-desconto" id="dsk-box-desc"><span>Descontos</span><span id="dsk-desconto">- R$ 0,00</span></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 800; font-size: 1.3rem; color: #374151; margin-top:10px;">
                        <span>Total:</span> <span id="total-carrinho-desktop">R$ 0,00</span>
                    </div>
                    <button onclick="irParaCheckout()" class="btn btn-primario" style="width: 100%;">Finalizar Compra</button>
                </div>
            </aside>
        </div>
    </div>

    <div id="view-checkout" class="view-section">
        <div class="checkout-container">
            <h2 style="margin-bottom: 15px;">Finalizar Pedido</h2>
            
            <div class="checkout-card">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">üìç Entrega</h3>
                <div class="entrega-switch">
                    <div class="entrega-option selected" id="opt-entrega" onclick="mudarEntrega('entrega')">üõµ Entrega</div>
                    <div class="entrega-option" id="opt-retirada" onclick="mudarEntrega('retirada')">üè™ Retirada</div>
                </div>
                
                <div id="box-endereco">
                    <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.85rem; color:#666;">Endere√ßo de entrega:</span>
                        <button type="button" class="btn-novo-end" onclick="limparEndereco()">üìù Novo Endere√ßo</button>
                    </div>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="cep" class="form-input" placeholder="CEP" onblur="buscarCep(this.value)" style="width: 100px;">
                            <input type="text" id="endereco" class="form-input" placeholder="Rua" style="flex:1">
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="numero" class="form-input" placeholder="N¬∫" style="width: 70px;">
                            <input type="text" id="bairro" class="form-input" placeholder="Bairro" style="flex:1">
                        </div>
                        <input type="text" id="cidade" class="form-input" placeholder="Cidade">
                        <input type="text" id="complemento" class="form-input" placeholder="Complemento (Opcional)">
                    </div>
                </div>
                <div id="box-retirada" class="hidden" style="text-align: center; color: #666; padding: 10px; background: #f9fafb; border-radius: 8px;"><p>Voc√™ ir√° retirar o pedido no balc√£o.</p></div>
            </div>

            <div class="checkout-card">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">üë§ Seus Dados</h3>
                <input type="text" id="nome-cliente" class="form-input" placeholder="Seu Nome" style="margin-bottom: 10px;">
                <input type="tel" id="tel-cliente" class="form-input" placeholder="WhatsApp (DDD) 99999-9999">
            </div>

            <div class="checkout-card">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">üçî Itens</h3>
                <div id="lista-resumo-checkout"></div>
            </div>

            <div class="checkout-card">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">üí≥ Pagamento</h3>
                <div id="alert-sinal" class="hidden" style="background: #fff7ed; padding: 10px; border-radius: 8px; border: 1px dashed #f97316; margin-bottom: 15px; font-size: 0.9rem; color: #c2410c;">‚ö†Ô∏è Pedido sob encomenda. Necess√°rio <strong>Sinal de 50%</strong>.</div>
                <div class="pagamento-grid">
                    <div class="pagamento-option" onclick="selPag('pix', this)" data-val="pix">üí† PIX</div>
                    <div class="pagamento-option" onclick="selPag('cartao', this)" data-val="cartao_maquina">üí≥ Cart√£o</div>
                    <div class="pagamento-option" onclick="selPag('dinheiro', this)" data-val="dinheiro">üíµ Dinheiro</div>
                </div>
                <div id="box-pix" class="hidden" style="margin-top: 15px; text-align: center;">
                    <p style="font-size: 0.9rem; color: #166534; margin-bottom: 5px;">Escaneie para pagar:</p>
                    <canvas id="qr-code" style="width: 150px; border: 4px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px;"></canvas>
                    <div id="pix-code-text" style="font-size: 0.7rem; word-break: break-all; background: #f0fdf4; padding: 5px; border-radius: 4px; margin-top: 5px;"></div>
                    <button class="btn-outline" onclick="copiarPix()" style="margin-top: 5px; font-size: 0.8rem;">Copiar C√≥digo</button>
                </div>
                <div id="box-dinheiro" class="hidden" style="margin-top: 10px;"><input type="number" id="troco" class="form-input" placeholder="Troco para quanto? (Ex: 50)"></div>
            </div>

            <div class="checkout-card">
                <div class="resumo-linha"><span>Subtotal (Sem descontos)</span> <span id="chk-subtotal">R$ 0,00</span></div>
                <div class="resumo-linha resumo-desconto" id="chk-box-desc"><span>Descontos</span> <span id="chk-desconto">- R$ 0,00</span></div>
                <div class="resumo-linha"><span>Entrega</span> <span id="chk-entrega">R$ 0,00</span></div>
                <div class="resumo-total">
                    <span id="lbl-total">Total</span>
                    <span id="chk-total">R$ 0,00</span>
                </div>
                <div id="resumo-sinal" class="hidden" style="margin-top: 10px; font-size: 0.95rem; border-top:1px solid #eee; padding-top:10px;">
                    <div class="resumo-linha" style="color: #c2410c; font-weight: 700;"><span>Pagar Agora (Sinal)</span> <span id="chk-sinal">R$ 0,00</span></div>
                    <div class="resumo-linha"><span>Restante na Entrega</span> <span id="chk-restante">R$ 0,00</span></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 30px;">
                <button class="btn" onclick="trocarTela('cardapio')" style="flex:1; background:#e5e7eb; color: #374151;">Voltar</button>
                <button class="btn-primario" onclick="finalizarPedido()" style="flex:2;">‚úÖ Enviar Pedido</button>
            </div>
        </div>
    </div>

    <div id="btn-carrinho" class="btn-flutuante hidden" onclick="abrirModalCarrinho()">
        <span>üõí Meu Carrinho</span>
        <span id="float-total">R$ 0,00</span>
    </div>

    <a id="btn-whats-flutuante" href="#" target="_blank" class="whats-float hidden" title="Falar no WhatsApp">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
    </a>

    <div class="modal-overlay" id="modal-produto" onclick="if(event.target===this) fecharModal('modal-produto')">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">
                <h2 id="md-titulo" style="font-size:1.3rem; line-height:1.2;">...</h2>
                <button onclick="fecharModal('modal-produto')" style="background:none; border:none; font-size:1.5rem;">√ó</button>
            </div>
            
            <img id="md-img" src="" style="width:100%; height:200px; object-fit:cover; border-radius:12px; margin-bottom:15px; background:#eee;" onerror="this.src='https://placehold.co/400x200?text=Foto+Produto'">
            
            <p id="md-desc" style="color:#666; font-size:0.9rem; margin-bottom:10px; font-style: italic;"></p>
            <div id="md-detalhes-container" class="hidden" style="background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px;">
                <strong style="display:block; font-size:0.8rem; color:#4b5563; margin-bottom:4px;">Ingredientes / Detalhes:</strong>
                <p id="md-detalhes" style="color:#374151; font-size:0.85rem; margin:0; line-height:1.4;"></p>
            </div>

            <div id="md-encomenda-opt" class="hidden" style="background:#eff6ff; padding:10px; border-radius:8px; border:1px solid #bfdbfe; margin-bottom:15px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem; font-weight:600; color:#1e40af;">
                    <input type="checkbox" id="md-check-enc" onchange="toggleAgendamento(this)"> Agendar Entrega
                </label>
                <div id="md-agendamento" class="hidden" style="margin-top:10px; display:grid; gap:8px;">
                    <input type="date" id="md-data" class="form-input"><input type="time" id="md-hora" class="form-input">
                </div>
            </div>
            <textarea id="md-obs" class="form-textarea" placeholder="Observa√ß√µes? (Ex: Sem cebola, ponto da carne...)" rows="2" style="margin-bottom:15px;"></textarea>
            <div style="display:flex; gap:15px; align-items:center;">
                <div style="display:flex; align-items:center; border:1px solid #ddd; border-radius:8px;">
                    <button onclick="mudarQtd(-1)" style="padding:10px 15px; background:none; border:none; font-size:1.2rem;">-</button>
                    <span id="md-qtd" style="font-weight:700; width:30px; text-align:center;">1</span>
                    <button onclick="mudarQtd(1)" style="padding:10px 15px; background:none; border:none; font-size:1.2rem;">+</button>
                </div>
                <button class="btn-primario" onclick="addCarrinho()" style="flex:1; display:flex; justify-content:space-between; padding:12px 20px;">
                    <span>Adicionar</span><span id="md-preco">R$ 0,00</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-carrinho" onclick="if(event.target===this) fecharModal('modal-carrinho')">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2>Seu Pedido</h2><button onclick="fecharModal('modal-carrinho')" style="border:none; background:none; font-size:1.5rem;">√ó</button>
            </div>
            <div id="lista-carrinho" style="max-height:50vh; overflow-y:auto; margin-bottom:15px;"></div>
            <button class="btn-primario" onclick="irParaCheckout()" style="width:100%; padding:15px;">Finalizar Compra</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-rastreio" onclick="if(event.target===this) fecharModal('modal-rastreio')">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2>Acompanhar Pedidos</h2><button onclick="fecharModal('modal-rastreio')" style="border:none; background:none; font-size:1.5rem;">√ó</button>
            </div>
            <div id="lista-pedidos-rastreio" style="max-height:60vh; overflow-y:auto;">
                <p style="text-align:center; color:#999; padding:20px;">Carregando...</p>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        // CORRE√á√ÉO 2: Caminho do Javascript simplificado
        import { db, collection, getDocs, getDoc, doc, addDoc, onSnapshot, query, orderBy, formatarPreco, mostrarNotificacao, buscarEnderecoPorCEP, validarCEP, COLLECTIONS } from './firebase-config.js';

        let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
        let produtos = [], categorias = [], configLoja = {};
        let prodSel = null, qtdSel = 1, tipoEntrega = 'entrega', pagSel = '';
        let rastreioListeners = [];

        document.addEventListener('DOMContentLoaded', () => {
            initListeners();
            atualizarCarrinhoUI();
            carregarEnderecoSalvo(); 
        });

        // --- CACHE DE ENDERE√áO ---
        function carregarEnderecoSalvo() {
            const salvo = localStorage.getItem('ultimo_endereco');
            if(salvo) {
                const end = JSON.parse(salvo);
                if(end.cep) document.getElementById('cep').value = end.cep;
                if(end.logradouro) document.getElementById('endereco').value = end.logradouro;
                if(end.numero) document.getElementById('numero').value = end.numero;
                if(end.bairro) document.getElementById('bairro').value = end.bairro;
                if(end.cidade) document.getElementById('cidade').value = end.cidade;
                if(end.complemento) document.getElementById('complemento').value = end.complemento;
                if(end.nome) document.getElementById('nome-cliente').value = end.nome;
                if(end.tel) document.getElementById('tel-cliente').value = end.tel;
            }
        }

        window.limparEndereco = () => {
            document.getElementById('cep').value = '';
            document.getElementById('endereco').value = '';
            document.getElementById('numero').value = '';
            document.getElementById('bairro').value = '';
            document.getElementById('cidade').value = '';
            document.getElementById('complemento').value = '';
            mostrarNotificacao('Campos limpos para novo endere√ßo', 'sucesso');
        };

        // --- CORE ---
        function initListeners() {
            onSnapshot(collection(db, COLLECTIONS.CONFIGURACOES), snap => {
                if(!snap.empty) { configLoja = snap.docs[0].data(); atualizarUIConfig(); }
            });
            onSnapshot(query(collection(db, 'categorias'), orderBy('nome')), snap => {
                categorias = []; snap.forEach(d => categorias.push(d.data())); renderCatalogo();
            });
            onSnapshot(query(collection(db, COLLECTIONS.PRODUTOS), orderBy('nome')), snap => {
                produtos = []; snap.forEach(d => produtos.push({id:d.id, ...d.data()}));
                document.getElementById('loading').classList.add('hidden'); renderCatalogo();
            });
        }

        function atualizarUIConfig() {
            if(configLoja.nome) document.getElementById('nome-restaurante').textContent = configLoja.nome;
            if(configLoja.logoUrl) { 
                const img = document.getElementById('logo-img'); 
                img.src = configLoja.logoUrl; 
                img.style.display = 'block'; 
                document.getElementById('logo-text').style.display = 'none'; 
            }
            if(configLoja.slogan) document.getElementById('slogan-texto').textContent = configLoja.slogan;
            document.getElementById('tempo-entrega').textContent = `üïí ${configLoja.tempoEntrega || '-- min'}`;
            const badge = document.getElementById('status-loja');
            if(configLoja.lojaAberta) { badge.className = 'status-badge status-aberta'; badge.textContent = '‚óè Aberta'; }
            else { badge.className = 'status-badge status-fechada'; badge.textContent = '‚óè Fechada'; }
            
            const whatsBtn = document.getElementById('btn-whats-flutuante');
            if(configLoja.whatsapp) {
                whatsBtn.href = `https://wa.me/${configLoja.whatsapp.replace(/\D/g,'')}`;
                whatsBtn.classList.remove('hidden');
            }
        }

        function renderCatalogo() {
            const nav = document.getElementById('nav-categorias'); const main = document.getElementById('catalogo');
            nav.innerHTML = ''; main.innerHTML = '';
            if(produtos.length === 0) { document.getElementById('sem-produtos').classList.remove('hidden'); return; }
            document.getElementById('sem-produtos').classList.add('hidden');
            const catsAtivas = categorias.filter(c => produtos.some(p => p.categoria === c.slug));
            catsAtivas.forEach(cat => {
                nav.innerHTML += `<li><a href="#cat-${cat.slug}" class="cat-btn" onclick="scrollCat(event, 'cat-${cat.slug}')">${cat.nome}</a></li>`;
                const prodsCat = produtos.filter(p => p.categoria === cat.slug);
                const section = document.createElement('section'); section.id = `cat-${cat.slug}`; section.className = 'secao-categoria';
                section.innerHTML = `<h2 class="secao-titulo">${cat.nome}</h2><div class="produtos-grid"></div>`;
                const grid = section.querySelector('.produtos-grid');
                prodsCat.forEach(p => grid.appendChild(criarCard(p)));
                main.appendChild(section);
            });
        }

        function criarCard(p) {
            const div = document.createElement('div'); div.className = 'produto-card'; div.onclick = () => abrirModalProduto(p);
            const preco = (p.emPromocao && p.precoPromocional) ? p.precoPromocional : p.preco;
            const precoHtml = (p.emPromocao && p.precoPromocional) ? `<span class="preco-antigo">${formatarPreco(p.preco)}</span> <span class="preco-novo">${formatarPreco(preco)}</span>` : formatarPreco(preco);
            const pode = configLoja.lojaAberta || p.sobEncomenda;
            if(!pode) div.style.opacity = '0.6';
            // Placeholder corrigido
            div.innerHTML = `${p.sobEncomenda ? '<span class="badge-encomenda">ENCOMENDA</span>' : ''}<img src="${p.imagemUrl}" class="produto-imagem" onerror="this.src='https://placehold.co/200?text=Foto'"><div class="produto-info"><h3 class="produto-titulo">${p.nome}</h3><p class="produto-descricao">${p.descricao || ''}</p><div class="produto-footer"><div class="produto-preco">${precoHtml}</div><button class="btn-add">${pode ? '+' : 'üîí'}</button></div></div>`;
            return div;
        }

        // --- CARRINHO LOGIC (COM PRE√áO NORMAL vs PROMO + DETALHES) ---
        window.abrirModalProduto = (p) => {
            const pode = configLoja.lojaAberta || p.sobEncomenda;
            if(!pode) return mostrarNotificacao('Loja fechada no momento.', 'erro');
            prodSel = p; qtdSel = 1;
            
            document.getElementById('md-titulo').textContent = p.nome;
            // Se houver descri√ß√£o, mostra. Se n√£o, limpa.
            document.getElementById('md-desc').textContent = p.descricao || '';
            
            // L√ìGICA DE EXIBI√á√ÉO DE DETALHES (INGREDIENTES)
            const boxDetalhes = document.getElementById('md-detalhes-container');
            const txtDetalhes = document.getElementById('md-detalhes');
            if (p.detalhes && p.detalhes.trim() !== "") {
                txtDetalhes.textContent = p.detalhes;
                boxDetalhes.classList.remove('hidden');
            } else {
                boxDetalhes.classList.add('hidden');
            }

            document.getElementById('md-img').src = p.imagemUrl;
            document.getElementById('md-qtd').textContent = 1;
            document.getElementById('md-obs').value = '';
            
            if(p.sobEncomenda) { document.getElementById('md-encomenda-opt').classList.remove('hidden'); document.getElementById('md-check-enc').checked = false; document.getElementById('md-agendamento').classList.add('hidden'); } else { document.getElementById('md-encomenda-opt').classList.add('hidden'); }
            
            atualizarPrecoModal(); 
            document.getElementById('modal-produto').classList.add('active');
        };
        window.mudarQtd = (v) => { if(qtdSel + v >= 1) { qtdSel += v; document.getElementById('md-qtd').textContent = qtdSel; atualizarPrecoModal(); } };
        function atualizarPrecoModal() {
            const preco = (prodSel.emPromocao && prodSel.precoPromocional) ? prodSel.precoPromocional : prodSel.preco;
            document.getElementById('md-preco').textContent = formatarPreco(preco * qtdSel);
        }
        window.toggleAgendamento = (chk) => { if(chk.checked) { document.getElementById('md-agendamento').classList.remove('hidden'); const d = new Date(); d.setDate(d.getDate()+1); document.getElementById('md-data').min = d.toISOString().split('T')[0]; } else { document.getElementById('md-agendamento').classList.add('hidden'); } }

        window.addCarrinho = () => {
            const isAgendado = document.getElementById('md-check-enc').checked;
            let agendamento = null;
            if(isAgendado) { const data = document.getElementById('md-data').value; const hora = document.getElementById('md-hora').value; if(!data || !hora) return mostrarNotificacao('Informe data e hora!', 'erro'); agendamento = { data, hora }; }
            
            const precoNormal = prodSel.preco;
            const precoFinal = (prodSel.emPromocao && prodSel.precoPromocional) ? prodSel.precoPromocional : prodSel.preco;

            // Salva qtd (novo padr√£o)
            carrinho.push({ 
                id: prodSel.id, 
                nome: prodSel.nome, 
                preco: precoFinal, 
                precoNormal: precoNormal, 
                qtd: qtdSel, 
                obs: document.getElementById('md-obs').value, 
                sobEncomenda: prodSel.sobEncomenda || false, 
                agendamento: agendamento 
            });
            salvarCarrinho(); fecharModal('modal-produto'); mostrarNotificacao('Adicionado!', 'sucesso');
        };

        function salvarCarrinho() { localStorage.setItem('carrinho', JSON.stringify(carrinho)); atualizarCarrinhoUI(); }

        function atualizarCarrinhoUI() {
            // CORRE√á√ÉO: Fallback para 'qtd' ou 'quantidade'
            const subtotalNormal = carrinho.reduce((a,b) => a + (b.precoNormal * (b.qtd || b.quantidade || 1)), 0);
            const totalReal = carrinho.reduce((a,b) => a + (b.preco * (b.qtd || b.quantidade || 1)), 0);
            const desconto = subtotalNormal - totalReal;

            // Desktop UI
            const dskList = document.getElementById('lista-carrinho-desktop');
            const dskFooter = document.getElementById('footer-carrinho-desktop');
            if(dskList) {
                dskList.innerHTML = '';
                if(carrinho.length === 0) { dskList.innerHTML = '<p style="text-align:center;color:#9ca3af;padding:20px;">Carrinho vazio üò¢</p>'; dskFooter.classList.add('hidden'); }
                else {
                    dskFooter.classList.remove('hidden');
                    document.getElementById('dsk-subtotal').textContent = formatarPreco(subtotalNormal);
                    document.getElementById('total-carrinho-desktop').textContent = formatarPreco(totalReal);
                    
                    if(desconto > 0) {
                        document.getElementById('dsk-box-desc').classList.remove('hidden');
                        document.getElementById('dsk-desconto').textContent = `- ${formatarPreco(desconto)}`;
                    } else {
                        document.getElementById('dsk-box-desc').classList.add('hidden');
                    }

                    carrinho.forEach((item, idx) => {
                        let enc = item.sobEncomenda ? '<small style="color:#2563eb;">(Enc)</small>' : '';
                        const q = item.qtd || item.quantidade || 1;
                        dskList.innerHTML += `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f3f4f6;"><div style="flex:1"><div style="font-weight:600;color:#374151;">${q}x ${item.nome} ${enc}</div><div style="font-size:0.85rem;color:#6b7280;">${formatarPreco(item.preco * q)}</div></div><button onclick="window.removeItem(${idx})" style="color:#ef4444;border:none;background:none;cursor:pointer;">√ó</button></div>`;
                    });
                }
            }
            // Mobile
            const btn = document.getElementById('btn-carrinho');
            if(carrinho.length > 0) { btn.classList.remove('hidden'); document.getElementById('float-total').textContent = formatarPreco(totalReal); } else { btn.classList.add('hidden'); }
            const mobList = document.getElementById('lista-carrinho'); mobList.innerHTML = '';
            if(carrinho.length === 0) mobList.innerHTML = '<p style="text-align:center;color:#999;">Vazio.</p>';
            carrinho.forEach((item, idx) => { 
                const q = item.qtd || item.quantidade || 1;
                mobList.innerHTML += `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee;"><div><strong>${q}x ${item.nome}</strong><br>${formatarPreco(item.preco * q)}</div><button onclick="window.removeItem(${idx})" style="color:red;border:none;background:none;">üóëÔ∏è</button></div>`; 
            });
        }
        window.removeItem = (idx) => { carrinho.splice(idx, 1); salvarCarrinho(); };
        window.irParaCheckout = () => { if(carrinho.length === 0) return; fecharModal('modal-carrinho'); trocarTela('checkout'); atualizarResumoCheckout(); };

        // --- CHECKOUT & FINALIZAR ---
        window.mudarEntrega = (t) => { tipoEntrega = t; document.getElementById('opt-entrega').className = `entrega-option ${t==='entrega'?'selected':''}`; document.getElementById('opt-retirada').className = `entrega-option ${t==='retirada'?'selected':''}`; if(t==='entrega') { document.getElementById('box-endereco').classList.remove('hidden'); document.getElementById('box-retirada').classList.add('hidden'); } else { document.getElementById('box-endereco').classList.add('hidden'); document.getElementById('box-retirada').classList.remove('hidden'); } atualizarResumoCheckout(); };
        window.selPag = (t, el) => { pagSel = t; document.querySelectorAll('.pagamento-option').forEach(e => e.classList.remove('selected')); el.classList.add('selected'); document.getElementById('box-pix').classList.add('hidden'); document.getElementById('box-dinheiro').classList.add('hidden'); if(t==='pix') { document.getElementById('box-pix').classList.remove('hidden'); atualizarResumoCheckout(); } else if(t==='dinheiro') { document.getElementById('box-dinheiro').classList.remove('hidden'); } };

        function atualizarResumoCheckout() {
            const subtotalNormal = carrinho.reduce((a,b) => a + (b.precoNormal * (b.qtd || b.quantidade || 1)), 0);
            const totalReal = carrinho.reduce((a,b) => a + (b.preco * (b.qtd || b.quantidade || 1)), 0);
            const desconto = subtotalNormal - totalReal;
            const taxa = tipoEntrega === 'entrega' ? (configLoja.taxaEntrega || 0) : 0;
            const totalFinal = totalReal + taxa;

            document.getElementById('lista-resumo-checkout').innerHTML = carrinho.map(i => {
                const q = i.qtd || i.quantidade || 1;
                return `<div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.9rem;"><span>${q}x ${i.nome}</span> <span>${formatarPreco(i.preco*q)}</span></div>`;
            }).join('');
            
            document.getElementById('chk-subtotal').textContent = formatarPreco(subtotalNormal);
            document.getElementById('chk-entrega').textContent = taxa === 0 ? 'Gr√°tis' : formatarPreco(taxa);
            document.getElementById('chk-total').textContent = formatarPreco(totalFinal);

            if(desconto > 0) {
                document.getElementById('chk-box-desc').classList.remove('hidden');
                document.getElementById('chk-desconto').textContent = `- ${formatarPreco(desconto)}`;
            } else {
                document.getElementById('chk-box-desc').classList.add('hidden');
            }

            const temEnc = carrinho.some(i => i.sobEncomenda);
            if(temEnc) {
                document.getElementById('alert-sinal').classList.remove('hidden'); document.getElementById('resumo-sinal').classList.remove('hidden'); document.getElementById('lbl-total').textContent = 'Total Geral';
                const sinal = totalFinal / 2;
                document.getElementById('chk-sinal').textContent = formatarPreco(sinal);
                document.getElementById('chk-restante').textContent = formatarPreco(totalFinal - sinal);
                if(pagSel === 'pix') gerarPix(sinal);
            } else {
                document.getElementById('alert-sinal').classList.add('hidden'); document.getElementById('resumo-sinal').classList.add('hidden'); document.getElementById('lbl-total').textContent = 'Total a Pagar';
                if(pagSel === 'pix') gerarPix(totalFinal);
            }
        }

        window.finalizarPedido = async () => {
            if(carrinho.length === 0) return;
            if(!document.getElementById('nome-cliente').value || !document.getElementById('tel-cliente').value) return mostrarNotificacao('Preencha seus dados!', 'erro');
            if(!pagSel) return mostrarNotificacao('Selecione pagamento!', 'erro');
            if(tipoEntrega === 'entrega' && !document.getElementById('endereco').value) return mostrarNotificacao('Endere√ßo incompleto!', 'erro');

            const total = carrinho.reduce((a,b) => a + (b.preco * (b.qtd || b.quantidade || 1)), 0) + (tipoEntrega==='entrega'?(configLoja.taxaEntrega||0):0);
            const enc = carrinho.some(i=>i.sobEncomenda);
            
            // Salvar Endere√ßo no Cache
            const dadosSalvar = {
                nome: document.getElementById('nome-cliente').value,
                tel: document.getElementById('tel-cliente').value,
                cep: document.getElementById('cep').value,
                logradouro: document.getElementById('endereco').value,
                numero: document.getElementById('numero').value,
                bairro: document.getElementById('bairro').value,
                cidade: document.getElementById('cidade').value,
                complemento: document.getElementById('complemento').value
            };
            localStorage.setItem('ultimo_endereco', JSON.stringify(dadosSalvar));

            const pedido = {
                idDisplay: '#'+Math.floor(1000+Math.random()*9000),
                cliente: { nome: dadosSalvar.nome, telefone: dadosSalvar.tel },
                tipoEntrega,
                endereco: tipoEntrega==='entrega' ? dadosSalvar : null,
                itens: carrinho, total: total, isEncomenda: enc, valorSinal: enc?total/2:total, valorRestante: enc?total/2:0, saldoDevedor: enc,
                pagamento: { forma: pagSel, troco: document.getElementById('troco').value, status: enc?'parcial_sinal':'pendente' },
                status: 'recebido', criadoEm: new Date(), atualizadoEm: new Date()
            };

            try {
                const ref = await addDoc(collection(db, COLLECTIONS.PEDIDOS), pedido);
                let meus = JSON.parse(localStorage.getItem('meus_pedidos_ids'))||[]; meus.push(ref.id); localStorage.setItem('meus_pedidos_ids', JSON.stringify(meus));
                localStorage.removeItem('carrinho'); carrinho = [];
                
                enviarWhatsApp(pedido); // Envia para o whats
                
                mostrarNotificacao('Pedido enviado!', 'sucesso');
                setTimeout(() => window.location.reload(), 2000);
            } catch(e) { console.error(e); mostrarNotificacao('Erro ao enviar', 'erro'); }
        };

        function enviarWhatsApp(p) {
            let msg = `*NOVO PEDIDO ${p.idDisplay}*\n`;
            msg += `üë§ ${p.cliente.nome}\n`;
            msg += `üì¶ *Tipo:* ${p.tipoEntrega === 'entrega' ? 'üõµ Entrega' : 'üè™ Retirada'}\n\n`;

            p.itens.forEach(i => {
                const q = i.qtd || i.quantidade || 1;
                msg += `‚ñ™Ô∏è ${q}x ${i.nome}`;
                if(i.sobEncomenda) msg += ` (Enc)`;
                msg += `\n`;
                if(i.obs) msg += `   _Obs: ${i.obs}_\n`;
                if(i.agendamento) msg += `   üìÖ *Agendado:* ${new Date(i.agendamento.data+'T00:00:00').toLocaleDateString()} √†s ${i.agendamento.hora}\n`;
            });

            msg += `\nüí∞ *Total:* ${formatarPreco(p.total)}`;
            if(p.isEncomenda) {
                msg += `\nüîµ *Sinal:* ${formatarPreco(p.valorSinal)}`;
                msg += `\nüî¥ *Restante:* ${formatarPreco(p.valorRestante)}`;
            }

            msg += `\nüí≥ *Pagamento:* ${p.pagamento.forma.toUpperCase()}`;
            if(p.pagamento.troco) msg += ` (Troco p/ ${p.pagamento.troco})`;

            if(p.tipoEntrega === 'entrega' && p.endereco) {
                msg += `\n\nüìç *Endere√ßo:*\n${p.endereco.logradouro}, ${p.endereco.numero}\n${p.endereco.bairro}`;
                if(p.endereco.complemento) msg += `\nComp: ${p.endereco.complemento}`;
            }

            const tel = configLoja.whatsapp ? configLoja.whatsapp.replace(/\D/g, '') : '';
            if(tel) {
                window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`, '_blank');
            }
        }

        // --- RASTREIO TEMPO REAL (CORRIGIDO) ---
        window.abrirRastreio = async () => {
            document.getElementById('modal-rastreio').classList.add('active');
            const lista = document.getElementById('lista-pedidos-rastreio');
            const ids = JSON.parse(localStorage.getItem('meus_pedidos_ids')) || [];

            // Limpa listeners antigos para n√£o duplicar conex√µes e mem√≥ria
            rastreioListeners.forEach(unsub => unsub());
            rastreioListeners = [];

            if (ids.length === 0) {
                lista.innerHTML = '<p style="text-align:center;padding:20px;color:#999;">Sem pedidos recentes.</p>';
                return;
            }

            // Limpa a lista antes de come√ßar a adicionar os itens
            lista.innerHTML = '';

            // Pega os 5 √∫ltimos
            const ultimos = ids.slice(-5).reverse();

            ultimos.forEach(pid => {
                // Cria o elemento visual (placeholder)
                const div = document.createElement('div');
                div.id = `ped-${pid}`;
                div.style.marginBottom = '10px';
                // Feedback visual imediato enquanto o Firebase busca
                div.innerHTML = '<div style="padding:15px; border:1px solid #eee; border-radius:12px; text-align:center; color:#999;">Carregando status...</div>';
                
                lista.appendChild(div);

                // Conecta no Firebase
                const unsub = onSnapshot(doc(db, COLLECTIONS.PEDIDOS, pid), (docSnap) => {
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        const cor = d.status === 'entregue' ? '#10b981' : (d.status === 'recebido' ? '#3b82f6' : '#f59e0b');
                        const statusNome = d.status.replace('_', ' ').toUpperCase();

                        // Atualiza DIRETAMENTE a div criada (mais seguro)
                        div.innerHTML = `
                            <div style="background:#f9fafb; padding:15px; border-radius:12px; border:1px solid #eee; border-left: 5px solid ${cor};">
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                    <strong>Pedido ${d.idDisplay || '#'}</strong>
                                    <span style="color:${cor}; font-weight:800; font-size:0.8rem;">${statusNome}</span>
                                </div>
                                <div style="font-size:0.9rem; color:#666;">
                                    ${d.criadoEm ? d.criadoEm.toDate().toLocaleString() : ''} - ${formatarPreco(d.total)}
                                </div>
                            </div>
                        `;
                    } else {
                        // Se o pedido n√£o existir mais no banco
                        div.innerHTML = '<div style="padding:10px; color:red; text-align:center;">Pedido n√£o encontrado</div>';
                    }
                });
                
                rastreioListeners.push(unsub);
            });
        };

        window.trocarTela = (t) => { document.querySelectorAll('.view-section').forEach(s=>s.classList.remove('active')); document.getElementById('view-'+t).classList.add('active'); window.scrollTo(0,0); if(t==='cardapio') atualizarCarrinhoUI(); };
        window.scrollCat = (e, id) => { e.preventDefault(); document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); const el = document.getElementById(id); if(el) window.scrollTo({top: el.offsetTop-130, behavior:'smooth'}); };
        window.abrirModalCarrinho = () => document.getElementById('modal-carrinho').classList.add('active');
        window.fecharModal = (id) => document.getElementById(id).classList.remove('active');
        window.buscarCep = async (cep) => { if(validarCEP(cep)) { const end = await buscarEnderecoPorCEP(cep); if(end) { document.getElementById('endereco').value = end.logradouro; document.getElementById('bairro').value = end.bairro; document.getElementById('cidade').value = end.cidade; document.getElementById('numero').focus(); } } }
        let pixPayload = ''; function gerarPix(v) { if(!configLoja.chavePix || v<=0) return; const p = gerarPayloadPixString(configLoja.chavePix, configLoja.nomeBeneficiario||'Loja', configLoja.cidadeBeneficiario||'Cidade', v.toFixed(2)); pixPayload = p; new QRious({ element: document.getElementById('qr-code'), value: p, size: 150 }); document.getElementById('pix-code-text').textContent = p; }
        window.copiarPix = () => { navigator.clipboard.writeText(pixPayload); mostrarNotificacao('Copiado!', 'sucesso'); };
        function gerarPayloadPixString(chave, nome, cidade, valor) { const n=nome.substring(0,25).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase(); const c=cidade.substring(0,15).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase(); const p=["000201","26",(("0014BR.GOV.BCB.PIX01"+chave.length.toString().padStart(2,'0')+chave).length).toString().padStart(2,'0'),"0014BR.GOV.BCB.PIX01"+chave.length.toString().padStart(2,'0')+chave,"52040000","5303986","54"+valor.length.toString().padStart(2,'0')+valor,"5802BR","59"+n.length.toString().padStart(2,'0')+n,"60"+c.length.toString().padStart(2,'0')+c,"62070503***","6304"].join(""); return p+crc16(p); }
        function crc16(p) { let c=0xFFFF; for(let i=0;i<p.length;i++){ c^=p.charCodeAt(i)<<8; for(let j=0;j<8;j++) if((c&0x8000)!==0) c=(c<<1)^0x1021; else c=c<<1; } return (c&0xFFFF).toString(16).toUpperCase().padStart(4,"0"); }
    </script>
</body>
</html>

### 2. Corre√ß√£o do `admin.html` (Painel)

Mesma coisa: ajuste os caminhos para serem relativos √† pasta atual.

Copie este c√≥digo e substitua no seu `admin.html`:

```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Login</title>
    
    <link href="[https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap](https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap)" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./admin.css">
    
    <style>
        /* --- ESTILOS GERAIS --- */
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }

        /* --- TELA DE LOGIN --- */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f3f4f6; z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
        }
        .login-card {
            background: white; padding: 2.5rem; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
            text-align: center;
        }
        .login-logo {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            margin: 0 auto 1.5rem; border: 3px solid #e5e7eb; display: block;
            background: #eee;
        }
        .login-title { font-family: 'Poppins', sans-serif; font-size: 1.5rem; color: #1f2937; margin-bottom: 2rem; }
        
        /* --- DASHBOARD & OUTROS --- */
        .card-faturamento { background: #f0fdf4; border: 2px solid #bbf7d0; transform: scale(1.02); transition: 0.3s; }
        .card-faturamento:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(22, 163, 74, 0.2); }
        .valor-gigante { font-size: 3.5rem; font-weight: 800; color: #16a34a; letter-spacing: -1px; margin: 10px 0; line-height: 1; }
        .valor-normal { font-size: 2.5rem; font-weight: 700; color: #1f2937; }
        .titulo-card { font-size: 1.1rem; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .icon-destaque { font-size: 3rem; background: white; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* --- PEDIDOS --- */
        .pedido-card { background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #ccc; transition: all 0.3s ease; cursor: pointer; position: relative; z-index: 1; }
        
        /* Z-INDEX ALTO QUANDO ATIVO */
        .pedido-card.z-index-alto { z-index: 100 !important; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(1.01); }
        
        .pedido-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .pedido-card.entregue { opacity: 0.6; border-left-color: #10b981; }
        .pedido-card.recebido { border-left-color: #3b82f6; }
        .pedido-card.em_preparo { border-left-color: #f59e0b; }
        .pedido-card.saiu_entrega { border-left-color: #8b5cf6; }
        .pedido-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .pedido-id { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
        .pedido-status { padding: 0.375rem 0.875rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600; display: inline-block; }
        .status-recebido { background: #dbeafe; color: #1e40af; }
        .status-em_preparo { background: #fef3c7; color: #92400e; }
        .status-saiu_entrega { background: #ede9fe; color: #5b21b6; }
        .status-entregue { background: #d1fae5; color: #065f46; }
        .pedido-info { display: grid; gap: 0.5rem; margin: 1rem 0; }
        .pedido-info p { margin: 0; color: #6b7280; font-size: 0.95rem; }
        .pedido-itens { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .pedido-item { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.9rem; }
        .pedido-total { margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .pedido-total-valor { font-size: 1.5rem; font-weight: 700; color: #FF6B35; }
        .status-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-top: 0.5rem; padding: 0.5rem; z-index: 1000; display: none; }
        .status-dropdown.active { display: block; animation: slideDown 0.2s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-option { padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .status-option:hover { background: #f3f4f6; }
        .status-option.current { background: #e0e7ff; font-weight: 600; }
        .toggle-entregues { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6b7280; margin-bottom: 1.5rem; }
        .toggle-entregues.active { background: #FF6B35; color: white; border-color: #FF6B35; }
        .contador-badge { background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.625rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
        .toggle-entregues.active .contador-badge { background: rgba(255,255,255,0.2); color: white; }
        .filtros-status { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .filtro-btn { padding: 0.625rem 1.25rem; border: 2px solid #e5e7eb; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .filtro-btn.active { background: #FF6B35; color: white; border-color: #FF6B35; }
        .btn-excluir { background: none; border: none; cursor: pointer; font-size: 1.1rem; opacity: 0.4; }
        .btn-excluir:hover { opacity: 1; transform: scale(1.1); }
        .alerta-cobranca { background: #fff7ed; color: #c2410c; padding: 8px; font-size: 0.9rem; border-radius: 6px; margin-top: 10px; font-weight: bold; border: 1px dashed #f97316; display: flex; align-items: center; gap: 5px; }

        /* --- PRODUTOS & CONFIG --- */
        .badge-cat { background: #f3f4f6; color: #374151; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-right: 5px; }
        .badge-promo { background: #fee2e2; color: #991b1b; }
        .badge-encomenda { background: #dbeafe; color: #1e40af; }
        .check-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; }
        .check-group input { width: 20px; height: 20px; cursor: pointer; }
        .check-group label { cursor: pointer; font-weight: 500; flex: 1; margin: 0; }
        .preco-riscado { text-decoration: line-through; color: #9ca3af; font-size: 0.9rem; margin-right: 5px; }
        .preco-destaque { color: #dc2626; font-weight: 700; }
        .header-actions { display: flex; gap: 10px; }
        .switch-container { display: flex; align-items: center; gap: 1rem; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 2rem; border: 1px solid #e5e7eb; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
        .status-texto { font-weight: 700; font-size: 1.2rem; }
        .loja-aberta { color: #10b981; }
        .loja-fechada { color: #ef4444; }
        .logo-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #e5e7eb; margin-top: 1rem; background: #f9fafb; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; }
        .form-textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; resize: vertical; font-family: inherit; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primario { background-color: #2563eb; color: white; width: 100%; }
        .btn-primario:hover { background-color: #1d4ed8; }

        /* --- TOAST --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
        .toast { padding: 12px 24px; border-radius: 8px; color: white; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; }
        .toast-sucesso { background-color: #10b981; }
        .toast-erro { background-color: #ef4444; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <img id="login-logo-img" src="" class="login-logo hidden" onerror="this.src='[https://placehold.co/100?text=Logo](https://placehold.co/100?text=Logo)'">
            <h2 id="login-nome-loja" class="login-title">√Årea Administrativa</h2>
            
            <form id="form-login">
                <div class="form-group">
                    <input type="email" id="email-login" class="form-input" placeholder="E-mail" required>
                </div>
                <div class="form-group">
                    <input type="password" id="senha-login" class="form-input" placeholder="Senha" required>
                </div>
                <button type="submit" class="btn btn-primario" id="btn-login">Entrar no Painel</button>
            </form>
            <p id="erro-login" style="color: red; margin-top: 10px; font-size: 0.9rem; display: none;"></p>
        </div>
        <p style="margin-top: 2rem; color: #9ca3af; font-size: 0.8rem;">Sistema SaaS Seguro v1.0</p>
    </div>

    <div class="admin-layout hidden" id="admin-layout">
        
        <button class="toggle-sidebar" id="toggle-sidebar">‚ò∞</button>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo" style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                <img id="admin-logo-img" src="" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; display: none;" onerror="this.style.display='none'; document.getElementById('admin-logo-text').style.display='block';">
                <div id="admin-logo-text" style="font-size: 3rem;">‚ü≥</div>
                <h2 id="nome-loja-sidebar">Carregando...</h2>
            </div>
            <nav>
                <ul class="sidebar-menu">
                    <li><a href="#" onclick="window.navegar('dashboard', this)" class="menu-link active"><span class="icon">üìä</span><span>Dashboard</span></a></li>
                    <li><a href="#" onclick="window.navegar('produtos', this)" class="menu-link"><span class="icon">üçî</span><span>Produtos</span></a></li>
                    <li><a href="#" onclick="window.navegar('pedidos', this)" class="menu-link"><span class="icon">üì¶</span><span>Pedidos</span></a></li>
                    <li><a href="#" onclick="window.navegar('configuracoes', this)" class="menu-link"><span class="icon">‚öôÔ∏è</span><span>Configura√ß√µes</span></a></li>
                    <li style="margin-top: 1rem; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                        <a href="#" onclick="window.fazerLogout()" class="menu-link" style="color: #ef4444;"><span class="icon">üö™</span><span>Sair</span></a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="admin-content">

            <section id="view-dashboard" class="view-section active">
                <div class="admin-header">
                    <div>
                        <h1>üìä Vis√£o Geral</h1>
                        <p style="color: var(--cor-texto-secundario);">Resumo financeiro de <strong id="data-hoje">hoje</strong></p>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card card-faturamento">
                        <div>
                            <span class="titulo-card">Faturamento Hoje</span>
                            <div class="valor-gigante" id="vendas-hoje">R$ 0,00</div>
                            <small style="color: #15803d; font-weight: 600;">üí∞ Sinais + Entregas</small>
                        </div>
                        <div class="icon-destaque">üíµ</div>
                    </div>
                    <div class="stat-card">
                        <div>
                            <span class="titulo-card">Pedidos Novos</span>
                            <div class="valor-normal" id="pedidos-hoje">0</div>
                            <small>Criados hoje</small>
                        </div>
                        <div class="icon-destaque" style="color: #059669;">üì¶</div>
                    </div>
                    <div class="stat-card">
                        <div>
                            <span class="titulo-card">Fila Pendente</span>
                            <div class="valor-normal" style="color: #ea580c;" id="pedidos-pendentes">0</div>
                            <small>Para produzir/entregar</small>
                        </div>
                        <div class="icon-destaque">‚è≥</div>
                    </div>
                </div>

                <div style="margin-top: 3rem;">
                    <h3 style="margin-bottom: 1rem;">√öltimas Vendas</h3>
                    <div style="background: white; border-radius: 16px; padding: 1.5rem; overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                            <thead>
                                <tr style="text-align: left; color: #6b7280; border-bottom: 2px solid #f3f4f6;">
                                    <th style="padding: 1rem;">ID</th>
                                    <th style="padding: 1rem;">Cliente</th>
                                    <th style="padding: 1rem;">Status</th>
                                    <th style="padding: 1rem;">Financeiro</th>
                                    <th style="padding: 1rem;">Hora</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-ultimos-pedidos">
                                <tr><td colspan="5" style="text-align:center; padding: 3rem; color: #9ca3af;">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-produtos" class="view-section">
                <div class="admin-header">
                    <h1>üçî Gerenciar Produtos</h1>
                    <div class="header-actions">
                        <button class="btn btn-outline" id="btn-nova-categoria">üè∑Ô∏è Categoria</button>
                        <button class="btn btn-primario" id="btn-novo-produto">‚ûï Produto</button>
                    </div>
                </div>
                <div id="loading-produtos" class="flex-center" style="padding: 3rem;"><div class="loading"></div></div>
                <div class="produtos-admin-grid" id="produtos-container"></div>
            </section>

            <section id="view-pedidos" class="view-section">
                <div class="admin-header">
                    <h1>üì¶ Gest√£o de Pedidos</h1>
                </div>
                <div style="margin-bottom: 2rem;">
                    <button class="toggle-entregues" id="btn-toggle-entregues">
                        <span id="toggle-icon">üëÅÔ∏è</span> <span id="toggle-text">Mostrar Entregues</span> <span class="contador-badge" id="contador-entregues">0</span>
                    </button>
                    <div class="filtros-status">
                        <button class="filtro-btn active" data-filtro="todos">Todos <span class="contador-badge" id="count-todos">0</span></button>
                        <button class="filtro-btn" data-filtro="recebido">Recebido <span class="contador-badge" id="count-recebido">0</span></button>
                        <button class="filtro-btn" data-filtro="em_preparo">Preparo <span class="contador-badge" id="count-em_preparo">0</span></button>
                        <button class="filtro-btn" data-filtro="saiu_entrega">Saiu <span class="contador-badge" id="count-saiu_entrega">0</span></button>
                    </div>
                </div>
                <div id="loading-pedidos" class="flex-center" style="padding: 3rem;"><div class="loading"></div></div>
                <div id="sem-pedidos" class="text-center hidden" style="padding: 3rem;"><h3>Nenhum pedido ativo</h3></div>
                <div id="lista-pedidos"></div>
            </section>

            <section id="view-configuracoes" class="view-section">
                <div class="admin-header"><h1>‚öôÔ∏è Configura√ß√µes</h1></div>
                <div class="switch-container">
                    <label class="switch"><input type="checkbox" id="switch-loja"><span class="slider"></span></label>
                    <div><div id="texto-status" class="status-texto loja-fechada">LOJA FECHADA</div><small>Define se recebe pedidos ou apenas encomendas.</small></div>
                </div>
                <form id="form-config" style="background: white; padding: 2rem; border-radius: 16px;">
                    <h3>üè† Dados do Restaurante</h3>
                    <div class="form-group"><label>Nome</label><input type="text" id="nome-loja" class="form-input"></div>
                    <div class="form-group"><label>Logo URL</label><input type="url" id="logo-url" class="form-input"><img id="preview-logo" src="" class="logo-preview hidden"></div>
                    <div class="form-group"><label>Slogan</label><input type="text" id="slogan-loja" class="form-input"></div>
                    <h3>üõµ Entrega / Pix</h3>
                    <div class="form-group"><label>Taxa Entrega</label><input type="number" id="taxa-entrega" class="form-input" step="0.01"></div>
                    <div class="form-group"><label>Tempo M√©dio</label><input type="text" id="tempo-entrega" class="form-input"></div>
                    <div class="form-group"><label>Chave Pix</label><input type="text" id="chave-pix" class="form-input"></div>
                    <div class="form-group"><label>Whatsapp</label><input type="text" id="whatsapp-loja" class="form-input"></div>
                    <button type="submit" class="btn btn-primario" id="btn-salvar">üíæ Salvar Configura√ß√µes</button>
                </form>
            </section>

        </main>
    </div>

    <div class="modal-overlay" id="modal-produto">
        <div class="modal">
            <div class="modal-header"><h2>Produto</h2><button class="modal-close" onclick="window.fecharModal('modal-produto')">√ó</button></div>
            <form id="form-produto">
                <div class="form-group"><label>Categoria</label><select id="cat-prod" class="form-input" required></select></div>
                <div class="form-group"><label>Imagem URL</label><input type="url" id="img-prod" class="form-input" required></div>
                <div class="form-group"><label>Nome</label><input type="text" id="nome-prod" class="form-input" required></div>
                <div class="form-group"><label>Pre√ßo</label><input type="number" id="preco-prod" class="form-input" step="0.01" required></div>
                
                <div class="form-group">
                    <label>Ingredientes / Detalhes</label>
                    <textarea id="detalhes-prod" class="form-textarea" rows="3" placeholder="Ex: P√£o brioche, blend 180g, queijo cheddar, bacon..."></textarea>
                </div>

                <div class="check-group"><input type="checkbox" id="check-promo"><label>Promo√ß√£o</label></div>
                <div class="form-group hidden" id="box-promo"><input type="number" id="preco-promo" class="form-input" placeholder="Pre√ßo Promo"></div>
                <div class="check-group"><input type="checkbox" id="check-encomenda"><label>Sob Encomenda</label></div>
                <button type="submit" class="btn btn-primario">Salvar</button>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal-categoria">
        <div class="modal">
            <div class="modal-header"><h2>Categoria</h2><button class="modal-close" onclick="window.fecharModal('modal-categoria')">√ó</button></div>
            <form id="form-categoria"><div class="form-group"><input type="text" id="nome-cat" class="form-input" placeholder="Nome da Categoria"></div><button type="submit" class="btn btn-primario">Criar</button></form>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        // CORRE√á√ÉO 2: Caminho JS simplificado
        import { db, auth, collection, getDocs, doc, updateDoc, setDoc, addDoc, deleteDoc, onSnapshot, query, orderBy, formatarPreco, COLLECTIONS } from './firebase-config.js';
        import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "[https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js](https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js)";

        // --- SISTEMA DE LOGIN & AUTH ---
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-layout').classList.remove('hidden');
                inicializarSistema();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-layout').classList.add('hidden');
                tentarCarregarLogoLogin(); 
            }
        });

        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email-login').value;
            const senha = document.getElementById('senha-login').value;
            const btn = document.getElementById('btn-login');
            const msgErro = document.getElementById('erro-login');

            btn.disabled = true; btn.textContent = "Entrando...";
            msgErro.style.display = 'none';

            try {
                await signInWithEmailAndPassword(auth, email, senha);
            } catch (error) {
                console.error(error);
                btn.disabled = false; btn.textContent = "Entrar no Painel";
                msgErro.textContent = "E-mail ou senha incorretos.";
                msgErro.style.display = 'block';
            }
        });

        window.fazerLogout = async () => {
            try { await signOut(auth); window.location.reload(); } catch(e) { console.error(e); }
        };

        async function tentarCarregarLogoLogin() {
            try {
                const snap = await getDocs(collection(db, COLLECTIONS.CONFIGURACOES));
                if(!snap.empty) {
                    const d = snap.docs[0].data();
                    if(d.logoUrl) {
                        const img = document.getElementById('login-logo-img');
                        img.src = d.logoUrl; img.classList.remove('hidden');
                    }
                    if(d.nome) document.getElementById('login-nome-loja').textContent = d.nome;
                }
            } catch(e) {
                console.log("Aguardando login para carregar dados da loja.");
            }
        }


        // --- RESTO DO SISTEMA (S√≥ roda se logado) ---
        
        function inicializarSistema() {
            initDashboard();
            initConfig();
            initPedidos();
            initProdutos();
        }

        window.mostrarNotificacao = (msg, tipo) => {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = `toast toast-${tipo}`; div.textContent = msg;
            container.appendChild(div); setTimeout(() => div.remove(), 3000);
        };
        
        window.navegar = (tela, el) => {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
            document.getElementById('view-' + tela).classList.add('active');
            if(el) el.classList.add('active');
            if(tela === 'produtos' && produtosLista.length === 0) carregarProdutos();
        };

        // --- DASHBOARD ---
        function initDashboard() {
            document.getElementById('data-hoje').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
            
            getDocs(collection(db, COLLECTIONS.CONFIGURACOES)).then(snap => {
                if(!snap.empty) {
                    const d = snap.docs[0].data();
                    if(d.nome) document.getElementById('nome-loja-sidebar').textContent = d.nome;
                    if(d.logoUrl) {
                        const img = document.getElementById('admin-logo-img');
                        img.src = d.logoUrl; img.style.display = 'block';
                        document.getElementById('admin-logo-text').style.display = 'none';
                    }
                }
            });

            onSnapshot(query(collection(db, COLLECTIONS.PEDIDOS)), (snapshot) => {
                let fat = 0, qtd = 0, pend = 0, lista = [];
                const hojeStr = new Date().toDateString();

                snapshot.forEach(doc => {
                    const p = { id: doc.id, ...doc.data() };
                    const dCria = p.criadoEm?.toDate ? p.criadoEm.toDate() : null;
                    const dEntr = p.dataEntregaRealizada?.toDate ? p.dataEntregaRealizada.toDate() : null;
                    
                    if (dCria && dCria.toDateString() === hojeStr) {
                        qtd++; lista.push(p);
                        fat += p.isEncomenda ? (p.valorSinal || 0) : (p.total || 0);
                    }
                    if (['recebido', 'em_preparo', 'saiu_entrega'].includes(p.status)) pend++;
                    if (p.isEncomenda && dEntr && dEntr.toDateString() === hojeStr && p.status === 'entregue') fat += (p.valorRestante || 0);
                });

                document.getElementById('vendas-hoje').textContent = formatarPreco(fat);
                document.getElementById('pedidos-hoje').textContent = qtd;
                document.getElementById('pedidos-pendentes').textContent = pend;

                lista.sort((a, b) => b.criadoEm - a.criadoEm);
                let html = '';
                lista.slice(0, 5).forEach(p => {
                    const stColor = p.status === 'entregue' ? '#10b981' : '#f59e0b';
                    html += `<tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding:1rem;">${p.idDisplay || p.id}</td>
                        <td>${p.cliente?.nome || '-'}</td>
                        <td style="color:${stColor}; font-weight:600;">${p.status}</td>
                        <td>${p.isEncomenda ? 'Sinal 50%' : 'Total'}</td>
                        <td style="color:#666;">${p.criadoEm.toDate().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</td>
                    </tr>`;
                });
                document.getElementById('tabela-ultimos-pedidos').innerHTML = html || '<tr><td colspan="5" style="text-align:center;padding:2rem;">Nada hoje.</td></tr>';
            });
        }

        // --- CONFIGURA√á√ïES ---
        let configId = null;
        async function initConfig() {
            const switchLoja = document.getElementById('switch-loja');
            document.getElementById('logo-url').addEventListener('input', (e) => {
                const img = document.getElementById('preview-logo');
                if(e.target.value) { img.src = e.target.value; img.classList.remove('hidden'); }
                else img.classList.add('hidden');
            });
            switchLoja.addEventListener('change', (e) => {
                const txt = document.getElementById('texto-status');
                if(e.target.checked) { txt.textContent = "LOJA ABERTA"; txt.className = "status-texto loja-aberta"; }
                else { txt.textContent = "LOJA FECHADA"; txt.className = "status-texto loja-fechada"; }
            });

            const snap = await getDocs(collection(db, COLLECTIONS.CONFIGURACOES));
            if (!snap.empty) {
                configId = snap.docs[0].id;
                const d = snap.docs[0].data();
                document.getElementById('nome-loja').value = d.nome || '';
                document.getElementById('logo-url').value = d.logoUrl || '';
                document.getElementById('slogan-loja').value = d.slogan || '';
                document.getElementById('taxa-entrega').value = d.taxaEntrega || '';
                document.getElementById('tempo-entrega').value = d.tempoEntrega || '';
                document.getElementById('chave-pix').value = d.chavePix || '';
                document.getElementById('whatsapp-loja').value = d.whatsapp || '';
                switchLoja.checked = d.lojaAberta === true;
                switchLoja.dispatchEvent(new Event('change'));
                if(d.logoUrl) { document.getElementById('preview-logo').src = d.logoUrl; document.getElementById('preview-logo').classList.remove('hidden'); }
            }

            document.getElementById('form-config').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-salvar'); btn.textContent = "Salvando..."; btn.disabled = true;
                const dados = {
                    nome: document.getElementById('nome-loja').value,
                    logoUrl: document.getElementById('logo-url').value,
                    slogan: document.getElementById('slogan-loja').value,
                    taxaEntrega: parseFloat(document.getElementById('taxa-entrega').value) || 0,
                    tempoEntrega: document.getElementById('tempo-entrega').value,
                    chavePix: document.getElementById('chave-pix').value,
                    whatsapp: document.getElementById('whatsapp-loja').value,
                    lojaAberta: switchLoja.checked
                };
                try {
                    await setDoc(doc(db, COLLECTIONS.CONFIGURACOES, configId || 'geral'), dados);
                    window.mostrarNotificacao("Salvo!", "sucesso");
                } catch(e) { window.mostrarNotificacao("Erro", "erro"); }
                finally { btn.textContent = "üíæ Salvar Configura√ß√µes"; btn.disabled = false; }
            });
        }

        // --- PEDIDOS ---
        let todosPedidos = [], mostrarEntregues = false, filtro = 'todos';
        function initPedidos() {
            onSnapshot(query(collection(db, COLLECTIONS.PEDIDOS)), (snap) => {
                todosPedidos = [];
                snap.forEach(d => todosPedidos.push({ uid: d.id, ...d.data() }));
                todosPedidos.sort((a,b) => b.criadoEm.toDate() - a.criadoEm.toDate());
                renderPedidos();
                document.getElementById('loading-pedidos').classList.add('hidden');
            });
            document.getElementById('btn-toggle-entregues').onclick = function() { mostrarEntregues = !mostrarEntregues; this.classList.toggle('active'); renderPedidos(); };
            document.querySelectorAll('.filtro-btn').forEach(b => b.onclick = function() { document.querySelectorAll('.filtro-btn').forEach(x=>x.classList.remove('active')); this.classList.add('active'); filtro = this.dataset.filtro; renderPedidos(); });
        }

        function renderPedidos() {
            const lista = document.getElementById('lista-pedidos'); lista.innerHTML = '';
            let filtrados = todosPedidos.filter(p => {
                if(!mostrarEntregues && p.status === 'entregue') return false;
                return filtro === 'todos' || p.status === filtro;
            });
            if(filtrados.length === 0) document.getElementById('sem-pedidos').classList.remove('hidden');
            else document.getElementById('sem-pedidos').classList.add('hidden');

            const icons = {recebido:'üîµ',em_preparo:'üü°',saiu_entrega:'üü£',entregue:'‚úÖ'};
            
            filtrados.forEach(p => {
                const card = document.createElement('div');
                card.className = `pedido-card ${p.status}`;
                card.id = `card-${p.uid}`; 
                
                const itens = p.itens?.map(i => {
                    const quantidade = i.qtd || i.quantidade || 1;
                    return `<div class="pedido-item">
                        <span>${quantidade}x ${i.nome}</span>
                        <span>${formatarPreco((i.preco||0) * quantidade)}</span>
                    </div>`;
                }).join('') || '';
                
                let enderecoTexto = 'Retirada no Balc√£o';
                if(p.tipoEntrega === 'entrega') {
                     if(p.endereco) {
                         const rua = p.endereco.logradouro || p.endereco.rua || 'Endere√ßo n/d';
                         const num = p.endereco.numero || 'S/N';
                         const bairro = p.endereco.bairro || '';
                         enderecoTexto = `${rua}, ${num} - ${bairro}`;
                     } else {
                         enderecoTexto = 'Endere√ßo n√£o informado';
                     }
                }

                card.innerHTML = `
                    <div class="pedido-header">
                        <div><strong>#${p.idDisplay||p.id}</strong> <button class="btn-excluir" onclick="window.delPed('${p.uid}')">üóëÔ∏è</button></div>
                        <span class="pedido-status status-${p.status}">${icons[p.status]||''} ${p.status}</span>
                    </div>
                    <div class="pedido-info">
                        <p>üë§ ${p.cliente?.nome}</p>
                        <p>üìç ${enderecoTexto}</p>
                    </div>
                    <div class="pedido-itens">${itens}</div>
                    <div class="pedido-total"><span>Total</span><span class="pedido-total-valor">${formatarPreco(p.total||0)}</span></div>
                    <div class="status-dropdown" id="dd-${p.uid}">
                        ${Object.keys(icons).map(k => `<div class="status-option" onclick="window.updSt('${p.uid}','${k}')">${icons[k]} ${k}</div>`).join('')}
                    </div>
                `;
                
                card.onclick = (e) => {
                    if(e.target.closest('.status-option') || e.target.closest('.btn-excluir')) return;
                    
                    const dropdown = document.getElementById(`dd-${p.uid}`);
                    const estaFechado = !dropdown.classList.contains('active');

                    document.querySelectorAll('.pedido-card').forEach(c => {
                        c.classList.remove('z-index-alto');
                        const dd = c.querySelector('.status-dropdown');
                        if(dd) dd.classList.remove('active');
                    });

                    if (estaFechado) {
                        card.classList.add('z-index-alto');
                        dropdown.classList.add('active');
                    }
                };
                lista.appendChild(card);
            });
        }
        window.updSt = async (uid, st) => { await updateDoc(doc(db, COLLECTIONS.PEDIDOS, uid), {status:st, dataEntregaRealizada: st==='entregue'?new Date():null}); window.mostrarNotificacao('Atualizado','sucesso'); };
        window.delPed = async (uid) => { if(confirm('Excluir?')) await deleteDoc(doc(db, COLLECTIONS.PEDIDOS, uid)); };

        // --- PRODUTOS ---
        let produtosLista = [], cats = [], idEdit = null;
        function initProdutos() {
            onSnapshot(query(collection(db, 'categorias'), orderBy('nome')), (snap) => {
                const sel = document.getElementById('cat-prod'); sel.innerHTML = '<option>Selecione...</option>'; cats = [];
                snap.forEach(d => { cats.push(d.data()); sel.innerHTML += `<option value="${d.data().slug}">${d.data().nome}</option>`; });
            });
            document.getElementById('form-produto').onsubmit = async (e) => {
                e.preventDefault();
                const d = {
                    categoria: document.getElementById('cat-prod').value,
                    imagemUrl: document.getElementById('img-prod').value,
                    nome: document.getElementById('nome-prod').value,
                    preco: parseFloat(document.getElementById('preco-prod').value),
                    detalhes: document.getElementById('detalhes-prod').value,
                    sobEncomenda: document.getElementById('check-encomenda').checked,
                    emPromocao: document.getElementById('check-promo').checked,
                    precoPromocional: parseFloat(document.getElementById('preco-promo').value) || null
                };
                if(idEdit) await updateDoc(doc(db, COLLECTIONS.PRODUTOS, idEdit), d);
                else await addDoc(collection(db, COLLECTIONS.PRODUTOS), {...d, criadoEm: new Date()});
                window.mostrarNotificacao('Salvo','sucesso'); window.fecharModal('modal-produto');
            };
            document.getElementById('form-categoria').onsubmit = async (e) => { e.preventDefault(); await addDoc(collection(db,'categorias'), {nome: document.getElementById('nome-cat').value, slug: document.getElementById('nome-cat').value.toLowerCase()}); window.fecharModal('modal-categoria'); };
        }
        function carregarProdutos() {
            onSnapshot(query(collection(db, COLLECTIONS.PRODUTOS), orderBy('nome')), (snap) => {
                const div = document.getElementById('produtos-container'); div.innerHTML = '';
                document.getElementById('loading-produtos').classList.add('hidden');
                produtosLista = [];
                snap.forEach(d => {
                    const p = {id:d.id, ...d.data()}; produtosLista.push(p);
                    const card = document.createElement('div'); card.className = 'produto-admin-card';
                    card.innerHTML = `<img src="${p.imagemUrl}" class="produto-admin-imagem" onerror="this.src='[https://placehold.co/100?text=Foto](https://placehold.co/100?text=Foto)'">
                    <div class="produto-admin-info"><h3>${p.nome}</h3><div>${formatarPreco(p.preco)}</div></div>
                    <div class="produto-admin-acoes"><button class="btn-icon" onclick="window.editProd('${p.id}')">‚úèÔ∏è</button><button class="btn-icon" onclick="window.delProd('${p.id}')">üóëÔ∏è</button></div>`;
                    div.appendChild(card);
                });
            });
        }
        window.editProd = (id) => { 
            const p = produtosLista.find(x=>x.id===id); idEdit = id; 
            document.getElementById('nome-prod').value = p.nome; document.getElementById('cat-prod').value = p.categoria;
            document.getElementById('img-prod').value = p.imagemUrl; document.getElementById('preco-prod').value = p.preco;
            document.getElementById('detalhes-prod').value = p.detalhes || '';
            document.getElementById('check-promo').checked = p.emPromocao; document.getElementById('preco-promo').value = p.precoPromocional;
            document.getElementById('modal-produto').classList.add('active');
        };
        window.delProd = async (id) => { if(confirm('Excluir?')) await deleteDoc(doc(db, COLLECTIONS.PRODUTOS, id)); };
        
        // Utils UI
        window.fecharModal = (id) => document.getElementById(id).classList.remove('active');
        document.getElementById('btn-novo-produto').onclick = () => { 
            idEdit = null; 
            document.getElementById('form-produto').reset(); 
            document.getElementById('detalhes-prod').value = '';
            document.getElementById('modal-produto').classList.add('active'); 
        };
        document.getElementById('btn-nova-categoria').onclick = () => document.getElementById('modal-categoria').classList.add('active');
        document.getElementById('toggle-sidebar').onclick = () => document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('check-promo').onchange = (e) => document.getElementById('box-promo').classList.toggle('hidden', !e.target.checked);

    </script>
</body>
</html>
