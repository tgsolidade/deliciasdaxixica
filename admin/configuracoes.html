<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - Admin</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    
    <style>
        /* Estilo do Switch (Bot√£o de Abrir/Fechar) */
        .switch-container {
            display: flex; align-items: center; gap: 1rem;
            background: white; padding: 1.5rem; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 2rem;
            border: 1px solid #e5e7eb;
        }
        .switch {
            position: relative; display: inline-block; width: 60px; height: 34px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 26px; width: 26px;
            left: 4px; bottom: 4px; background-color: white;
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #10b981; } /* Verde quando aberto */
        input:checked + .slider:before { transform: translateX(26px); }
        
        .status-texto { font-weight: 700; font-size: 1.2rem; }
        .loja-aberta { color: #10b981; }
        .loja-fechada { color: #ef4444; }

        /* Preview da Logo */
        .logo-preview {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            border: 3px solid #e5e7eb; margin-top: 1rem; background: #f9fafb;
        }
    </style>
</head>
<body>
    
    <button class="toggle-sidebar" id="toggle-sidebar">‚ò∞</button>

    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo"><div style="font-size: 3rem;"></div><h2>Painel ADM</h2></div>
            <nav>
                <ul class="sidebar-menu">
                    <li><a href="index.html"><span class="icon">üìä</span><span>Dashboard</span></a></li>
                    <li><a href="produtos.html"><span class="icon">üçî</span><span>Produtos</span></a></li>
                    <li><a href="pedidos.html"><span class="icon">üì¶</span><span>Pedidos</span></a></li>
                    <li><a href="configuracoes.html" class="active"><span class="icon">‚öôÔ∏è</span><span>Configura√ß√µes</span></a></li>
                    <li style="margin-top: 2rem;"><a href="../public/index.html" target="_blank"><span class="icon">üåê</span><span>Ver Site</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-content">
            <div class="admin-header">
                <h1>‚öôÔ∏è Configura√ß√µes da Loja</h1>
            </div>

            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="switch-loja">
                    <span class="slider"></span>
                </label>
                <div>
                    <div id="texto-status" class="status-texto loja-fechada">LOJA FECHADA</div>
                    <small style="color: #6b7280;">Quando fechada, clientes s√≥ podem pedir itens "Sob Encomenda".</small>
                </div>
            </div>

            <form id="form-config" style="background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                
                <h3 style="margin-bottom: 1rem; color: #374151;">üè† Dados do Restaurante</h3>
                <div class="form-group">
                    <label class="form-label">Nome do Restaurante</label>
                    <input type="text" id="nome-loja" class="form-input" placeholder="Ex: Pizzaria do Tales">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Link da Logo (URL)</label>
                    <input type="url" id="logo-url" class="form-input" placeholder="https://...">
                    <img id="preview-logo" src="" class="logo-preview hidden">
                </div>

                <div class="form-group">
                    <label class="form-label">Slogan / Frase de Efeito</label>
                    <input type="text" id="slogan-loja" class="form-input" placeholder="Ex: O melhor sabor da cidade!">
                </div>

                <h3 style="margin: 2rem 0 1rem; color: #374151;">üõµ Entrega e Valores</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Taxa de Entrega Fixa (R$)</label>
                        <input type="number" id="taxa-entrega" class="form-input" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tempo M√©dio de Entrega</label>
                        <input type="text" id="tempo-entrega" class="form-input" placeholder="Ex: 40-50 min">
                    </div>
                </div>

                <h3 style="margin: 2rem 0 1rem; color: #374151;">üí∞ Dados Pix</h3>
                <div class="form-group">
                    <label class="form-label">Chave PIX</label>
                    <input type="text" id="chave-pix" class="form-input" placeholder="CPF, Email ou Aleat√≥ria">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Nome Benefici√°rio (Sem acentos)</label>
                        <input type="text" id="nome-pix" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cidade Benefici√°rio (Sem acentos)</label>
                        <input type="text" id="cidade-pix" class="form-input">
                    </div>
                </div>

                <h3 style="margin: 2rem 0 1rem; color: #374151;">üì± Contato</h3>
                <div class="form-group">
                    <label class="form-label">WhatsApp do Pedido (com 55)</label>
                    <input type="text" id="whatsapp-loja" class="form-input" placeholder="5599999999999">
                </div>

                <button type="submit" class="btn btn-primario" id="btn-salvar" style="width: 100%; margin-top: 1rem; padding: 1rem; font-size: 1.1rem;">
                    üíæ Salvar Configura√ß√µes
                </button>
            </form>
        </main>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { db, collection, getDocs, doc, updateDoc, setDoc, mostrarNotificacao, COLLECTIONS } from '../assets/js/firebase-config.js';

        const switchLoja = document.getElementById('switch-loja');
        const statusTexto = document.getElementById('texto-status');
        let configId = null; // ID do documento no firebase

        document.addEventListener('DOMContentLoaded', carregarConfiguracoes);

        // Preview Logo em tempo real
        document.getElementById('logo-url').addEventListener('input', (e) => {
            const img = document.getElementById('preview-logo');
            if(e.target.value) {
                img.src = e.target.value;
                img.classList.remove('hidden');
            } else {
                img.classList.add('hidden');
            }
        });

        // Alternar Status da Loja (Visual)
        switchLoja.addEventListener('change', (e) => {
            if(e.target.checked) {
                statusTexto.textContent = "LOJA ABERTA";
                statusTexto.className = "status-texto loja-aberta";
            } else {
                statusTexto.textContent = "LOJA FECHADA";
                statusTexto.className = "status-texto loja-fechada";
            }
        });

        async function carregarConfiguracoes() {
            try {
                const snapshot = await getDocs(collection(db, COLLECTIONS.CONFIGURACOES));
                
                if (!snapshot.empty) {
                    const docSnap = snapshot.docs[0];
                    configId = docSnap.id;
                    const dados = docSnap.data();

                    // Preencher campos
                    document.getElementById('nome-loja').value = dados.nome || '';
                    document.getElementById('slogan-loja').value = dados.slogan || '';
                    document.getElementById('logo-url').value = dados.logoUrl || '';
                    if(dados.logoUrl) {
                        document.getElementById('preview-logo').src = dados.logoUrl;
                        document.getElementById('preview-logo').classList.remove('hidden');
                    }

                    document.getElementById('taxa-entrega').value = dados.taxaEntrega || '';
                    document.getElementById('tempo-entrega').value = dados.tempoEntrega || '';

                    document.getElementById('chave-pix').value = dados.chavePix || '';
                    document.getElementById('nome-pix').value = dados.nomeBeneficiario || '';
                    document.getElementById('cidade-pix').value = dados.cidadeBeneficiario || '';
                    
                    document.getElementById('whatsapp-loja').value = dados.whatsapp || dados.telefone || '';

                    // Status da Loja
                    switchLoja.checked = dados.lojaAberta === true;
                    switchLoja.dispatchEvent(new Event('change')); // Atualiza visual
                }
            } catch (error) {
                console.error("Erro ao carregar:", error);
                mostrarNotificacao("Erro ao carregar dados", "erro");
            }
        }

        document.getElementById('form-config').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-salvar');
            btn.disabled = true; btn.textContent = "Salvando...";

            const dadosSalvar = {
                nome: document.getElementById('nome-loja').value,
                slogan: document.getElementById('slogan-loja').value,
                logoUrl: document.getElementById('logo-url').value,
                
                taxaEntrega: parseFloat(document.getElementById('taxa-entrega').value) || 0,
                tempoEntrega: document.getElementById('tempo-entrega').value,
                
                chavePix: document.getElementById('chave-pix').value,
                nomeBeneficiario: document.getElementById('nome-pix').value,
                cidadeBeneficiario: document.getElementById('cidade-pix').value,
                
                whatsapp: document.getElementById('whatsapp-loja').value,
                
                lojaAberta: switchLoja.checked // Salva se est√° aberta ou fechada
            };

            try {
                if (configId) {
                    await updateDoc(doc(db, COLLECTIONS.CONFIGURACOES, configId), dadosSalvar);
                } else {
                    // Se n√£o existir, cria um novo (ID fixo 'geral' para facilitar)
                    await setDoc(doc(db, COLLECTIONS.CONFIGURACOES, 'geral'), dadosSalvar);
                }
                mostrarNotificacao("‚úÖ Configura√ß√µes salvas!", "sucesso");
            } catch (error) {
                console.error(error);
                mostrarNotificacao("Erro ao salvar.", "erro");
            } finally {
                btn.disabled = false; btn.textContent = "üíæ Salvar Configura√ß√µes";
            }
        });

        document.getElementById('toggle-sidebar').onclick = () => document.getElementById('sidebar').classList.toggle('open');
        
        // Fun√ß√£o Toast manual pois n√£o importamos do config neste arquivo espec√≠fico
        window.mostrarNotificacao = (msg, tipo) => {
            const div = document.createElement('div');
            div.className = `toast toast-${tipo}`;
            div.textContent = msg;
            document.getElementById('toast-container').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>