<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Login</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    
    <style>
        /* --- ESTILOS GERAIS --- */
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }

        /* --- TELA DE LOGIN --- */
        .login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f3f4f6; z-index: 99999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
        }
        .login-card {
            background: white; padding: 2.5rem; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px;
            text-align: center;
        }
        .login-logo {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            margin: 0 auto 1.5rem; border: 3px solid #e5e7eb; display: block;
            background: #eee;
        }
        .login-title { font-family: 'Poppins', sans-serif; font-size: 1.5rem; color: #1f2937; margin-bottom: 2rem; }
        
        /* --- DASHBOARD & OUTROS --- */
        .card-faturamento { background: #f0fdf4; border: 2px solid #bbf7d0; transform: scale(1.02); transition: 0.3s; }
        .card-faturamento:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(22, 163, 74, 0.2); }
        
        .card-clicavel { cursor: pointer; transition: 0.3s; border: 2px solid transparent; }
        .card-clicavel:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: #e5e7eb; }

        .valor-gigante { font-size: 3.5rem; font-weight: 800; color: #16a34a; letter-spacing: -1px; margin: 10px 0; line-height: 1; }
        .valor-normal { font-size: 2.5rem; font-weight: 700; color: #1f2937; }
        .titulo-card { font-size: 1.1rem; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .icon-destaque { font-size: 3rem; background: white; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* --- PEDIDOS --- */
        .pedido-card { background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #ccc; transition: all 0.3s ease; cursor: pointer; position: relative; z-index: 1; }
        .pedido-card.z-index-alto { z-index: 100 !important; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(1.01); }
        .pedido-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .pedido-card.entregue { opacity: 0.6; border-left-color: #10b981; }
        .pedido-card.recebido { border-left-color: #3b82f6; }
        .pedido-card.em_preparo { border-left-color: #f59e0b; }
        .pedido-card.saiu_entrega { border-left-color: #8b5cf6; }
        .pedido-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px;}
        .pedido-id { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
        .pedido-status { padding: 0.375rem 0.875rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600; display: inline-block; }
        .status-recebido { background: #dbeafe; color: #1e40af; }
        .status-em_preparo { background: #fef3c7; color: #92400e; }
        .status-saiu_entrega { background: #ede9fe; color: #5b21b6; }
        .status-entregue { background: #d1fae5; color: #065f46; }
        .pedido-info { display: grid; gap: 0.5rem; margin: 1rem 0; }
        .pedido-info p { margin: 0; color: #6b7280; font-size: 0.95rem; }
        .pedido-itens { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .pedido-item { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.9rem; }
        .pedido-total { margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .pedido-total-valor { font-size: 1.5rem; font-weight: 700; color: #FF6B35; }
        .status-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-top: 0.5rem; padding: 0.5rem; z-index: 1000; display: none; }
        .status-dropdown.active { display: block; animation: slideDown 0.2s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-option { padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .status-option:hover { background: #f3f4f6; }
        .status-option.current { background: #e0e7ff; font-weight: 600; }
        .toggle-entregues { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6b7280; margin-bottom: 1.5rem; }
        .toggle-entregues.active { background: #FF6B35; color: white; border-color: #FF6B35; }
        .contador-badge { background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.625rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
        .toggle-entregues.active .contador-badge { background: rgba(255,255,255,0.2); color: white; }
        .filtros-status { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .filtro-btn { padding: 0.625rem 1.25rem; border: 2px solid #e5e7eb; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .filtro-btn.active { background: #FF6B35; color: white; border-color: #FF6B35; }
        .btn-excluir { background: none; border: none; cursor: pointer; font-size: 1.1rem; opacity: 0.4; }
        .btn-excluir:hover { opacity: 1; transform: scale(1.1); }
        .alerta-cobranca { background: #fff7ed; color: #c2410c; padding: 8px; font-size: 0.9rem; border-radius: 6px; margin-top: 10px; font-weight: bold; border: 1px dashed #f97316; display: flex; align-items: center; gap: 5px; }

        /* --- PRODUTOS & CONFIG & CUPONS --- */
        .badge-cat { background: #f3f4f6; color: #374151; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-right: 5px; }
        .badge-promo { background: #fee2e2; color: #991b1b; }
        .badge-encomenda { background: #dbeafe; color: #1e40af; }
        .check-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; }
        .check-group input { width: 20px; height: 20px; cursor: pointer; }
        .check-group label { cursor: pointer; font-weight: 500; flex: 1; margin: 0; }
        .preco-riscado { text-decoration: line-through; color: #9ca3af; font-size: 0.9rem; margin-right: 5px; }
        .preco-destaque { color: #dc2626; font-weight: 700; }
        .header-actions { display: flex; gap: 10px; }
        .switch-container { display: flex; align-items: center; gap: 1rem; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 2rem; border: 1px solid #e5e7eb; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(26px); }
        .status-texto { font-weight: 700; font-size: 1.2rem; }
        .loja-aberta { color: #10b981; }
        .loja-fechada { color: #ef4444; }
        .logo-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #e5e7eb; margin-top: 1rem; background: #f9fafb; }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; }
        .form-textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; box-sizing: border-box; resize: vertical; font-family: inherit; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primario { background-color: #2563eb; color: white; width: 100%; }
        .btn-primario:hover { background-color: #1d4ed8; }
        .btn-outline { background-color: white; border: 2px solid #2563eb; color: #2563eb; width: 100%; }
        .btn-outline:hover { background-color: #eff6ff; }

        /* Estilo Tabela Cupons */
        .tabela-admin { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tabela-admin th, .tabela-admin td { padding: 1rem; text-align: left; border-bottom: 1px solid #f3f4f6; }
        .tabela-admin th { background: #f9fafb; font-weight: 600; color: #4b5563; }
        .status-ativo { color: #10b981; font-weight: 600; background: #dcfce7; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; }
        .status-inativo { color: #ef4444; font-weight: 600; background: #fee2e2; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; }

        /* --- TOAST E MODAIS --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 99999; }
        .toast { padding: 12px 24px; border-radius: 8px; color: white; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; }
        .toast-sucesso { background-color: #10b981; }
        .toast-erro { background-color: #ef4444; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99999; display: none; align-items: flex-end; justify-content: center; overflow-y: auto; padding: 20px 0;}
        .modal-overlay.active { display: flex; }
        .modal { background: white; width: 100%; max-width: 600px; border-radius: 20px; padding: 20px; animation: slideUp 0.3s ease-out; margin: auto; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0;} to { transform: translateY(0); opacity: 1;} }
    </style>
</head>
<body>
    
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <img id="login-logo-img" src="" class="login-logo hidden" onerror="this.src='https://placehold.co/100?text=Logo'">
            <h2 id="login-nome-loja" class="login-title">√Årea Administrativa</h2>
            
            <form id="form-login">
                <div class="form-group">
                    <input type="email" id="email-login" class="form-input" placeholder="E-mail" required>
                </div>
                <div class="form-group" style="position: relative;">
                    <input type="password" id="senha-login" class="form-input" placeholder="Senha" required style="padding-right: 40px;">
                    <button type="button" id="toggle-senha" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #6b7280; padding: 0;">üëÅÔ∏è</button>
                </div>
                
                <button type="submit" class="btn btn-primario" id="btn-login">Entrar no Painel</button>
            </form>
            <p id="erro-login" style="color: red; margin-top: 10px; font-size: 0.9rem; display: none;"></p>
        </div>
        <p style="margin-top: 2rem; color: #9ca3af; font-size: 0.8rem;">Sistema SaaS Seguro v1.8 - Alerta Ativo üîî</p>
    </div>

    <div class="admin-layout hidden" id="admin-layout">
        
        <button class="toggle-sidebar" id="toggle-sidebar">‚ò∞</button>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo" style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                <img id="admin-logo-img" src="" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; display: none;" onerror="this.style.display='none'; document.getElementById('admin-logo-text').style.display='block';">
                <div id="admin-logo-text" style="font-size: 3rem;">‚ü≥</div>
                <h2 id="nome-loja-sidebar">Carregando...</h2>
            </div>
            <nav>
                <ul class="sidebar-menu">
                    <li><a href="#" onclick="window.navegar('dashboard', this)" class="menu-link active"><span class="icon">üìä</span><span>Dashboard</span></a></li>
                    <li><a href="#" onclick="window.navegar('produtos', this)" class="menu-link"><span class="icon">üçî</span><span>Produtos</span></a></li>
                    <li><a href="#" onclick="window.navegar('pedidos', this)" class="menu-link" id="link-menu-pedidos"><span class="icon">üì¶</span><span>Pedidos</span></a></li>
                    <li><a href="#" onclick="window.navegar('cupons', this)" class="menu-link"><span class="icon">üé´</span><span>Cupons</span></a></li>
                    <li><a href="#" onclick="window.navegar('configuracoes', this)" class="menu-link"><span class="icon">‚öôÔ∏è</span><span>Configura√ß√µes</span></a></li>
                    <li style="margin-top: 1rem; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                        <a href="#" onclick="window.fazerLogout()" class="menu-link" style="color: #ef4444;"><span class="icon">üö™</span><span>Sair</span></a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="admin-content">

            <section id="view-dashboard" class="view-section active">
                <div class="admin-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <h1>üìä Vis√£o Geral</h1>
                        <p style="color: var(--cor-texto-secundario);">Resumo financeiro do per√≠odo</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e5e7eb; flex-wrap: wrap;">
                        <label style="font-weight: 600; font-size: 0.9rem; color: #4b5563;">Per√≠odo:</label>
                        <input type="date" id="filtro-data-inicial" class="form-input" style="padding: 5px; width: auto; font-size: 0.9rem;">
                        <span style="color: #6b7280; font-weight: 600;">at√©</span>
                        <input type="date" id="filtro-data-final" class="form-input" style="padding: 5px; width: auto; font-size: 0.9rem;">
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card card-faturamento">
                        <div>
                            <span class="titulo-card">Faturamento</span>
                            <div class="valor-gigante" id="vendas-hoje">R$ 0,00</div>
                            <small style="color: #15803d; font-weight: 600;">üí∞ Sinais + Entregas</small>
                        </div>
                        <div class="icon-destaque">üíµ</div>
                    </div>
                    
                    <div class="stat-card card-clicavel" onclick="document.getElementById('link-menu-pedidos').click()" title="Ir para Gest√£o de Pedidos">
                        <div>
                            <span class="titulo-card">Pedidos Recebidos</span>
                            <div class="valor-normal" id="pedidos-hoje">0</div>
                            <small style="color: #2563eb; font-weight: 600;">Clique para ver os pedidos üëâ</small>
                        </div>
                        <div class="icon-destaque" style="color: #059669;">üì¶</div>
                    </div>
                </div>

                <div style="margin-top: 3rem;">
                    <h3 style="margin-bottom: 1rem;">Vendas do Per√≠odo Selecionado</h3>
                    <div style="background: white; border-radius: 16px; padding: 1.5rem; overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                            <thead>
                                <tr style="text-align: left; color: #6b7280; border-bottom: 2px solid #f3f4f6;">
                                    <th style="padding: 1rem;">ID</th>
                                    <th style="padding: 1rem;">Cliente</th>
                                    <th style="padding: 1rem;">Status</th>
                                    <th style="padding: 1rem;">Financeiro</th>
                                    <th style="padding: 1rem;">Hora</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-ultimos-pedidos">
                                <tr><td colspan="5" style="text-align:center; padding: 3rem; color: #9ca3af;">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-produtos" class="view-section">
                <div class="admin-header">
                    <h1>üçî Gerenciar Produtos</h1>
                    <div class="header-actions">
                        <button class="btn btn-outline" id="btn-nova-categoria" style="width: auto;">üè∑Ô∏è Categoria</button>
                        <button class="btn btn-primario" id="btn-novo-produto" style="width: auto;">‚ûï Produto</button>
                    </div>
                </div>
                <div id="loading-produtos" class="flex-center" style="padding: 3rem;"><div class="loading"></div></div>
                <div class="produtos-admin-grid" id="produtos-container"></div>
            </section>

            <section id="view-pedidos" class="view-section">
                <div class="admin-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <h1>üì¶ Gest√£o de Pedidos</h1>
                    <div style="display: flex; align-items: center; gap: 10px; background: white; padding: 10px; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <label style="font-weight: 600; font-size: 0.9rem; color: #4b5563;">Filtrar Dia:</label>
                        <input type="date" id="filtro-data-pedidos" class="form-input" style="padding: 5px; width: auto; font-size: 0.9rem;">
                        <button class="btn-outline" onclick="document.getElementById('filtro-data-pedidos').value=''; window.renderPedidos();" style="padding: 5px 10px; font-size: 0.8rem; height: 100%; width: auto;">Ver Todos</button>
                    </div>
                </div>
                <div style="margin-bottom: 2rem;">
                    <button class="toggle-entregues" id="btn-toggle-entregues">
                        <span id="toggle-icon">üëÅÔ∏è</span> <span id="toggle-text">Mostrar Entregues</span> <span class="contador-badge" id="contador-entregues">0</span>
                    </button>
                    <div class="filtros-status">
                        <button class="filtro-btn active" data-filtro="todos">Todos <span class="contador-badge" id="count-todos">0</span></button>
                        <button class="filtro-btn" data-filtro="recebido">Recebido <span class="contador-badge" id="count-recebido">0</span></button>
                        <button class="filtro-btn" data-filtro="em_preparo">Preparo <span class="contador-badge" id="count-em_preparo">0</span></button>
                        <button class="filtro-btn" data-filtro="saiu_entrega">Saiu <span class="contador-badge" id="count-saiu_entrega">0</span></button>
                    </div>
                </div>
                <div id="loading-pedidos" class="flex-center" style="padding: 3rem;"><div class="loading"></div></div>
                <div id="sem-pedidos" class="text-center hidden" style="padding: 3rem;"><h3>Nenhum pedido para esta data</h3></div>
                <div id="lista-pedidos"></div>
            </section>

            <section id="view-cupons" class="view-section">
                <div class="admin-header">
                    <h1>üé´ Cupons de Desconto</h1>
                    <div class="header-actions">
                        <button class="btn btn-primario" id="btn-novo-cupom" style="width: auto;">‚ûï Novo Cupom</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="tabela-admin">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Valor (R$)</th>
                                <th>Validade</th>
                                <th>Usos</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-cupons">
                            <tr><td colspan="7" class="text-center">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="view-configuracoes" class="view-section">
                <div class="admin-header"><h1>‚öôÔ∏è Configura√ß√µes</h1></div>
                <div class="switch-container">
                    <label class="switch"><input type="checkbox" id="switch-loja"><span class="slider"></span></label>
                    <div><div id="texto-status" class="status-texto loja-fechada">LOJA FECHADA</div><small>Define se recebe pedidos ou apenas encomendas.</small></div>
                </div>
                <form id="form-config" style="background: white; padding: 2rem; border-radius: 16px;">
                    <h3>üè† Dados do Restaurante</h3>
                    <div class="form-group"><label>Nome</label><input type="text" id="nome-loja" class="form-input"></div>
                    <div class="form-group"><label>Logo URL</label><input type="url" id="logo-url" class="form-input"><img id="preview-logo" src="" class="logo-preview hidden"></div>
                    <div class="form-group"><label>Slogan</label><input type="text" id="slogan-loja" class="form-input"></div>
                    <h3>üõµ Entrega / Pix</h3>
                    <div class="form-group"><label>Taxa Entrega</label><input type="number" id="taxa-entrega" class="form-input" step="0.01"></div>
                    <div class="form-group"><label>Tempo M√©dio</label><input type="text" id="tempo-entrega" class="form-input"></div>
                    <div class="form-group"><label>Chave Pix</label><input type="text" id="chave-pix" class="form-input"></div>
                    <div class="form-group"><label>Whatsapp</label><input type="text" id="whatsapp-loja" class="form-input"></div>
                    <button type="submit" class="btn btn-primario" id="btn-salvar">üíæ Salvar Configura√ß√µes</button>
                </form>
            </section>

        </main>
    </div>

    <div class="modal-overlay" id="modal-produto">
        <div class="modal">
            <div class="modal-header"><h2>Produto</h2><button type="button" class="modal-close" onclick="window.fecharModal('modal-produto')">√ó</button></div>
            <form id="form-produto">
                <div class="form-group"><label>Categoria</label><select id="cat-prod" class="form-input" required></select></div>
                <div class="form-group">
                    <label>Imagem URL</label>
                    <input type="url" id="img-prod" class="form-input" required>
                    <small style="color: #6b7280; font-size: 0.75rem; margin-top: 5px; display: block;">
                        üí° <b>Dica:</b> Cole links do Google Drive, ou o <b>"Link Direto"</b> do ImgBB.
                    </small>
                </div>
                <div class="form-group"><label>Nome</label><input type="text" id="nome-prod" class="form-input" required></div>
                <div class="form-group"><label>Pre√ßo</label><input type="number" id="preco-prod" class="form-input" step="0.01" required></div>
                
                <div class="form-group" id="box-estoque">
                    <label>Quantidade em Estoque (0 = Esgotado)</label>
                    <input type="number" id="estoque-prod" class="form-input" min="0" placeholder="Ex: 50 (Vazio = Infinito)">
                </div>

                <div class="form-group">
                    <label>Ingredientes / Detalhes</label>
                    <textarea id="detalhes-prod" class="form-textarea" rows="3" placeholder="Ex: P√£o brioche, blend 180g, queijo cheddar, bacon..."></textarea>
                </div>

                <div class="check-group"><input type="checkbox" id="check-promo"><label>Promo√ß√£o</label></div>
                <div class="form-group hidden" id="box-promo"><input type="number" id="preco-promo" class="form-input" placeholder="Pre√ßo Promo"></div>
                
                <div class="check-group"><input type="checkbox" id="check-encomenda"><label>Sob Encomenda</label></div>
                
                <div class="check-group" style="margin-top: 15px; border-color: #fdba74; background: #fff7ed;">
                    <input type="checkbox" id="check-mais-vendido">
                    <label style="color: #ea580c; font-weight: bold;">üî• Produto Mais Vendido (Destacar no topo)</label>
                </div>

                <div class="check-group" style="margin-top: 15px; border-color: #fca5a5; background: #fef2f2;">
                    <input type="checkbox" id="check-bloquear-obs">
                    <label style="color: #991b1b;">Bloquear Observa√ß√µes Livres (Receita Fechada)</label>
                </div>
                
                <div class="form-group hidden" id="box-itens-removiveis" style="margin-top: 10px; border-left: 3px solid #fca5a5; padding-left: 10px;">
                    <label style="color: #991b1b;">Itens que podem ser retirados (opcional)</label>
                    <input type="text" id="itens-removiveis-prod" class="form-input" placeholder="Ex: Cebola, Picles, Tomate">
                    <small style="color: #6b7280; font-size: 0.75rem; display: block; margin-top: 5px;">
                        Separe por v√≠rgula. Mesmo com a receita fechada, o cliente ver√° caixinhas para desmarcar esses itens.
                    </small>
                </div>

                <div id="box-grupos-opcoes" style="margin-top: 30px; border-top: 2px dashed #d1d5db; padding-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="color: #1f2937; margin: 0;">üõ†Ô∏è Grupos de Op√ß√µes (Complementos)</h3>
                    </div>
                    
                    <div id="lista-grupos"></div>
                    
                    <button type="button" class="btn btn-outline" onclick="window.addGrupoOpcao()" style="margin-top: 10px; width: 100%; border: 2px dashed #cbd5e1; border-radius: 12px; padding: 15px; color: #1e293b; font-weight: 700;">+ Adicionar Grupo de Op√ß√µes</button>
                </div>
                
                <button type="submit" class="btn btn-primario" style="margin-top: 30px; font-size: 1.1rem; padding: 15px;">Salvar Produto Completo</button>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal-categoria">
        <div class="modal">
            <div class="modal-header"><h2>Categoria</h2><button type="button" class="modal-close" onclick="window.fecharModal('modal-categoria')">√ó</button></div>
            <form id="form-categoria"><div class="form-group"><input type="text" id="nome-cat" class="form-input" placeholder="Nome da Categoria"></div><button type="submit" class="btn btn-primario">Criar</button></form>
        </div>
    </div>

    <div class="modal-overlay" id="modal-cupom">
        <div class="modal">
            <div class="modal-header"><h2>Novo Cupom</h2><button type="button" class="modal-close" onclick="window.fecharModal('modal-cupom')">√ó</button></div>
            <form id="form-cupom">
                <div class="form-group">
                    <label>C√≥digo do Cupom</label>
                    <input type="text" id="cupom-codigo" class="form-input" placeholder="Ex: DESCONTO10" style="text-transform:uppercase;" required>
                </div>
                <div class="form-group">
                    <label>Valor do Desconto (R$)</label>
                    <input type="number" id="cupom-valor" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Validade (Data Limite)</label>
                    <input type="date" id="cupom-validade" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Limite de Usos (Qtd Total)</label>
                    <input type="number" id="cupom-limite" class="form-input" value="100" required>
                </div>
                <div class="form-group">
                    <label>V√°lido para:</label>
                    <div style="display: flex; gap: 15px; margin-top: 5px;">
                        <label style="cursor: pointer; font-weight: 600; color: #374151;"><input type="checkbox" id="cupom-entrega" checked style="width: 18px; height: 18px;"> üõµ Entrega</label>
                        <label style="cursor: pointer; font-weight: 600; color: #374151;"><input type="checkbox" id="cupom-retirada" checked style="width: 18px; height: 18px;"> üè™ Retirada</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primario">Criar Cupom</button>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { db, auth, collection, getDocs, doc, getDoc, updateDoc, setDoc, addDoc, deleteDoc, onSnapshot, query, orderBy, formatarPreco, COLLECTIONS } from '../assets/js/firebase-config.js';
        import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

        document.getElementById('toggle-senha').addEventListener('click', function() {
            const inputSenha = document.getElementById('senha-login');
            if (inputSenha.type === 'password') {
                inputSenha.type = 'text';
                this.textContent = 'üôà';
            } else {
                inputSenha.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-layout').classList.remove('hidden');
                inicializarSistema();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-layout').classList.add('hidden');
                tentarCarregarLogoLogin(); 
            }
        });

        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email-login').value;
            const senha = document.getElementById('senha-login').value;
            const btn = document.getElementById('btn-login');
            const msgErro = document.getElementById('erro-login');

            btn.disabled = true; btn.textContent = "Entrando...";
            msgErro.style.display = 'none';

            try {
                await signInWithEmailAndPassword(auth, email, senha);
            } catch (error) {
                console.error(error);
                btn.disabled = false; btn.textContent = "Entrar no Painel";
                msgErro.textContent = "E-mail ou senha incorretos.";
                msgErro.style.display = 'block';
            }
        });

        window.fazerLogout = async () => {
            try { await signOut(auth); window.location.reload(); } catch(e) { console.error(e); }
        };

        async function tentarCarregarLogoLogin() {
            try {
                const snap = await getDocs(collection(db, COLLECTIONS.CONFIGURACOES));
                if(!snap.empty) {
                    const d = snap.docs[0].data();
                    if(d.logoUrl) {
                        const img = document.getElementById('login-logo-img');
                        img.src = d.logoUrl; img.classList.remove('hidden');
                    }
                    if(d.nome) document.getElementById('login-nome-loja').textContent = d.nome;
                }
            } catch(e) { console.log("Aguardando login..."); }
        }

        function inicializarSistema() {
            initDashboard();
            initConfig();
            initPedidos();
            initProdutos();
            initCupons(); 
        }

        window.mostrarNotificacao = (msg, tipo) => {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = `toast toast-${tipo}`; div.textContent = msg;
            container.appendChild(div); setTimeout(() => div.remove(), 3000);
        };
        
        window.navegar = (tela, el) => {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
            document.getElementById('view-' + tela).classList.add('active');
            if(el) el.classList.add('active');
            if(tela === 'produtos' && produtosLista.length === 0) carregarProdutos();
            
            document.getElementById('sidebar').classList.remove('open');
        };

        let dashSnapshot = null;
        
        function initDashboard() {
            const inputDataInicial = document.getElementById('filtro-data-inicial');
            const inputDataFinal = document.getElementById('filtro-data-final');
            
            const hoje = new Date().toISOString().split('T')[0];
            
            if (!inputDataInicial.value) inputDataInicial.value = hoje;
            if (!inputDataFinal.value) inputDataFinal.value = hoje;
            
            inputDataInicial.addEventListener('change', atualizarCardsDashboard);
            inputDataFinal.addEventListener('change', atualizarCardsDashboard);

            getDocs(collection(db, COLLECTIONS.CONFIGURACOES)).then(snap => {
                if(!snap.empty) {
                    const d = snap.docs[0].data();
                    if(d.nome) document.getElementById('nome-loja-sidebar').textContent = d.nome;
                    if(d.logoUrl) {
                        const img = document.getElementById('admin-logo-img');
                        img.src = d.logoUrl; img.style.display = 'block';
                        document.getElementById('admin-logo-text').style.display = 'none';
                    }
                }
            });

            onSnapshot(query(collection(db, COLLECTIONS.PEDIDOS)), (snapshot) => {
                dashSnapshot = snapshot;
                atualizarCardsDashboard();
            });
        }

        function atualizarCardsDashboard() {
            if(!dashSnapshot) return;
            
            const dataInicialStr = document.getElementById('filtro-data-inicial').value;
            const dataFinalStr = document.getElementById('filtro-data-final').value;
            
            if (!dataInicialStr || !dataFinalStr) return;

            const dataInicio = new Date(dataInicialStr + "T00:00:00");
            const dataFim = new Date(dataFinalStr + "T23:59:59");

            let fat = 0, qtd = 0, lista = [];
            
            dashSnapshot.forEach(doc => {
                const p = { id: doc.id, ...doc.data() };
                const dCria = p.criadoEm?.toDate ? p.criadoEm.toDate() : null;
                const dEntr = p.dataEntregaRealizada?.toDate ? p.dataEntregaRealizada.toDate() : null;
                
                if (dCria && dCria >= dataInicio && dCria <= dataFim) {
                    qtd++; 
                    lista.push(p);
                    fat += p.isEncomenda ? (p.valorSinal || 0) : (p.total || 0);
                }
                
                if (p.isEncomenda && dEntr && dEntr >= dataInicio && dEntr <= dataFim && p.status === 'entregue') {
                    fat += (p.valorRestante || 0);
                }
            });

            document.getElementById('vendas-hoje').textContent = formatarPreco(fat);
            document.getElementById('pedidos-hoje').textContent = qtd;
            
            lista.sort((a, b) => b.criadoEm - a.criadoEm);
            let html = '';
            
            lista.forEach(p => {
                const stColor = p.status === 'entregue' ? '#10b981' : '#f59e0b';
                const dataFormatada = p.criadoEm.toDate().toLocaleDateString('pt-BR') + ' ' + p.criadoEm.toDate().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
                html += `<tr style="border-bottom: 1px solid #f3f4f6;">
                    <td style="padding:1rem;">${p.idDisplay || p.id}</td>
                    <td>${p.cliente?.nome || '-'}</td>
                    <td style="color:${stColor}; font-weight:600;">${p.status}</td>
                    <td>${p.isEncomenda ? 'Sinal 50%' : 'Total'}</td>
                    <td style="color:#666;">${dataFormatada}</td>
                </tr>`;
            });
            document.getElementById('tabela-ultimos-pedidos').innerHTML = html || '<tr><td colspan="5" style="text-align:center;padding:2rem;">Nenhum pedido neste per√≠odo.</td></tr>';
        }

        let configId = null;
        async function initConfig() {
            const switchLoja = document.getElementById('switch-loja');
            document.getElementById('logo-url').addEventListener('input', (e) => {
                const img = document.getElementById('preview-logo');
                if(e.target.value) { img.src = e.target.value; img.classList.remove('hidden'); }
                else img.classList.add('hidden');
            });
            switchLoja.addEventListener('change', (e) => {
                const txt = document.getElementById('texto-status');
                if(e.target.checked) { txt.textContent = "LOJA ABERTA"; txt.className = "status-texto loja-aberta"; }
                else { txt.textContent = "LOJA FECHADA"; txt.className = "status-texto loja-fechada"; }
            });
            const snap = await getDocs(collection(db, COLLECTIONS.CONFIGURACOES));
            if (!snap.empty) {
                configId = snap.docs[0].id;
                const d = snap.docs[0].data();
                document.getElementById('nome-loja').value = d.nome || '';
                document.getElementById('logo-url').value = d.logoUrl || '';
                document.getElementById('slogan-loja').value = d.slogan || '';
                document.getElementById('taxa-entrega').value = d.taxaEntrega || '';
                document.getElementById('tempo-entrega').value = d.tempoEntrega || '';
                document.getElementById('chave-pix').value = d.chavePix || '';
                document.getElementById('whatsapp-loja').value = d.whatsapp || '';
                switchLoja.checked = d.lojaAberta === true;
                switchLoja.dispatchEvent(new Event('change'));
                if(d.logoUrl) { document.getElementById('preview-logo').src = d.logoUrl; document.getElementById('preview-logo').classList.remove('hidden'); }
            }
            document.getElementById('form-config').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-salvar'); btn.textContent = "Salvando..."; btn.disabled = true;
                const dados = {
                    nome: document.getElementById('nome-loja').value,
                    logoUrl: document.getElementById('logo-url').value,
                    slogan: document.getElementById('slogan-loja').value,
                    taxaEntrega: parseFloat(document.getElementById('taxa-entrega').value) || 0,
                    tempoEntrega: document.getElementById('tempo-entrega').value,
                    chavePix: document.getElementById('chave-pix').value,
                    whatsapp: document.getElementById('whatsapp-loja').value,
                    lojaAberta: switchLoja.checked
                };
                try {
                    await setDoc(doc(db, COLLECTIONS.CONFIGURACOES, configId || 'geral'), dados);
                    window.mostrarNotificacao("Salvo!", "sucesso");
                } catch(e) { window.mostrarNotificacao("Erro", "erro"); }
                finally { btn.textContent = "üíæ Salvar Configura√ß√µes"; btn.disabled = false; }
            });
        }

        let todosPedidos = [], mostrarEntregues = false, filtro = 'todos';
        let primeiraCargaPedidos = true; 

        function initPedidos() {
            const inputDataPedidos = document.getElementById('filtro-data-pedidos');
            if (!inputDataPedidos.value) {
                inputDataPedidos.value = new Date().toISOString().split('T')[0];
            }
            inputDataPedidos.addEventListener('change', renderPedidos);

            onSnapshot(query(collection(db, COLLECTIONS.PEDIDOS)), (snap) => {
                if (!primeiraCargaPedidos) {
                    snap.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                            audio.play().catch(e => console.log('√Åudio bloqueado pelo navegador', e));
                            window.mostrarNotificacao('üîî NOVO PEDIDO CHEGOU!', 'sucesso');
                        }
                    });
                }
                primeiraCargaPedidos = false; 

                todosPedidos = [];
                snap.forEach(d => todosPedidos.push({ uid: d.id, ...d.data() }));
                
                todosPedidos.sort((a,b) => {
                    const dataA = a.criadoEm?.toDate ? a.criadoEm.toDate() : new Date();
                    const dataB = b.criadoEm?.toDate ? b.criadoEm.toDate() : new Date();
                    return dataB - dataA;
                });

                renderPedidos();
                document.getElementById('loading-pedidos').classList.add('hidden');
            });
            
            document.getElementById('btn-toggle-entregues').onclick = function() { mostrarEntregues = !mostrarEntregues; this.classList.toggle('active'); renderPedidos(); };
            document.querySelectorAll('.filtro-btn').forEach(b => b.onclick = function() { document.querySelectorAll('.filtro-btn').forEach(x=>x.classList.remove('active')); this.classList.add('active'); filtro = this.dataset.filtro; renderPedidos(); });
        }

        window.renderPedidos = () => {
            const lista = document.getElementById('lista-pedidos'); lista.innerHTML = '';
            
            const dataSelecionada = document.getElementById('filtro-data-pedidos').value;
            let dataRefStr = null;
            if(dataSelecionada) {
                const [ano, mes, dia] = dataSelecionada.split('-');
                dataRefStr = new Date(ano, mes - 1, dia).toDateString();
            }

            let pedidosDoDia = todosPedidos;
            if (dataRefStr) {
                pedidosDoDia = todosPedidos.filter(p => {
                    const dCria = p.criadoEm?.toDate ? p.criadoEm.toDate() : null;
                    return dCria && dCria.toDateString() === dataRefStr;
                });
            }

            let contagens = { todos: 0, recebido: 0, em_preparo: 0, saiu_entrega: 0, entregue: 0 };

            pedidosDoDia.forEach(p => {
                if(contagens[p.status] !== undefined) contagens[p.status]++;
                if(p.status !== 'entregue') contagens.todos++;
            });

            document.getElementById('count-todos').textContent = contagens.todos;
            document.getElementById('count-recebido').textContent = contagens.recebido;
            document.getElementById('count-em_preparo').textContent = contagens.em_preparo;
            document.getElementById('count-saiu_entrega').textContent = contagens.saiu_entrega;
            document.getElementById('contador-entregues').textContent = contagens.entregue;

            let filtrados = pedidosDoDia.filter(p => {
                if (!mostrarEntregues && p.status === 'entregue') return false;
                if (filtro === 'todos') return true;
                return p.status === filtro;
            });
            
            if(filtrados.length === 0) document.getElementById('sem-pedidos').classList.remove('hidden');
            else document.getElementById('sem-pedidos').classList.add('hidden');
            
            const icons = {recebido:'üîµ',em_preparo:'üü°',saiu_entrega:'üü£',entregue:'‚úÖ'};
            
            filtrados.forEach(p => {
                const card = document.createElement('div');
                card.className = `pedido-card ${p.status}`;
                card.id = `card-${p.uid}`; 
                
                const dCria = p.criadoEm?.toDate ? p.criadoEm.toDate() : new Date();
                const dataFormatada = dCria.toLocaleDateString('pt-BR') + ' √†s ' + dCria.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

                const itens = p.itens?.map(i => {
                    const quantidade = i.qtd || i.quantidade || 1;
                    
                    let complementosHtml = '';
                    if (i.opcoesSelecionadas && Array.isArray(i.opcoesSelecionadas) && i.opcoesSelecionadas.length > 0) {
                        complementosHtml = i.opcoesSelecionadas.map(op => {
                            const descrPreco = op.preco > 0 ? ` (+${formatarPreco(op.preco)})` : '';
                            return `<div style="font-size:0.8rem; color:#4b5563; margin-left: 15px;">+ ${op.nome}${descrPreco}</div>`;
                        }).join('');
                    }

                    return `<div class="pedido-item"><span>${quantidade}x ${i.nome}</span><span>${formatarPreco((i.preco||0) * quantidade)}</span></div>
                            ${complementosHtml}
                            ${i.obs ? `<div style="font-size:0.8rem; color:#ef4444; margin-left: 10px;">Obs: ${i.obs}</div>` : ''}`;
                }).join('') || '';
                
                let enderecoTexto = 'üè™ Retirada no Balc√£o';
                if(p.tipoEntrega === 'entrega' && p.endereco) {
                     enderecoTexto = `${p.endereco.logradouro||'Rua'}, ${p.endereco.numero||'SN'} - ${p.endereco.bairro||''}`;
                     if(p.endereco.complemento) {
                         enderecoTexto += ` (Comp: ${p.endereco.complemento})`;
                     }
                }

                let pagamentoTexto = 'N√£o informado';
                if(p.pagamento) {
                    if(p.pagamento.forma === 'pix') pagamentoTexto = '<strong style="color:#0369a1;">üí† PIX (Verificar Comprovante)</strong>';
                    else if(p.pagamento.forma === 'cartao' || p.pagamento.forma === 'cartao_maquina') pagamentoTexto = 'üí≥ Cart√£o na Entrega';
                    else if(p.pagamento.forma === 'dinheiro') {
                        pagamentoTexto = 'üíµ Dinheiro';
                        if(p.pagamento.troco) pagamentoTexto += ` <strong style="color:#b45309;">(Levar troco para R$ ${p.pagamento.troco})</strong>`;
                    }
                }
                
                let cupomHtml = '';
                if (p.cupom) {
                    cupomHtml = `<div style="margin-top:5px; color:#16a34a; font-weight:600; font-size:0.9rem;">üé´ Cupom: ${p.cupom.codigo} (-${formatarPreco(p.cupom.desconto)})</div>`;
                }

                card.innerHTML = `
                    <div class="pedido-header">
                        <div>
                            <strong class="pedido-id">#${p.idDisplay||p.id}</strong> 
                            <span style="font-size:0.8rem; font-weight:600; color:#6b7280; margin-left:10px; background:#f3f4f6; padding:2px 8px; border-radius:10px;">üìÖ ${dataFormatada}</span>
                        </div>
                        <div>
                            <span class="pedido-status status-${p.status}">${icons[p.status]||''} ${p.status}</span>
                            <button class="btn-excluir" onclick="window.delPed('${p.uid}')" style="margin-left:10px;" title="Excluir Pedido">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="pedido-info" style="background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #f3f4f6;">
                        <p style="color: #1f2937; font-weight: 600; margin-bottom: 5px;">üë§ ${p.cliente?.nome} <a href="https://wa.me/${(p.cliente?.telefone||'').replace(/\D/g,'')}" target="_blank" style="text-decoration:none; margin-left:5px;" title="Chamar no Whatsapp">üì±<span style="font-weight: normal; color: #6b7280; font-size: 0.85rem; text-decoration: underline;">${p.cliente?.telefone || ''}</span></a></p>
                        <p style="margin-bottom: 5px;">üìç ${enderecoTexto}</p>
                        <p>üí≥ ${pagamentoTexto}</p>
                    </div>

                    <div class="pedido-itens">${itens}</div>
                    ${cupomHtml}
                    <div class="pedido-total"><span>Total</span><span class="pedido-total-valor">${formatarPreco(p.total||0)}</span></div>
                    <div class="status-dropdown" id="dd-${p.uid}">
                        ${Object.keys(icons).map(k => `<div class="status-option" onclick="window.updSt('${p.uid}','${k}')">${icons[k]} ${k}</div>`).join('')}
                    </div>
                `;
                card.onclick = (e) => {
                    if(e.target.closest('.status-option') || e.target.closest('.btn-excluir') || e.target.closest('a')) return;
                    const dropdown = document.getElementById(`dd-${p.uid}`);
                    const estaFechado = !dropdown.classList.contains('active');
                    document.querySelectorAll('.pedido-card').forEach(c => { c.classList.remove('z-index-alto'); const dd = c.querySelector('.status-dropdown'); if(dd) dd.classList.remove('active'); });
                    if (estaFechado) { card.classList.add('z-index-alto'); dropdown.classList.add('active'); }
                };
                lista.appendChild(card);
            });
        }
        window.updSt = async (uid, st) => { await updateDoc(doc(db, COLLECTIONS.PEDIDOS, uid), {status:st, dataEntregaRealizada: st==='entregue'?new Date():null}); window.mostrarNotificacao('Atualizado','sucesso'); };
        
        window.delPed = async (uid) => { 
            if(confirm('Tem certeza que deseja excluir este pedido? Se houver produtos controlados por estoque, as quantidades ser√£o devolvidas.')) {
                try {
                    const pedidoDoc = await getDoc(doc(db, COLLECTIONS.PEDIDOS, uid));
                    
                    if (pedidoDoc.exists()) {
                        const pedidoData = pedidoDoc.data();
                        
                        if (pedidoData.itens && Array.isArray(pedidoData.itens)) {
                            for (const item of pedidoData.itens) {
                                const quantidadeDevolver = item.qtd || item.quantidade || 1;
                                
                                const produtoRef = doc(db, COLLECTIONS.PRODUTOS, item.id);
                                const produtoDoc = await getDoc(produtoRef);
                                
                                if (produtoDoc.exists()) {
                                    const produtoData = produtoDoc.data();
                                    
                                    if (produtoData.estoque !== null && produtoData.estoque !== undefined) {
                                        const novoEstoque = produtoData.estoque + quantidadeDevolver;
                                        await updateDoc(produtoRef, { estoque: novoEstoque });
                                    }
                                }
                            }
                        }
                    }
                    
                    await deleteDoc(doc(db, COLLECTIONS.PEDIDOS, uid)); 
                    window.mostrarNotificacao('Pedido exclu√≠do com sucesso.', 'sucesso');
                    
                } catch (error) {
                    console.error("Erro ao excluir pedido e retornar estoque:", error);
                    window.mostrarNotificacao('Erro ao excluir pedido.', 'erro');
                }
            }
        };

        // --- SISTEMA DE GRUPOS DE OP√á√ïES ---
        let produtosLista = [], cats = [], idEdit = null;
        let gruposOpcoesList = []; 

        window.addGrupoOpcao = () => {
            gruposOpcoesList.push({ id: Date.now().toString(), nome: '', min: 0, max: 1, qtdGratis: 0, itens: [] });
            renderGruposOpcoes();
        };

        window.removeGrupo = (id) => {
            if(confirm('Remover este grupo inteiro?')) {
                gruposOpcoesList = gruposOpcoesList.filter(g => g.id !== id);
                renderGruposOpcoes();
            }
        };

        window.addItemGrupo = (grupoId) => {
            const g = gruposOpcoesList.find(x => x.id === grupoId);
            if(g) { g.itens.push({ id: Date.now().toString(), nome: '', preco: 0, foto: '' }); renderGruposOpcoes(); }
        };

        window.removeItemGrupo = (grupoId, itemId) => {
            const g = gruposOpcoesList.find(x => x.id === grupoId);
            if(g) { g.itens = g.itens.filter(i => i.id !== itemId); renderGruposOpcoes(); }
        };

        window.updateGrupo = (grupoId, field, value) => {
            const g = gruposOpcoesList.find(x => x.id === grupoId);
            if(g) g[field] = value;
        };

        window.updateItemGrupo = (grupoId, itemId, field, value) => {
            const g = gruposOpcoesList.find(x => x.id === grupoId);
            if(g) {
                const item = g.itens.find(i => i.id === itemId);
                if(item) item[field] = value;
            }
        };

        function renderGruposOpcoes() {
            const container = document.getElementById('lista-grupos');
            container.innerHTML = '';
            
            if (gruposOpcoesList.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 10px;">Nenhum grupo criado.</div>';
                return;
            }

            gruposOpcoesList.forEach((g) => {
                let itensHtml = '';
                g.itens.forEach((item) => {
                    itensHtml += `
                        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; background: #fff; margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px;">
                                <input type="text" class="form-input" placeholder="Nome" value="${item.nome}" onchange="window.updateItemGrupo('${g.id}', '${item.id}', 'nome', this.value)" style="flex: 2;">
                                <input type="number" class="form-input" placeholder="Pre√ßo" step="0.01" value="${item.preco}" onchange="window.updateItemGrupo('${g.id}', '${item.id}', 'preco', parseFloat(this.value)||0)" style="flex: 1; min-width: 80px;">
                                <button type="button" onclick="window.removeItemGrupo('${g.id}', '${item.id}')" style="background: #fee2e2; color: #ef4444; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 42px; height: 42px; font-size: 1.1rem;" title="Remover Op√ß√£o">üóëÔ∏è</button>
                            </div>
                            <input type="url" class="form-input" placeholder="URL da Foto (Opcional)" value="${item.foto}" onchange="window.updateItemGrupo('${g.id}', '${item.id}', 'foto', this.value)" style="width: 100%;">
                        </div>
                    `;
                });

                container.innerHTML += `
                    <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #d1d5db; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px;">
                            <label style="font-weight: 700; color: #1f2937; font-size: 0.95rem;">Nome do Grupo</label>
                            <button type="button" onclick="window.removeGrupo('${g.id}')" style="background: #fee2e2; color: #ef4444; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px;">Remover ‚úï</button>
                        </div>
                        <input type="text" class="form-input" placeholder="Ex: Escolha o Tamanho" value="${g.nome}" onchange="window.updateGrupo('${g.id}', 'nome', this.value)" style="margin-bottom: 15px;" required>

                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 80px;">
                                <label style="font-size: 0.8rem; font-weight:700; color:#4b5563; display:block; margin-bottom:4px;">M√≠n. Escolhas</label>
                                <input type="number" class="form-input" value="${g.min}" min="0" onchange="window.updateGrupo('${g.id}', 'min', parseInt(this.value)||0)">
                            </div>
                            <div style="flex: 1; min-width: 80px;">
                                <label style="font-size: 0.8rem; font-weight:700; color:#4b5563; display:block; margin-bottom:4px;">M√°x. Escolhas</label>
                                <input type="number" class="form-input" value="${g.max}" min="1" onchange="window.updateGrupo('${g.id}', 'max', parseInt(this.value)||1)">
                            </div>
                            <div style="flex: 1; min-width: 80px;">
                                <label style="font-size: 0.8rem; font-weight:700; color:#10b981; display:block; margin-bottom:4px;">Qtd Gr√°tis</label>
                                <input type="number" class="form-input" value="${g.qtdGratis}" min="0" onchange="window.updateGrupo('${g.id}', 'qtdGratis', parseInt(this.value)||0)">
                            </div>
                        </div>

                        <div id="itens-grupo-${g.id}" style="display:flex; flex-direction:column;">
                            ${itensHtml}
                        </div>

                        <button type="button" onclick="window.addItemGrupo('${g.id}')" style="width: 100%; margin-top: 5px; padding: 10px; background: transparent; border: 1px dashed #94a3b8; color: #475569; font-weight: 600; border-radius: 8px; cursor: pointer; transition: 0.2s;">+ Adicionar Op√ß√£o</button>
                    </div>
                `;
            });
        }

        function converterUrlImagem(url) {
            if (!url) return url;
            const gdriveRegex = /drive\.google\.com\/file\/d\/([^/]+)/;
            const matchDrive = url.match(gdriveRegex);
            if (matchDrive && matchDrive[1]) {
                return `https://drive.google.com/uc?export=view&id=${matchDrive[1]}`;
            }
            const gdriveOpenRegex = /drive\.google\.com\/open\?id=([^&]+)/;
            const matchOpen = url.match(gdriveOpenRegex);
            if (matchOpen && matchOpen[1]) {
                return `https://drive.google.com/uc?export=view&id=${matchOpen[1]}`;
            }
            return url; 
        }

        function initProdutos() {
            onSnapshot(query(collection(db, 'categorias'), orderBy('nome')), (snap) => {
                const sel = document.getElementById('cat-prod'); sel.innerHTML = '<option>Selecione...</option>'; cats = [];
                snap.forEach(d => { cats.push(d.data()); sel.innerHTML += `<option value="${d.data().slug}">${d.data().nome}</option>`; });
            });
            
            document.getElementById('check-bloquear-obs').onchange = (e) => {
                document.getElementById('box-itens-removiveis').classList.toggle('hidden', !e.target.checked);
            };

            document.getElementById('form-produto').onsubmit = async (e) => {
                e.preventDefault();
                
                for (const g of gruposOpcoesList) {
                    if (!g.nome) return window.mostrarNotificacao('Todos os grupos precisam de um nome.', 'erro');
                    for (const i of g.itens) {
                        if (!i.nome) return window.mostrarNotificacao(`O item de um grupo est√° sem nome.`, 'erro');
                    }
                }

                const vEstoque = document.getElementById('estoque-prod').value;
                const urlBruta = document.getElementById('img-prod').value;
                
                const precoNormal = parseFloat(document.getElementById('preco-prod').value);
                const isPromo = document.getElementById('check-promo').checked;
                const precoPromo = parseFloat(document.getElementById('preco-promo').value);

                if (isPromo) {
                    if (!precoPromo || precoPromo >= precoNormal) {
                        return window.mostrarNotificacao('O pre√ßo promocional deve ser MENOR que o original!', 'erro');
                    }
                }

                const itensTexto = document.getElementById('itens-removiveis-prod').value;
                const itensRemoviveisArray = itensTexto ? itensTexto.split(',').map(i => i.trim()).filter(i => i !== '') : [];

                const d = {
                    categoria: document.getElementById('cat-prod').value,
                    imagemUrl: converterUrlImagem(urlBruta),
                    nome: document.getElementById('nome-prod').value,
                    preco: precoNormal,
                    detalhes: document.getElementById('detalhes-prod').value, 
                    sobEncomenda: document.getElementById('check-encomenda').checked,
                    emPromocao: isPromo,
                    precoPromocional: isPromo ? precoPromo : null,
                    estoque: vEstoque ? parseInt(vEstoque) : null,
                    bloquearObs: document.getElementById('check-bloquear-obs').checked,
                    maisVendido: document.getElementById('check-mais-vendido').checked,
                    itensRemoviveis: itensRemoviveisArray,
                    gruposOpcoes: gruposOpcoesList 
                };
                
                if(idEdit) await updateDoc(doc(db, COLLECTIONS.PRODUTOS, idEdit), d);
                else await addDoc(collection(db, COLLECTIONS.PRODUTOS), {...d, criadoEm: new Date()});
                window.mostrarNotificacao('Produto salvo!','sucesso'); 
                window.fecharModal('modal-produto');
            };
            document.getElementById('form-categoria').onsubmit = async (e) => { e.preventDefault(); await addDoc(collection(db,'categorias'), {nome: document.getElementById('nome-cat').value, slug: document.getElementById('nome-cat').value.toLowerCase()}); window.fecharModal('modal-categoria'); };
        }
        function carregarProdutos() {
            onSnapshot(query(collection(db, COLLECTIONS.PRODUTOS), orderBy('nome')), (snap) => {
                const div = document.getElementById('produtos-container'); div.innerHTML = '';
                document.getElementById('loading-produtos').classList.add('hidden');
                produtosLista = [];
                snap.forEach(d => {
                    const p = {id:d.id, ...d.data()}; produtosLista.push(p);
                    const card = document.createElement('div'); card.className = 'produto-admin-card';
                    
                    let infoEstoque = '';
                    if (p.estoque !== null && p.estoque !== undefined) {
                        const corEstoque = p.estoque > 0 ? '#10b981' : '#ef4444';
                        infoEstoque = `<div style="font-size:0.8rem; font-weight:600; color:${corEstoque};">Estoque: ${p.estoque}</div>`;
                    } else {
                        infoEstoque = `<div style="font-size:0.8rem; font-weight:600; color:#6b7280;">Estoque: Ilimitado</div>`;
                    }

                    const infoObs = p.bloquearObs ? `<div style="font-size:0.75rem; color:#ef4444; margin-top:2px;">‚ö†Ô∏è Receita Fechada</div>` : '';
                    const tagMaisVendido = p.maisVendido ? `<div style="font-size:0.75rem; color:#ea580c; font-weight:bold; margin-top:2px;">üî• Mais Vendido</div>` : '';
                    
                    const infoGrupos = (p.gruposOpcoes && p.gruposOpcoes.length > 0) ? `<div style="font-size:0.75rem; color:#2563eb; margin-top:2px; font-weight: bold;">üõ†Ô∏è Possui Op√ß√µes/Complementos</div>` : '';

                    card.innerHTML = `
                    <img src="${p.imagemUrl}" class="produto-admin-imagem" onerror="this.src='https://placehold.co/100?text=Foto'">
                    <div class="produto-admin-info">
                        <h3>${p.nome}</h3>
                        <div>${formatarPreco(p.preco)}</div>
                        ${infoEstoque}
                        ${infoObs}
                        ${tagMaisVendido}
                        ${infoGrupos}
                    </div>
                    <div class="produto-admin-acoes">
                        <button class="btn-icon" onclick="window.editProd('${p.id}')">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="window.delProd('${p.id}')">üóëÔ∏è</button>
                    </div>`;
                    div.appendChild(card);
                });
            });
        }
        window.editProd = (id) => { 
            const p = produtosLista.find(x=>x.id===id); idEdit = id; 
            document.getElementById('nome-prod').value = p.nome; document.getElementById('cat-prod').value = p.categoria;
            document.getElementById('img-prod').value = p.imagemUrl; document.getElementById('preco-prod').value = p.preco;
            document.getElementById('detalhes-prod').value = p.detalhes || '';
            document.getElementById('estoque-prod').value = (p.estoque !== null && p.estoque !== undefined) ? p.estoque : '';
            document.getElementById('check-promo').checked = p.emPromocao; document.getElementById('preco-promo').value = p.precoPromocional;
            document.getElementById('check-encomenda').checked = p.sobEncomenda;
            
            document.getElementById('check-bloquear-obs').checked = p.bloquearObs || false;
            document.getElementById('check-mais-vendido').checked = p.maisVendido || false;
            document.getElementById('itens-removiveis-prod').value = p.itensRemoviveis ? p.itensRemoviveis.join(', ') : '';
            
            gruposOpcoesList = p.gruposOpcoes ? JSON.parse(JSON.stringify(p.gruposOpcoes)) : [];
            renderGruposOpcoes();

            document.getElementById('box-promo').classList.toggle('hidden', !p.emPromocao);
            document.getElementById('box-estoque').classList.remove('hidden');
            document.getElementById('box-itens-removiveis').classList.toggle('hidden', !p.bloquearObs);

            document.getElementById('modal-produto').classList.add('active');
        };
        window.delProd = async (id) => { if(confirm('Excluir?')) await deleteDoc(doc(db, COLLECTIONS.PRODUTOS, id)); };

        // --- CUPONS COM FIX DE DATA LOCAL ---
        function initCupons() {
            onSnapshot(collection(db, 'cupons'), (snap) => {
                const tbody = document.getElementById('lista-cupons');
                tbody.innerHTML = '';
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum cupom cadastrado.</td></tr>'; return; }
                
                snap.forEach(d => {
                    const c = { id: d.id, ...d.data() };
                    
                    const dataAtual = new Date();
                    const hojeLocal = dataAtual.getFullYear() + '-' + String(dataAtual.getMonth() + 1).padStart(2, '0') + '-' + String(dataAtual.getDate()).padStart(2, '0');
                    
                    const dataValidade = new Date(c.validade + "T00:00:00").getTime();
                    const dataHoje = new Date(hojeLocal + "T00:00:00").getTime();
                    
                    const expirado = dataValidade < dataHoje;
                    const esgotado = c.usos >= c.limite;
                    
                    let statusClass = 'status-ativo';
                    let statusText = 'ATIVO';

                    if (expirado) { statusClass = 'status-inativo'; statusText = 'EXPIRADO'; }
                    else if (esgotado) { statusClass = 'status-inativo'; statusText = 'ESGOTADO'; }

                    let infoTipo = 'Ambos';
                    if (c.validoEntrega && !c.validoRetirada) infoTipo = 'üõµ Entrega';
                    if (!c.validoEntrega && c.validoRetirada) infoTipo = 'üè™ Retirada';

                    tbody.innerHTML += `
                        <tr>
                            <td style="font-weight:700;">${c.codigo}</td>
                            <td>${formatarPreco(c.valor)}</td>
                            <td>${new Date(c.validade + "T00:00:00").toLocaleDateString('pt-BR')}</td>
                            <td>${c.usos} / ${c.limite}</td>
                            <td><span style="font-size:0.85rem; color:#4b5563;">${infoTipo}</span></td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                            <td><button class="btn-excluir" onclick="window.delCupom('${c.id}')">üóëÔ∏è</button></td>
                        </tr>
                    `;
                });
            });

            document.getElementById('btn-novo-cupom').onclick = () => {
                document.getElementById('form-cupom').reset();
                document.getElementById('modal-cupom').classList.add('active');
            };

            document.getElementById('form-cupom').onsubmit = async (e) => {
                e.preventDefault();
                const codigo = document.getElementById('cupom-codigo').value.toUpperCase().trim();
                const valor = parseFloat(document.getElementById('cupom-valor').value);
                const validade = document.getElementById('cupom-validade').value;
                const limite = parseInt(document.getElementById('cupom-limite').value);
                
                const vEntrega = document.getElementById('cupom-entrega').checked;
                const vRetirada = document.getElementById('cupom-retirada').checked;

                if (!codigo || !valor || !validade || !limite) return window.mostrarNotificacao('Preencha tudo', 'erro');
                if (!vEntrega && !vRetirada) return window.mostrarNotificacao('Marque pelo menos um tipo de entrega (Entrega ou Retirada)', 'erro');

                try {
                    await addDoc(collection(db, 'cupons'), { 
                        codigo, valor, validade, limite, usos: 0, 
                        validoEntrega: vEntrega, validoRetirada: vRetirada, 
                        criadoEm: new Date() 
                    });
                    window.mostrarNotificacao('Cupom criado!', 'sucesso');
                    window.fecharModal('modal-cupom');
                    document.getElementById('form-cupom').reset();
                } catch(e) { console.error(e); window.mostrarNotificacao('Erro ao criar cupom', 'erro'); }
            };
        }
        window.delCupom = async (id) => { if(confirm('Excluir cupom?')) await deleteDoc(doc(db, 'cupons', id)); };

        // Utils UI
        window.fecharModal = (id) => document.getElementById(id).classList.remove('active');
        document.getElementById('btn-novo-produto').onclick = () => { 
            idEdit = null; 
            document.getElementById('form-produto').reset(); 
            document.getElementById('detalhes-prod').value = ''; 
            document.getElementById('box-estoque').classList.remove('hidden'); 
            document.getElementById('box-promo').classList.add('hidden'); 
            
            document.getElementById('check-bloquear-obs').checked = false;
            document.getElementById('check-mais-vendido').checked = false;
            document.getElementById('box-itens-removiveis').classList.add('hidden');
            document.getElementById('itens-removiveis-prod').value = '';
            
            gruposOpcoesList = [];
            renderGruposOpcoes();

            document.getElementById('modal-produto').classList.add('active'); 
        };
        document.getElementById('btn-nova-categoria').onclick = () => document.getElementById('modal-categoria').classList.add('active');
        document.getElementById('toggle-sidebar').onclick = () => document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('check-promo').onchange = (e) => document.getElementById('box-promo').classList.toggle('hidden', !e.target.checked);

    </script>
</body>
</html>
