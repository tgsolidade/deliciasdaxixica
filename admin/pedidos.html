<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <style>
        /* --- ESTILOS ESPEC√çFICOS --- */
        .pedido-card { background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #ccc; transition: all 0.3s ease; cursor: pointer; position: relative; z-index: 1; }
        .pedido-card.z-index-alto { z-index: 100 !important; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .pedido-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .pedido-card.entregue { opacity: 0.6; border-left-color: #10b981; }
        .pedido-card.recebido { border-left-color: #3b82f6; }
        .pedido-card.em_preparo { border-left-color: #f59e0b; }
        .pedido-card.saiu_entrega { border-left-color: #8b5cf6; }
        .pedido-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .pedido-id { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
        .pedido-status { padding: 0.375rem 0.875rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600; display: inline-block; }
        .status-recebido { background: #dbeafe; color: #1e40af; }
        .status-em_preparo { background: #fef3c7; color: #92400e; }
        .status-saiu_entrega { background: #ede9fe; color: #5b21b6; }
        .status-entregue { background: #d1fae5; color: #065f46; }
        .pedido-info { display: grid; gap: 0.5rem; margin: 1rem 0; }
        .pedido-info p { margin: 0; color: #6b7280; font-size: 0.95rem; }
        .pedido-itens { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .pedido-item { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.9rem; }
        .pedido-total { margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .pedido-total-valor { font-size: 1.5rem; font-weight: 700; color: #FF6B35; }
        .status-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin-top: 0.5rem; padding: 0.5rem; z-index: 1000; display: none; }
        .status-dropdown.active { display: block; animation: slideDown 0.2s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status-option { padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .status-option:hover { background: #f3f4f6; }
        .status-option.current { background: #e0e7ff; font-weight: 600; }
        .toggle-entregues { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; font-weight: 600; color: #6b7280; margin-bottom: 1.5rem; }
        .toggle-entregues.active { background: #FF6B35; color: white; border-color: #FF6B35; }
        .contador-badge { background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.625rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
        .toggle-entregues.active .contador-badge { background: rgba(255,255,255,0.2); color: white; }
        .filtros-status { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .filtro-btn { padding: 0.625rem 1.25rem; border: 2px solid #e5e7eb; background: white; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .filtro-btn.active { background: #FF6B35; color: white; border-color: #FF6B35; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
        .toast { padding: 1rem 1.5rem; border-radius: 8px; color: white; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; }
        .toast-sucesso { background: #10b981; } .toast-erro { background: #ef4444; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .btn-excluir { background: none; border: none; cursor: pointer; font-size: 1.1rem; opacity: 0.4; }
        .btn-excluir:hover { opacity: 1; transform: scale(1.1); }
        
        /* ALERTA DE COBRAN√áA */
        .alerta-cobranca { background: #fff7ed; color: #c2410c; padding: 8px; font-size: 0.9rem; border-radius: 6px; margin-top: 10px; font-weight: bold; border: 1px dashed #f97316; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo"><div style="font-size: 3rem;"></div><h2>Painel ADM</h2></div>
            <nav>
                <ul class="sidebar-menu">
                    <li><a href="index.html"><span class="icon">üìä</span><span>Dashboard</span></a></li>
                    <li><a href="produtos.html"><span class="icon">üçî</span><span>Produtos</span></a></li>
                    <li><a href="pedidos.html" class="active"><span class="icon">üì¶</span><span>Pedidos</span></a></li>
                    <li><a href="configuracoes.html"><span class="icon">‚öôÔ∏è</span><span>Configura√ß√µes</span></a></li>
                    <li style="margin-top: 2rem;"><a href="../public/index.html" target="_blank"><span class="icon">üåê</span><span>Ver Site</span></a></li>
                </ul>
            </nav>
        </aside>
        
        <main class="admin-content">
            <div class="admin-header">
                <div>
                    <h1>üì¶ Gest√£o de Pedidos</h1>
                    <p style="color: var(--cor-texto-secundario); margin: 0;">Gerencie seus pedidos em tempo real</p>
                </div>
                <button class="toggle-sidebar" id="toggle-sidebar" style="display:none">‚ò∞</button>
            </div>

            <div style="margin-bottom: 2rem;">
                <button class="toggle-entregues" id="btn-toggle-entregues">
                    <span id="toggle-icon">üëÅÔ∏è</span>
                    <span id="toggle-text">Mostrar Entregues</span>
                    <span class="contador-badge" id="contador-entregues">0</span>
                </button>

                <div class="filtros-status">
                    <button class="filtro-btn active" data-filtro="todos">üìã Todos <span class="contador-badge" id="count-todos">0</span></button>
                    <button class="filtro-btn" data-filtro="recebido">üîµ Recebido <span class="contador-badge" id="count-recebido">0</span></button>
                    <button class="filtro-btn" data-filtro="em_preparo">üü° Em Preparo <span class="contador-badge" id="count-em_preparo">0</span></button>
                    <button class="filtro-btn" data-filtro="saiu_entrega">üü£ Saiu <span class="contador-badge" id="count-saiu_entrega">0</span></button>
                </div>
            </div>

            <div id="loading-pedidos" class="flex-center" style="padding: 3rem;"><div class="loading" style="width: 50px; height: 50px; border-width: 5px;"></div></div>

            <div id="sem-pedidos" class="text-center hidden" style="padding: 3rem;">
                <p style="font-size: 4rem;">üì≠</p>
                <h3>Nenhum pedido ativo</h3>
                <p style="color: #6b7280;">Os pedidos aparecer√£o aqui em tempo real</p>
            </div>

            <div id="lista-pedidos"></div>
        </main>
    </div>
    
    <div id="toast-container"></div>

    <script type="module">
        import { db, collection, onSnapshot, doc, updateDoc, deleteDoc, query, COLLECTIONS } from '../assets/js/firebase-config.js';

        let todosPedidos = [];
        let mostrarEntregues = false;
        let filtroAtivo = 'todos';
        let dropdownAberto = null;

        const statusNomes = { recebido: 'Recebido', em_preparo: 'Em Preparo', saiu_entrega: 'Saiu para Entrega', entregue: 'Entregue' };
        const statusIcones = { recebido: 'üîµ', em_preparo: 'üü°', saiu_entrega: 'üü£', entregue: '‚úÖ' };

        function formatarPreco(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v); }
        function formatarData(t) { 
            const d = t && t.toDate ? t.toDate() : new Date(); 
            return new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }).format(d);
        }

        document.addEventListener('DOMContentLoaded', () => {
            carregarPedidos();
            inicializarEventos();
            // Responsividade menu
            document.getElementById('toggle-sidebar').onclick = () => document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('toggle-sidebar').style.display = 'block';
        });

        function carregarPedidos() {
            const q = query(collection(db, COLLECTIONS.PEDIDOS));
            onSnapshot(q, (snapshot) => {
                todosPedidos = [];
                snapshot.forEach((docSnap) => {
                    const dados = docSnap.data();
                    todosPedidos.push({ uid_firebase: docSnap.id, id: dados.id || docSnap.id, ...dados });
                });

                todosPedidos.sort((a, b) => {
                    const dA = a.criadoEm && a.criadoEm.toDate ? a.criadoEm.toDate() : new Date(0);
                    const dB = b.criadoEm && b.criadoEm.toDate ? b.criadoEm.toDate() : new Date(0);
                    return dB - dA;
                });

                atualizarContadores();
                renderizarPedidos();
                document.getElementById('loading-pedidos').classList.add('hidden');
                
                if (todosPedidos.length === 0) document.getElementById('sem-pedidos').classList.remove('hidden');
                else document.getElementById('sem-pedidos').classList.add('hidden');
            });
        }

        function renderizarPedidos() {
            const lista = document.getElementById('lista-pedidos');
            lista.innerHTML = '';
            
            let filtrados = todosPedidos.filter(p => {
                if (!mostrarEntregues && p.status === 'entregue') return false;
                if (filtroAtivo !== 'todos' && p.status !== filtroAtivo) return false;
                return true;
            });

            filtrados.forEach(p => lista.appendChild(criarCard(p)));
            
            if (filtrados.length === 0 && todosPedidos.length > 0) {
                lista.innerHTML = '<div style="text-align:center;padding:2rem;color:#777">Nenhum pedido neste filtro</div>';
            }
        }

        function criarCard(p) {
            const card = document.createElement('div');
            card.className = `pedido-card ${p.status}`;
            card.dataset.uid = p.uid_firebase;
            
            // Itens com badge de encomenda
            const itensHtml = p.itens ? p.itens.map(i => {
                let extra = '';
                if(i.sobEncomenda) extra = '<span style="background:#3b82f6; color:white; font-size:0.7rem; padding:1px 4px; border-radius:3px; margin-left:3px;">Enc</span>';
                if(i.encomenda) extra += `<br><small style="color:#1e40af">üìÖ ${i.encomenda.data} ${i.encomenda.hora}</small>`;
                return `
                    <div class="pedido-item">
                        <span>${i.quantidade}x ${i.nome} ${extra}</span>
                        <span>${formatarPreco((i.preco||0)*i.quantidade)}</span>
                    </div>`;
            }).join('') : 'Sem itens';
            
            // ID Display
            const idDisplay = p.idDisplay ? p.idDisplay : `#${p.id}`;

            // Alerta de Cobran√ßa Restante
            let alertaPagamento = '';
            if (p.isEncomenda && p.valorRestante > 0 && p.status !== 'entregue') {
                alertaPagamento = `
                    <div class="alerta-cobranca">
                        ‚ö†Ô∏è Cobrar na Entrega: ${formatarPreco(p.valorRestante)}
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="pedido-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="pedido-id">${idDisplay}</div>
                        <button class="btn-excluir" title="Excluir" onclick="excluirPedido('${p.uid_firebase}')">üóëÔ∏è</button>
                    </div>
                    <span class="pedido-status status-${p.status}">
                        ${statusIcones[p.status]||''} ${statusNomes[p.status]||p.status}
                    </span>
                </div>
                <div class="pedido-info">
                    <p><strong>Cliente:</strong> ${p.cliente?.nome || '?'}</p>
                    <p><strong>Tel:</strong> ${p.cliente?.telefone || '-'}</p>
                    <p><strong>Local:</strong> ${p.tipoEntrega === 'retirada' ? 'üè™ Retirada' : (p.endereco?.rua || p.endereco?.logradouro) + ', ' + (p.endereco?.numero || '') + ' - ' + (p.endereco?.bairro || '')}</p>
                    <p><strong>Data:</strong> ${formatarData(p.criadoEm)}</p>
                    <p><strong>Pagamento:</strong> ${p.pagamento?.forma?.toUpperCase() || '-'} ${p.pagamento?.troco ? '(Troco: '+p.pagamento.troco+')' : ''}</p>
                </div>
                <div class="pedido-itens">${itensHtml}</div>
                <div class="pedido-total">
                    <span>Total Pedido:</span>
                    <span class="pedido-total-valor">${formatarPreco(p.total||0)}</span>
                </div>
                ${alertaPagamento}
                ${criarDropdown(p)}
            `;
            
            card.addEventListener('click', (e) => {
                if(!e.target.closest('.status-option') && !e.target.closest('.btn-excluir')) {
                    toggleDropdown(p.uid_firebase);
                }
            });
            return card;
        }

        function criarDropdown(p) {
            const opcoes = [
                {v:'recebido', n:'Recebido', i:'üîµ'}, {v:'em_preparo', n:'Em Preparo', i:'üü°'},
                {v:'saiu_entrega', n:'Saiu para Entrega', i:'üü£'}, {v:'entregue', n:'Entregue', i:'‚úÖ'}
            ];
            let html = `<div class="status-dropdown" id="dd-${p.uid_firebase}">`;
            opcoes.forEach(op => {
                html += `<div class="status-option ${p.status===op.v?'current':''}" onclick="mudarStatus('${p.uid_firebase}', '${op.v}')">
                        <span class="status-icon">${op.i}</span><span>${op.n}</span>${p.status===op.v ? '<span style="margin-left:auto">‚úì</span>' : ''}
                    </div>`;
            });
            return html + '</div>';
        }

        window.toggleDropdown = (uid) => {
            const dd = document.getElementById('dd-'+uid);
            if(!dd) return;
            if(dropdownAberto && dropdownAberto !== uid) {
                const outro = document.getElementById('dd-'+dropdownAberto);
                if(outro) { outro.classList.remove('active'); outro.closest('.pedido-card').classList.remove('z-index-alto'); }
            }
            dd.classList.toggle('active');
            const card = dd.closest('.pedido-card');
            if(dd.classList.contains('active')) { dropdownAberto = uid; card.classList.add('z-index-alto'); } 
            else { dropdownAberto = null; card.classList.remove('z-index-alto'); }
        };

        window.mudarStatus = async (uid_firebase, novoStatus) => {
            try {
                const docRef = doc(db, COLLECTIONS.PEDIDOS, uid_firebase);
                
                // Objeto de update b√°sico
                let updateData = { status: novoStatus, atualizadoEm: new Date() };

                // LOGICA FINANCEIRA: Se virou ENTREGUE, marca a data para o faturamento contar o restante
                if (novoStatus === 'entregue') {
                    updateData.dataEntregaRealizada = new Date(); // <--- IMPORTANTE
                    updateData.saldoDevedor = false; // Considera pago
                }

                await updateDoc(docRef, updateData);
                mostrarToast('‚úÖ Status atualizado!', 'sucesso');
                window.toggleDropdown(uid_firebase);
            } catch (error) {
                console.error(error);
                mostrarToast('‚ùå Erro: ' + error.message, 'erro');
            }
        };

        window.excluirPedido = async (uid_firebase) => {
            if(confirm('Tem certeza que deseja excluir este pedido permanentemente?')) {
                try {
                    await deleteDoc(doc(db, COLLECTIONS.PEDIDOS, uid_firebase));
                    mostrarToast('üóëÔ∏è Pedido exclu√≠do!', 'sucesso');
                } catch (error) { mostrarToast('‚ùå Erro ao excluir', 'erro'); }
            }
        };

        function inicializarEventos() {
            document.getElementById('btn-toggle-entregues').addEventListener('click', () => {
                mostrarEntregues = !mostrarEntregues;
                const btn = document.getElementById('btn-toggle-entregues');
                const txt = document.getElementById('toggle-text');
                if(mostrarEntregues) { btn.classList.add('active'); txt.textContent = 'Ocultar Entregues'; } 
                else { btn.classList.remove('active'); txt.textContent = 'Mostrar Entregues'; }
                renderizarPedidos();
            });

            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.filtro-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    filtroAtivo = e.currentTarget.dataset.filtro;
                    renderizarPedidos();
                });
            });

            document.addEventListener('click', (e) => {
                if(!e.target.closest('.pedido-card') && dropdownAberto) window.toggleDropdown(dropdownAberto);
            });
        }

        function atualizarContadores() {
            const c = { todos: todosPedidos.length, recebido:0, em_preparo:0, saiu_entrega:0, entregue:0 };
            todosPedidos.forEach(p => { if(c[p.status]!==undefined) c[p.status]++; });
            
            document.getElementById('count-todos').textContent = c.todos;
            document.getElementById('count-recebido').textContent = c.recebido;
            document.getElementById('count-em_preparo').textContent = c.em_preparo;
            document.getElementById('count-saiu_entrega').textContent = c.saiu_entrega;
            document.getElementById('contador-entregues').textContent = c.entregue;
        }

        function mostrarToast(msg, tipo) {
            const div = document.createElement('div');
            div.className = `toast toast-${tipo}`; div.textContent = msg;
            document.getElementById('toast-container').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>