<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card√°pio Online</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../assets/css/style.css">
    
    <style>
        /* =========================================
           LAYOUT E GERAL
           ========================================= */
        body { background-color: #f3f4f6; padding-bottom: 50px; }

        /* Status da Loja (Topo) */
        .status-badge {
            padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; 
            display: inline-flex; align-items: center; gap: 5px;
        }
        .status-aberta { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status-fechada { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* Menu de Categorias (Horizontal) */
        .categoria-nav { 
            position: sticky; top: 70px; z-index: 80; background: #f3f4f6; 
            padding: 15px 0; overflow-x: auto; white-space: nowrap; 
            border-bottom: 1px solid #e5e7eb; margin-bottom: 20px; 
        }
        .categoria-lista { display: flex; gap: 10px; padding: 0 15px; list-style: none; }
        .cat-btn { 
            padding: 10px 20px; border-radius: 25px; background: white; 
            border: 1px solid #ddd; color: #444; font-weight: 600; cursor: pointer; 
            transition: 0.2s; text-decoration: none; font-size: 0.95rem; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .cat-btn.active { 
            background: var(--cor-primaria); color: white; border-color: var(--cor-primaria); 
            transform: scale(1.05); 
        }

        /* Bot√£o de Rastreio (Topo) */
        .btn-rastreio { 
            background: white; color: var(--cor-primaria); border: 2px solid var(--cor-primaria); 
            padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; 
            cursor: pointer; display: flex; align-items: center; gap: 5px; transition: 0.2s; 
        }
        .btn-rastreio:hover { background: var(--cor-primaria); color: white; }

        /* Se√ß√µes do Card√°pio */
        .secao-categoria { margin-bottom: 3rem; scroll-margin-top: 160px; }
        .secao-titulo { 
            font-size: 1.6rem; font-weight: 800; margin-bottom: 1.5rem; 
            padding-left: 15px; border-left: 5px solid var(--cor-primaria); color: #1f2937; 
        }

        /* =========================================
           CARDS DE PRODUTOS (CORRIGIDO)
           ========================================= */
        .produtos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* Mobile */
            gap: 15px;
            align-items: stretch; /* Garante altura igual */
        }
        
        @media(min-width: 600px) {
            .produtos-grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; }
        }

        .produto-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
            display: flex;           /* Flexbox vertical */
            flex-direction: column;  
            height: 100%;            
            border: 1px solid #f0f0f0;
        }
        .produto-card:active { transform: scale(0.98); }

        .produto-imagem {
            width: 100%; height: 160px; object-fit: cover;
            border-bottom: 1px solid #f0f0f0;
        }

        .produto-info {
            padding: 1rem;
            display: flex; flex-direction: column;
            flex-grow: 1; /* Empurra o rodap√© para baixo */
        }

        .produto-titulo {
            font-size: 1rem; font-weight: 700; color: #1f2937;
            margin-bottom: 0.5rem; line-height: 1.3;
        }

        .produto-descricao {
            font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem;
            line-height: 1.4;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }

        .produto-footer {
            margin-top: auto; /* Fixa no fundo */
            display: flex; justify-content: space-between; align-items: center;
            padding-top: 10px; border-top: 1px solid #f9fafb;
        }

        /* Pre√ßos e Badges */
        .produto-preco { font-size: 1.2rem; font-weight: 800; color: #1f2937; }
        .preco-antigo { text-decoration: line-through; color: #9ca3af; font-size: 0.8rem; margin-right: 5px; display: block; }
        .preco-novo { color: #dc2626; font-weight: 800; font-size: 1.3rem; }
        
        .badge-encomenda { 
            position: absolute; top: 10px; right: 10px; background: #2563eb; 
            color: white; padding: 4px 10px; border-radius: 6px; 
            font-size: 0.75rem; font-weight: 700; z-index: 10; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }

        /* Bot√£o Pequeno (+) */
        .btn-sm {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; padding: 0;
            box-shadow: 0 4px 10px rgba(230, 57, 70, 0.2);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <img id="logo-img" src="" style="width: 120px; height: 120px; border-radius: 50%; display: none;">
                <div id="logo-icon" class="logo-icon">üçï</div>
                <span id="nome-restaurante">Carregando...</span>
            </a>
            
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn-rastreio" onclick="abrirRastreio()">üõµ Pedidos</button>
                <a href="#" class="carrinho-btn" onclick="abrirCarrinho(event)">
                    <span>üõí</span>
                    <span class="carrinho-badge" id="carrinho-count">0</span>
                </a>
            </div>
        </div>
    </header>

    <div style="padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom: 1px solid #eee;">
        <span id="status-loja" class="status-badge status-fechada">‚óè Verificando...</span>
        <span style="font-size: 0.85rem; color: #666;" id="tempo-entrega">üïí -- min</span>
    </div>

    <nav class="categoria-nav">
        <ul class="categoria-lista" id="nav-categorias"></ul>
    </nav>

    <section class="hero" style="margin-top: 0;">
        <h1 id="slogan-texto">...</h1>
    </section>

    <main class="container">
        <div id="loading" class="flex-center" style="padding: 3rem;"><div class="loading"></div></div>
        
        <div id="catalogo"></div>
        
        <div id="sem-produtos" class="hidden" style="text-align: center; padding: 3rem; color: #666;">
            <h3>Nenhum produto encontrado.</h3>
            <p>Aguarde o estabelecimento cadastrar o card√°pio.</p>
        </div>
    </main>

    <div class="modal-overlay" id="modal-produto">
        <div class="modal">
            <div class="modal-header"><h2 id="m-titulo">...</h2><button class="modal-close" onclick="fecharModal('modal-produto')">√ó</button></div>
            
            <img id="m-img" src="" style="width: 100%; height: 250px; object-fit: cover; border-radius: 12px; margin-bottom: 15px;">
            
            <p id="m-desc" style="color: #666; margin-bottom: 15px; line-height: 1.6;"></p>
            
            <!-- Badge de Encomenda (se aplic√°vel) -->
            <div id="badge-encomenda-modal" class="hidden" style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-size: 1.2rem;">‚è≥</span>
                    <strong style="color: #1e40af;">Produto sob Encomenda</strong>
                </div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.95rem;">
                    <input type="checkbox" id="check-solicitar-encomenda" style="width: 18px; height: 18px; cursor: pointer;">
                    <span>Quero agendar data e hora de retirada/entrega</span>
                </label>
            </div>

            <!-- Campos de Agendamento (aparecem quando marcar checkbox) -->
            <div id="box-agendamento" class="hidden" style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <h4 style="margin-bottom: 12px; color: #1e40af; font-size: 0.95rem;">üìÖ Quando voc√™ deseja receber?</h4>
                <div style="display: grid; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">Data:</label>
                        <input type="date" id="data-encomenda" class="form-input" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">Hor√°rio:</label>
                        <input type="time" id="hora-encomenda" class="form-input" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #666;">Observa√ß√µes da encomenda (opcional):</label>
                        <textarea id="obs-encomenda" class="form-textarea" placeholder="Ex: Quero com recheio extra, decora√ß√£o especial..." rows="2"></textarea>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 8px;">
                <span style="font-weight: 600;">Pre√ßo Unit√°rio:</span>
                <div id="m-preco-display"></div>
            </div>

            <div class="form-group">
                <label>Observa√ß√µes do produto:</label>
                <textarea id="m-obs" class="form-textarea" placeholder="Ex: Sem cebola, ponto da carne..." rows="2"></textarea>
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
                <div style="display: flex; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                    <button onclick="mudarQtd(-1)" style="padding: 12px 18px; background: #f9fafb; border: none; font-size: 1.2rem; cursor: pointer;">-</button>
                    <input type="number" id="m-qtd" value="1" readonly style="width: 50px; text-align: center; border: none; font-weight: bold; font-size: 1.1rem;">
                    <button onclick="mudarQtd(1)" style="padding: 12px 18px; background: #f9fafb; border: none; font-size: 1.2rem; cursor: pointer;">+</button>
                </div>
                <button class="btn btn-primario" id="btn-add-carrinho" style="flex: 1; padding: 14px; font-size: 1.1rem;">Adicionar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-carrinho">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header"><h2>üõí Seu Carrinho</h2><button class="modal-close" onclick="fecharModal('modal-carrinho')">√ó</button></div>
            
            <div id="lista-carrinho" style="max-height: 60vh; overflow-y: auto;"></div>
            
            <div id="carrinho-vazio" class="hidden" style="text-align:center; padding: 30px; color: #888;">
                <p style="font-size: 2rem;">üò¢</p>
                <p>Seu carrinho est√° vazio.</p>
            </div>
            
            <div id="carrinho-footer" class="hidden" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <div style="display: flex; justify-content: space-between; font-weight: 800; font-size: 1.3rem; margin-bottom: 20px; color: var(--cor-primaria);">
                    <span>Total:</span> <span id="total-carrinho">R$ 0,00</span>
                </div>
                <button class="btn btn-primario" onclick="window.location.href='checkout.html'" style="width: 100%; padding: 15px; font-size: 1.1rem;">‚úÖ Finalizar Pedido</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-rastreio">
        <div class="modal">
            <div class="modal-header"><h2>üõµ Meus Pedidos</h2><button class="modal-close" onclick="fecharModal('modal-rastreio')">√ó</button></div>
            <div id="lista-pedidos-rastreio" style="max-height: 60vh; overflow-y: auto;">
                <p style="color: #666; text-align: center; padding: 20px;">Carregando...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, collection, getDocs, onSnapshot, query, orderBy, formatarPreco, mostrarNotificacao, COLLECTIONS, getDoc, doc } from '../assets/js/firebase-config.js';

        // ESTADO
        let lojaConfig = { lojaAberta: false };
        let listaCategorias = [];
        let listaProdutos = [];
        let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
        let produtoSel = null;

        // EVENTO: Checkbox de solicitar encomenda
        document.addEventListener('DOMContentLoaded', () => {
            const checkEncomenda = document.getElementById('check-solicitar-encomenda');
            const boxAgendamento = document.getElementById('box-agendamento');
            
            checkEncomenda.addEventListener('change', (e) => {
                if(e.target.checked) {
                    boxAgendamento.classList.remove('hidden');
                    // Define data m√≠nima como amanh√£
                    const amanha = new Date();
                    amanha.setDate(amanha.getDate() + 1);
                    document.getElementById('data-encomenda').min = amanha.toISOString().split('T')[0];
                } else {
                    boxAgendamento.classList.add('hidden');
                }
            });
        });

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', () => {
            carregarConfig();
            iniciarListeners();
            atualizarBadge();
        });

        // 1. CONFIGURA√á√ïES DA LOJA
        function carregarConfig() {
            onSnapshot(collection(db, COLLECTIONS.CONFIGURACOES), (snap) => {
                if(!snap.empty) {
                    lojaConfig = snap.docs[0].data();
                    atualizarInterfaceConfig();
                    renderizarLoja(); // Redesenha para atualizar status dos bot√µes
                }
            });
        }

        function atualizarInterfaceConfig() {
            if(lojaConfig.nome) document.getElementById('nome-restaurante').textContent = lojaConfig.nome;
            if(lojaConfig.slogan) document.getElementById('slogan-texto').textContent = lojaConfig.slogan;
            if(lojaConfig.tempoEntrega) document.getElementById('tempo-entrega').textContent = `üïí ${lojaConfig.tempoEntrega}`;
            
            if(lojaConfig.logoUrl) {
                document.getElementById('logo-icon').style.display = 'none';
                const img = document.getElementById('logo-img');
                img.src = lojaConfig.logoUrl; img.style.display = 'block';
            }

            const badge = document.getElementById('status-loja');
            if(lojaConfig.lojaAberta) {
                badge.className = 'status-badge status-aberta';
                badge.textContent = '‚óè Aberta';
            } else {
                badge.className = 'status-badge status-fechada';
                badge.textContent = '‚óè Fechada';
            }
        }

        // 2. BUSCA DADOS REAIS (LISTENERS)
        function iniciarListeners() {
            // Categorias
            onSnapshot(query(collection(db, 'categorias'), orderBy('nome')), (snap) => {
                listaCategorias = [];
                snap.forEach(d => listaCategorias.push(d.data()));
                renderizarLoja();
            });

            // Produtos
            onSnapshot(query(collection(db, COLLECTIONS.PRODUTOS), orderBy('nome')), (snap) => {
                listaProdutos = [];
                snap.forEach(d => listaProdutos.push({id: d.id, ...d.data()}));
                renderizarLoja();
            });
        }

        // 3. RENDERIZADOR (IMPEDE DUPLICA√á√ÉO)
        function renderizarLoja() {
            const nav = document.getElementById('nav-categorias');
            const catalogo = document.getElementById('catalogo');
            
            // LIMPA TUDO ANTES
            nav.innerHTML = '';
            catalogo.innerHTML = '';
            document.getElementById('loading').classList.add('hidden');

            if(listaProdutos.length === 0) {
                document.getElementById('sem-produtos').classList.remove('hidden');
                return;
            }
            document.getElementById('sem-produtos').classList.add('hidden');

            // Filtra categorias ativas
            const categoriasAtivas = listaCategorias.filter(cat => 
                listaProdutos.some(p => p.categoria === cat.slug)
            );

            // Cria Menu
            categoriasAtivas.forEach(cat => {
                nav.innerHTML += `<li><a href="#cat-${cat.slug}" class="cat-btn">${cat.nome}</a></li>`;
            });

            // Cria Se√ß√µes
            categoriasAtivas.forEach(cat => {
                const prodsDaCat = listaProdutos.filter(p => p.categoria === cat.slug);
                if (prodsDaCat.length > 0) {
                    const section = document.createElement('section');
                    section.id = `cat-${cat.slug}`;
                    section.className = 'secao-categoria';
                    section.innerHTML = `<h2 class="secao-titulo">${cat.nome}</h2><div class="produtos-grid"></div>`;
                    
                    const grid = section.querySelector('.produtos-grid');
                    prodsDaCat.forEach(p => grid.appendChild(criarCard(p)));
                    
                    catalogo.appendChild(section);
                }
            });
        }

        function criarCard(p) {
            const card = document.createElement('div');
            card.className = 'produto-card fade-in';
            card.onclick = () => abrirModalProduto(p);

            // L√≥gica Pre√ßo e Promo√ß√£o
            let precoHtml = `<span class="produto-preco">${formatarPreco(p.preco)}</span>`;
            if(p.emPromocao && p.precoPromocional) {
                precoHtml = `<span class="preco-antigo">${formatarPreco(p.preco)}</span> <span class="preco-novo">${formatarPreco(p.precoPromocional)}</span>`;
            }

            // Badge Encomenda
            let encomendaBadge = p.sobEncomenda ? '<span class="badge-encomenda">‚è≥ Encomenda</span>' : '';

            // Bloqueio
            const podeComprar = lojaConfig.lojaAberta || p.sobEncomenda;
            let btnClass = podeComprar ? 'btn-primario' : 'btn-outline';
            let btnText = podeComprar ? '‚ûï' : 'üîí';
            let cardOpacity = podeComprar ? '1' : '0.7';

            card.style.opacity = cardOpacity;
            card.innerHTML = `
                ${encomendaBadge}
                <img src="${p.imagemUrl}" class="produto-imagem" onerror="this.src='https://via.placeholder.com/300x200?text=Sem+Imagem'">
                <div class="produto-info">
                    <h3 class="produto-titulo">${p.nome}</h3>
                    <p class="produto-descricao">${p.descricao || ''}</p>
                    <div class="produto-footer">
                        <div>${precoHtml}</div>
                        <button class="btn ${btnClass} btn-sm">${btnText}</button>
                    </div>
                </div>
            `;
            return card;
        }

        // --- L√ìGICA MODAL ---
        window.abrirModalProduto = (p) => {
            const podeComprar = lojaConfig.lojaAberta || p.sobEncomenda;
            if(!podeComprar) {
                mostrarNotificacao('Loja fechada! Apenas itens sob encomenda.', 'erro');
                return;
            }

            produtoSel = p;
            document.getElementById('m-titulo').textContent = p.nome;
            document.getElementById('m-desc').textContent = p.descricao || '';
            document.getElementById('m-img').src = p.imagemUrl;
            document.getElementById('m-qtd').value = 1;
            document.getElementById('m-obs').value = '';
            
            // Limpa campos de encomenda
            document.getElementById('check-solicitar-encomenda').checked = false;
            document.getElementById('data-encomenda').value = '';
            document.getElementById('hora-encomenda').value = '';
            document.getElementById('obs-encomenda').value = '';
            document.getElementById('box-agendamento').classList.add('hidden');
            
            // Mostra/esconde op√ß√£o de encomenda baseado no produto
            if(p.sobEncomenda) {
                document.getElementById('badge-encomenda-modal').classList.remove('hidden');
            } else {
                document.getElementById('badge-encomenda-modal').classList.add('hidden');
            }

            const divPreco = document.getElementById('m-preco-display');
            if(p.emPromocao && p.precoPromocional) {
                divPreco.innerHTML = `<span class="preco-antigo">${formatarPreco(p.preco)}</span> <span class="preco-novo" style="font-size:1.4rem">${formatarPreco(p.precoPromocional)}</span>`;
            } else {
                divPreco.innerHTML = `<span class="produto-preco" style="font-size:1.4rem">${formatarPreco(p.preco)}</span>`;
            }

            document.getElementById('modal-produto').classList.add('active');
        };

        document.getElementById('btn-add-carrinho').onclick = () => {
            if(!produtoSel) return;
            
            const qtd = parseInt(document.getElementById('m-qtd').value);
            const obs = document.getElementById('m-obs').value;
            const precoFinal = (produtoSel.emPromocao && produtoSel.precoPromocional) ? produtoSel.precoPromocional : produtoSel.preco;
            
            // Verifica se √© encomenda e se foi agendada
            const isEncomendaSolicitada = document.getElementById('check-solicitar-encomenda').checked;
            let dadosEncomenda = null;
            
            if(isEncomendaSolicitada) {
                const dataEnc = document.getElementById('data-encomenda').value;
                const horaEnc = document.getElementById('hora-encomenda').value;
                const obsEnc = document.getElementById('obs-encomenda').value;
                
                // Valida√ß√£o
                if(!dataEnc || !horaEnc) {
                    mostrarNotificacao('Preencha a data e hora para a encomenda!', 'erro');
                    return;
                }
                
                dadosEncomenda = {
                    data: dataEnc,
                    hora: horaEnc,
                    observacoes: obsEnc
                };
            }

            carrinho.push({
                id: produtoSel.id,
                nome: produtoSel.nome,
                preco: precoFinal,
                imagemUrl: produtoSel.imagemUrl,
                quantidade: qtd,
                observacoes: obs,
                sobEncomenda: produtoSel.sobEncomenda || false,
                encomenda: dadosEncomenda // null se n√£o for agendada, ou objeto com data/hora
            });

            localStorage.setItem('carrinho', JSON.stringify(carrinho));
            atualizarBadge();
            mostrarNotificacao('Produto adicionado!', 'sucesso');
            fecharModal('modal-produto');
        };

        // --- CARRINHO ---
        window.abrirCarrinho = (e) => {
            e.preventDefault();
            const div = document.getElementById('lista-carrinho');
            div.innerHTML = '';
            
            if(carrinho.length === 0) {
                document.getElementById('carrinho-vazio').classList.remove('hidden');
                document.getElementById('carrinho-footer').classList.add('hidden');
            } else {
                document.getElementById('carrinho-vazio').classList.add('hidden');
                document.getElementById('carrinho-footer').classList.remove('hidden');
                
                let total = 0;
                carrinho.forEach((item, idx) => {
                    total += item.preco * item.quantidade;
                    
                    // Monta informa√ß√µes de encomenda se existir
                    let infoEncomenda = '';
                    if(item.encomenda) {
                        const dataFormatada = new Date(item.encomenda.data + 'T00:00:00').toLocaleDateString('pt-BR');
                        infoEncomenda = `<br><small style="background:#dbeafe; color:#1e40af; padding:4px 8px; border-radius:4px; display:inline-block; margin-top:4px;">
                            üìÖ Agendado: ${dataFormatada} √†s ${item.encomenda.hora}
                        </small>`;
                        if(item.encomenda.observacoes) {
                            infoEncomenda += `<br><small style="color:#666; font-style:italic;">Obs encomenda: "${item.encomenda.observacoes}"</small>`;
                        }
                    }
                    
                    div.innerHTML += `
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:15px 0;">
                            <div style="flex:1">
                                <strong style="font-size:1rem;">${item.quantidade}x ${item.nome}</strong>
                                ${item.sobEncomenda ? ' <span style="background:#3b82f6; color:white; font-size:0.7rem; padding:2px 6px; border-radius:4px;">ENCOMENDA</span>' : ''}
                                <br><span style="color:var(--cor-primaria); font-weight:700;">${formatarPreco(item.preco * item.quantidade)}</span>
                                ${item.observacoes ? `<br><small style="color:#888; font-style:italic;">"${item.observacoes}"</small>` : ''}
                                ${infoEncomenda}
                            </div>
                            <button onclick="window.removerItem(${idx})" class="btn-outline" style="padding:8px 12px;">üóëÔ∏è</button>
                        </div>
                    `;
                });
                document.getElementById('total-carrinho').textContent = formatarPreco(total);
            }
            document.getElementById('modal-carrinho').classList.add('active');
        };

        window.removerItem = (idx) => {
            carrinho.splice(idx, 1);
            localStorage.setItem('carrinho', JSON.stringify(carrinho));
            atualizarBadge();
            // Reabre para atualizar visual
            document.getElementById('modal-carrinho').classList.remove('active');
            setTimeout(() => document.querySelector('.carrinho-btn').click(), 50);
        };

        // --- RASTREIO ---
        window.abrirRastreio = async () => {
            document.getElementById('modal-rastreio').classList.add('active');
            const lista = document.getElementById('lista-pedidos-rastreio');
            const meusPedidos = JSON.parse(localStorage.getItem('meus_pedidos_ids')) || [];
            
            if(meusPedidos.length === 0) {
                lista.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">Voc√™ ainda n√£o fez pedidos neste dispositivo.</p>';
                return;
            }

            lista.innerHTML = '<div class="loading" style="margin:20px auto"></div>';
            
            let html = '';
            const ultimos = meusPedidos.slice(-5).reverse(); // Pega os 5 √∫ltimos
            
            for(const pid of ultimos) {
                try {
                    const docRef = await getDoc(doc(db, COLLECTIONS.PEDIDOS, pid));
                    if(docRef.exists()) {
                        const p = docRef.data();
                        const statusColor = p.status === 'entregue' ? 'color:#10b981' : 'color:#f59e0b';
                        const hora = p.criadoEm ? p.criadoEm.toDate().toLocaleTimeString().slice(0,5) : '--:--';
                        
                        // ID Visual (se existir idDisplay usa, sen√£o usa ID do doc)
                        const idVis = p.idDisplay ? p.idDisplay : (p.id ? '#' + p.id : '...');

                        html += `
                            <div style="background:#f9fafb; padding:15px; border-radius:12px; margin-bottom:12px; border:1px solid #eee;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                    <strong>Pedido ${idVis}</strong>
                                    <span style="${statusColor}; font-weight:800; font-size:0.85rem; text-transform:uppercase;">${p.status.replace('_',' ')}</span>
                                </div>
                                <div style="font-size:0.9rem; color:#666; display:flex; justify-content:space-between;">
                                    <span>${hora}</span>
                                    <span>${formatarPreco(p.total)}</span>
                                </div>
                            </div>
                        `;
                    }
                } catch(e) { console.log("Erro rastreio:", e); }
            }
            lista.innerHTML = html || '<p style="text-align:center">Nenhum pedido encontrado.</p>';
        };

        // AUXILIARES
        function atualizarBadge() { document.getElementById('carrinho-count').textContent = carrinho.reduce((a,b)=>a+b.quantidade,0); }
        window.mudarQtd = (v) => { const el = document.getElementById('m-qtd'); let n = parseInt(el.value) + v; if(n>=1) el.value = n; };
        window.fecharModal = (id) => document.getElementById(id).classList.remove('active');
        
        // Scroll Suave Menu
        document.addEventListener('click', e => {
            if(e.target.classList.contains('cat-btn')) {
                e.preventDefault();
                const target = document.querySelector(e.target.getAttribute('href'));
                if(target) window.scrollTo({ top: target.offsetTop - 160, behavior: 'smooth' });
            }
        });
    </script>
</body>
</html>