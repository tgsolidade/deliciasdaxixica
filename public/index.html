<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card√°pio Online</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        /* --- SISTEMA SPA --- */
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- GERAL --- */
        body { background-color: #f3f4f6; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        
        /* Cabe√ßalho */
        .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; display: inline-flex; align-items: center; gap: 5px; }
        .status-aberta { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status-fechada { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

        /* --- LAYOUT GRID --- */
        .layout-grid { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .sidebar-desktop { display: none; }

        @media (min-width: 1024px) {
            .layout-grid { display: grid; grid-template-columns: 1fr 380px; gap: 30px; align-items: start; padding-top: 20px; }
            .sidebar-desktop { display: block; background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; border: 1px solid #e5e7eb; }
            .btn-flutuante { display: none !important; }
            .produtos-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important; }
            .whats-float { bottom: 20px !important; }
        }

        /* --- COMPONENTES --- */
        .categoria-nav { position: sticky; top: 0; z-index: 80; background: #f3f4f6; padding: 10px 0; overflow-x: auto; white-space: nowrap; margin-bottom: 10px; }
        .categoria-lista { display: flex; gap: 10px; padding: 0 5px; list-style: none; }
        .cat-btn { padding: 8px 16px; border-radius: 20px; background: white; border: 1px solid #e5e7eb; color: #4b5563; font-weight: 600; font-size: 0.9rem; transition: 0.2s; white-space: nowrap; cursor: pointer; }
        .cat-btn.active { background: var(--cor-primaria); color: white; border-color: var(--cor-primaria); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .secao-categoria { margin-bottom: 2rem; scroll-margin-top: 80px; }
        .secao-titulo { font-size: 1.4rem; font-weight: 800; margin: 0 0 1rem 0; color: #1f2937; border-left: 4px solid var(--cor-primaria); padding-left: 10px; }
        .produtos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }

        .produto-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.1s; position: relative; display: flex; flex-direction: column; height: 100%; cursor: pointer; }
        .produto-card:active { transform: scale(0.98); }
        .produto-imagem { width: 100%; height: 140px; object-fit: cover; background: #eee; }
        .produto-info { padding: 12px; display: flex; flex-direction: column; flex-grow: 1; }
        .produto-titulo { font-size: 0.95rem; font-weight: 700; color: #1f2937; margin-bottom: 5px; line-height: 1.3; }
        .produto-descricao { font-size: 0.8rem; color: #6b7280; margin-bottom: 10px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1; }
        .produto-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .produto-preco { font-weight: 800; color: #1f2937; font-size: 1.1rem; }
        .preco-antigo { text-decoration: line-through; color: #9ca3af; font-size: 0.8rem; margin-right: 5px; }
        .preco-novo { color: #dc2626; }
        .btn-add { width: 32px; height: 32px; border-radius: 50%; background: var(--cor-primaria); color: white; border: none; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .badge-encomenda { position: absolute; top: 8px; right: 8px; background: #2563eb; color: white; font-size: 0.7rem; font-weight: 700; padding: 3px 8px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; }
        .badge-destaque { position: absolute; top: 8px; left: 8px; background: #ea580c; color: white; font-size: 0.7rem; font-weight: 800; padding: 3px 8px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10; }
        
        .tag-esgotado { color: #ef4444; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-top: -5px; margin-bottom: 5px; display: block; }
        .badge-estoque { font-size: 0.75rem; color: #6b7280; font-weight: 600; margin-top: -5px; margin-bottom: 5px; display: block; }
        .badge-estoque.baixo { color: #ea580c; font-weight: 700; }

        /* --- CHECKOUT --- */
        .checkout-container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .checkout-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .entrega-switch { display: flex; gap: 10px; margin-bottom: 15px; }
        .entrega-option { flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 600; color: #6b7280; transition: 0.2s; }
        .entrega-option.selected { border-color: var(--cor-primaria); background: #fff0ed; color: var(--cor-primaria); }
        .pagamento-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .pagamento-option { border: 2px solid #e5e7eb; border-radius: 10px; padding: 15px 5px; text-align: center; cursor: pointer; }
        .pagamento-option.selected { border-color: var(--cor-primaria); background: #fff0ed; color: var(--cor-primaria); font-weight: 700; }
        
        .resumo-linha { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: #4b5563; }
        .resumo-desconto { color: #16a34a; font-size: 0.9rem; }
        .resumo-total { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #e5e7eb; font-weight: 900; font-size: 1.4rem; color: #1f2937; }

        .btn-flutuante { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: var(--cor-primaria); color: white; padding: 15px; border-radius: 50px; text-align: center; font-weight: 700; font-size: 1.1rem; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; transition: transform 0.2s; cursor: pointer; }
        .btn-flutuante:active { transform: translateX(-50%) scale(0.95); }

        .whats-float { position: fixed; bottom: 90px; right: 20px; width: 55px; height: 55px; background: #25D366; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 99; transition: transform 0.2s; }
        .whats-float:hover { transform: scale(1.1); }
        .whats-float img { width: 35px; height: 35px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99999; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; animation: slideUp 0.3s ease-out; max-height: 90vh; overflow-y: auto; }
        @media(min-width: 768px) { .modal { border-radius: 16px; align-self: center; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .btn-novo-end { background: none; border: 1px solid #ddd; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; color: #666; cursor: pointer; float: right; }
        
        .cupom-box { display: flex; gap: 8px; margin-bottom: 10px; }
        .cupom-box input { flex: 1; text-transform: uppercase; }
        .cupom-msg { font-size: 0.85rem; margin-bottom: 15px; font-weight: 600; }
        .cupom-msg.sucesso { color: #16a34a; }
        .cupom-msg.erro { color: #ef4444; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 99999; }
        .toast { background: #333; color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; animation: fadeIn 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .toast.sucesso { background: #10b981; } .toast.erro { background: #ef4444; }
    </style>
</head>
<body>
    
    <header class="header">
        <div class="header-container">
            <a href="#" onclick="trocarTela('cardapio')" class="logo">
                <img id="logo-img" src="" style="width: 40px; height: 40px; border-radius: 50%; display: none; margin-right: 10px;" onerror="this.style.display='none'; document.getElementById('logo-text').style.display='inline';">
                <span id="logo-text" style="font-size: 1.5rem;">üçï</span>
                <span id="nome-restaurante" style="font-weight: 700; font-size: 1.1rem;">Carregando...</span>
            </a>
            <button onclick="abrirRastreio()" style="background:white; color:var(--cor-primaria); border:1px solid var(--cor-primaria); padding:6px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px;">
                <span>üõµ</span> Acompanhar Pedido
            </button>
        </div>
    </header>

    <div style="background: white; padding: 10px 15px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
        <span id="status-loja" class="status-badge status-fechada">‚óè Verificando...</span>
        <span id="tempo-entrega" style="color: #6b7280;">üïí -- min</span>
    </div>

    <div id="view-cardapio" class="view-section active">
        <div class="layout-grid">
            <div class="coluna-produtos">
                <nav class="categoria-nav"><ul class="categoria-lista" id="nav-categorias"></ul></nav>
                <div style="margin-bottom: 15px;"><p id="slogan-texto" style="color: #6b7280; font-size: 0.9rem;"></p></div>
                <main>
                    <div id="loading" style="text-align: center; padding: 40px;"><div class="loading"></div></div>
                    <div id="catalogo"></div>
                    <div id="sem-produtos" class="hidden" style="text-align: center; padding: 50px 20px; color: #9ca3af;"><h3>Card√°pio em atualiza√ß√£o</h3></div>
                </main>
            </div>
            
            <aside class="sidebar-desktop">
                <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h3 style="font-size: 1.2rem; color: #1f2937;">üõí Seu Pedido</h3>
                </div>
                <div id="lista-carrinho-desktop">
                    <p style="text-align: center; color: #9ca3af; padding: 20px;">Seu carrinho est√° vazio üò¢</p>
                </div>
                <div id="footer-carrinho-desktop" class="hidden" style="margin-top: 20px; border-top: 2px dashed #eee; padding-top: 15px;">
                    <div class="resumo-linha"><span>Subtotal (Itens)</span><span id="dsk-subtotal">R$ 0,00</span></div>
                    <div class="resumo-linha resumo-desconto" id="dsk-box-desc"><span>Descontos</span><span id="dsk-desconto">- R$ 0,00</span></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: 800; font-size: 1.3rem; color: #374151; margin-top:10px;">
                        <span>Total:</span> <span id="total-carrinho-desktop">R$ 0,00</span>
                    </div>
                    <button onclick="irParaCheckout()" class="btn btn-primario" style="width: 100%;">Finalizar Compra</button>
                </div>
            </aside>
        </div>
    </div>

    <div id="view-checkout" class="view-section">
        <div class="checkout-container">
            <h2 style="margin-bottom: 15px;">Finalizar Pedido</h2>
            
            <div class="checkout-card">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">üìç Entrega</h3>
                <div class="entrega-switch">
                    <div class="entrega-option selected" id="opt-entrega" onclick="mudarEntrega('entrega')">üõµ Entrega</div>
                    <div class="entrega-option" id="opt-retirada" onclick="mudarEntrega('retirada')">üè™ Retirada</div>
                </div>
                
                <div id="box-endereco">
                    <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.85rem; color:#666;">Endere√ßo de entrega:</span>
                        <button type="button" class="btn-novo-end" onclick="limparEndereco()">üìù Novo Endere√ßo</button>
                    </div>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="cep" class="form-input" placeholder="CEP" onblur="buscarCep(this.value)" style="width: 100px;">
                            <input type="text" id="endereco" class="form-input" placeholder="Rua" style="flex:1">
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="numero" class="form-input" placeholder="N¬∫" style="width: 70px;">
                            <input type="text" id="bairro" class="form-input" placeholder="Bairro" style="flex:1">
                        </div>
                        <input type="text" id="cidade" class="form-input" placeholder="Cidade">
                        <input type="text" id="complemento" class="form-input" placeholder="Complemento (Opcional)">
                    </div>
                </div>
                <div id="box-retirada" class="hidden" style="text-align: center; color: #666; padding: 10px; background: #f9fafb; border-radius: 8px;"><p>Voc√™ ir√° retirar o pedido no balc√£o.</p></div>
            </div>

            <div class="checkout-card">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">üë§ Seus Dados</h3>
                <input type="text" id="nome-cliente" class="form-input" placeholder="Seu Nome" style="margin-bottom: 10px;">
                <input type="tel" id="tel-cliente" class="form-input" placeholder="WhatsApp (DDD) 99999-9999">
            </div>

            <div class="checkout-card">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">üçî Itens</h3>
                <div id="lista-resumo-checkout"></div>
            </div>

            <div class="checkout-card">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">üí≥ Pagamento</h3>
                <div id="alert-sinal" class="hidden" style="background: #fff7ed; padding: 10px; border-radius: 8px; border: 1px dashed #f97316; margin-bottom: 15px; font-size: 0.9rem; color: #c2410c;">‚ö†Ô∏è Pedido sob encomenda. Necess√°rio <strong>Sinal de 50%</strong>.</div>
                <div class="pagamento-grid">
                    <div class="pagamento-option" onclick="selPag('pix', this)" data-val="pix">üí† PIX</div>
                    <div class="pagamento-option" onclick="selPag('cartao', this)" data-val="cartao_maquina">üí≥ Cart√£o</div>
                    <div class="pagamento-option" onclick="selPag('dinheiro', this)" data-val="dinheiro">üíµ Dinheiro</div>
                </div>
                <div id="box-pix" class="hidden" style="margin-top: 15px; text-align: center;">
                    <p style="font-size: 0.9rem; color: #166534; margin-bottom: 5px;">Escaneie para pagar:</p>
                    <canvas id="qr-code" style="width: 150px; border: 4px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px;"></canvas>
                    <div id="pix-code-text" style="font-size: 0.7rem; word-break: break-all; background: #f0fdf4; padding: 5px; border-radius: 4px; margin-top: 5px;"></div>
                    <button class="btn-outline" onclick="copiarPix()" style="margin-top: 5px; font-size: 0.8rem;">Copiar C√≥digo</button>
                    
                    <div style="background: #e0f2fe; color: #0369a1; padding: 10px; border-radius: 8px; margin-top: 15px; font-weight: 600; font-size: 0.9rem; border: 1px dashed #7dd3fc;">
                        üì≤ Para confirmar seu pedido, envie o comprovante no WhatsApp!
                    </div>
                </div>
                <div id="box-dinheiro" class="hidden" style="margin-top: 10px;"><input type="number" id="troco" class="form-input" placeholder="Troco para quanto? (Ex: 50)"></div>
            </div>

            <div class="checkout-card">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">üé´ Cupom de Desconto</h3>
                <div class="cupom-box">
                    <input type="text" id="input-cupom" class="form-input" placeholder="C√≥digo">
                    <button class="btn" onclick="aplicarCupom()" style="background: #333; color: white; padding: 0 20px;">Aplicar</button>
                </div>
                <div id="msg-cupom" class="cupom-msg"></div>

                <div class="resumo-linha"><span>Subtotal</span> <span id="chk-subtotal">R$ 0,00</span></div>
                <div class="resumo-linha resumo-desconto" id="chk-box-desc"><span>Descontos</span> <span id="chk-desconto">- R$ 0,00</span></div>
                <div class="resumo-linha resumo-desconto" id="chk-box-cupom" class="hidden"><span>Desconto Cupom</span> <span id="chk-valor-cupom">- R$ 0,00</span></div>
                <div class="resumo-linha"><span>Entrega</span> <span id="chk-entrega">R$ 0,00</span></div>
                <div class="resumo-total">
                    <span id="lbl-total">Total</span>
                    <span id="chk-total">R$ 0,00</span>
                </div>
                <div id="resumo-sinal" class="hidden" style="margin-top: 10px; font-size: 0.95rem; border-top:1px solid #eee; padding-top:10px;">
                    <div class="resumo-linha" style="color: #c2410c; font-weight: 700;"><span>Pagar Agora (Sinal)</span> <span id="chk-sinal">R$ 0,00</span></div>
                    <div class="resumo-linha"><span>Restante na Entrega</span> <span id="chk-restante">R$ 0,00</span></div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 30px;">
                <button class="btn" onclick="trocarTela('cardapio')" style="flex:1; background:#e5e7eb; color: #374151;">Voltar</button>
                <button class="btn-primario" onclick="finalizarPedido()" style="flex:2;">‚úÖ Enviar Pedido</button>
            </div>
        </div>
    </div>

    <div id="btn-carrinho" class="btn-flutuante hidden" onclick="abrirModalCarrinho()">
        <span>üõí Meu Carrinho</span>
        <span id="float-total">R$ 0,00</span>
    </div>

    <a id="btn-whats-flutuante" href="#" target="_blank" class="whats-float hidden" title="Falar no WhatsApp">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
    </a>

    <div class="modal-overlay" id="modal-produto" onclick="if(event.target===this) fecharModal('modal-produto')">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">
                <h2 id="md-titulo" style="font-size:1.3rem; line-height:1.2;">...</h2>
                <button onclick="fecharModal('modal-produto')" style="background:none; border:none; font-size:1.5rem;">√ó</button>
            </div>
            
            <img id="md-img" src="" style="width:100%; height:200px; object-fit:cover; border-radius:12px; margin-bottom:15px; background:#eee;" onerror="this.src='https://placehold.co/400x200?text=Foto+Produto'">
            
            <p id="md-desc" style="color:#666; font-size:0.9rem; margin-bottom:10px; font-style: italic;"></p>
            
            <div id="md-estoque-aviso" class="hidden" style="font-size:0.85rem; margin-bottom:10px;"></div>

            <div id="md-detalhes-container" class="hidden" style="background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px;">
                <strong style="display:block; font-size:0.8rem; color:#4b5563; margin-bottom:4px;">Ingredientes / Detalhes:</strong>
                <p id="md-detalhes" style="color:#374151; font-size:0.85rem; margin:0; line-height:1.4;"></p>
            </div>

            <div id="md-encomenda-opt" class="hidden" style="background:#eff6ff; padding:10px; border-radius:8px; border:1px solid #bfdbfe; margin-bottom:15px;">
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem; font-weight:600; color:#1e40af;">
                    <input type="checkbox" id="md-check-enc" onchange="toggleAgendamento(this)"> Agendar Entrega
                </label>
                <div id="md-agendamento" class="hidden" style="margin-top:10px; display:grid; gap:8px;">
                    <input type="date" id="md-data" class="form-input"><input type="time" id="md-hora" class="form-input">
                </div>
            </div>
            
            <div id="md-obs-aviso" class="hidden" style="color: #ef4444; font-size: 0.85rem; margin-bottom: 15px; font-weight: 600; padding: 10px; background: #fee2e2; border-radius: 8px; border: 1px solid #fecaca;">
                ‚ö†Ô∏è Receita fechada: Este produto n√£o permite adi√ß√µes ou trocas.
            </div>

            <div id="md-itens-removiveis-container" class="hidden" style="margin-bottom: 15px; background: #fff7ed; padding: 10px; border-radius: 8px; border: 1px solid #fed7aa;">
                <strong style="display:block; font-size:0.85rem; color:#c2410c; margin-bottom:8px;">Deseja retirar algum item?</strong>
                <div id="md-lista-removiveis" style="display: flex; flex-direction: column; gap: 8px;"></div>
            </div>

            <textarea id="md-obs" class="form-textarea" placeholder="Observa√ß√µes? (Ex: Sem cebola, ponto da carne...)" rows="2" style="margin-bottom:15px;"></textarea>
            
            <div style="display:flex; gap:15px; align-items:center;">
                <div style="display:flex; align-items:center; border:1px solid #ddd; border-radius:8px;">
                    <button onclick="mudarQtd(-1)" style="padding:10px 15px; background:none; border:none; font-size:1.2rem;">-</button>
                    <span id="md-qtd" style="font-weight:700; width:30px; text-align:center;">1</span>
                    <button onclick="mudarQtd(1)" style="padding:10px 15px; background:none; border:none; font-size:1.2rem;">+</button>
                </div>
                <button class="btn-primario" onclick="addCarrinho()" style="flex:1; display:flex; justify-content:space-between; padding:12px 20px;">
                    <span>Adicionar</span><span id="md-preco">R$ 0,00</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-carrinho" onclick="if(event.target===this) fecharModal('modal-carrinho')">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2>Seu Pedido</h2><button onclick="fecharModal('modal-carrinho')" style="border:none; background:none; font-size:1.5rem;">√ó</button>
            </div>
            <div id="lista-carrinho" style="max-height:50vh; overflow-y:auto; margin-bottom:15px;"></div>
            <button class="btn-primario" onclick="irParaCheckout()" style="width:100%; padding:15px;">Finalizar Compra</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-rastreio" onclick="if(event.target===this) fecharModal('modal-rastreio')">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2>Acompanhar Pedidos</h2><button onclick="fecharModal('modal-rastreio')" style="border:none; background:none; font-size:1.5rem;">√ó</button>
            </div>
            <div id="lista-pedidos-rastreio" style="max-height:60vh; overflow-y:auto;">
                <p style="text-align:center; color:#999; padding:20px;">Carregando...</p>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { db, collection, getDocs, getDoc, doc, addDoc, updateDoc, onSnapshot, query, where, orderBy, formatarPreco, mostrarNotificacao, buscarEnderecoPorCEP, validarCEP, COLLECTIONS } from '../assets/js/firebase-config.js';
        import { increment } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"; 

        let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
        let produtos = [], categorias = [], configLoja = {};
        let prodSel = null, qtdSel = 1, tipoEntrega = 'entrega', pagSel = '';
        let rastreioListeners = [];
        let cupomAplicado = null; 

        document.addEventListener('DOMContentLoaded', () => {
            initListeners();
            atualizarCarrinhoUI();
            carregarEnderecoSalvo(); 
        });

        function carregarEnderecoSalvo() {
            const salvo = localStorage.getItem('ultimo_endereco');
            if(salvo) {
                const end = JSON.parse(salvo);
                if(end.cep) document.getElementById('cep').value = end.cep;
                if(end.logradouro) document.getElementById('endereco').value = end.logradouro;
                if(end.numero) document.getElementById('numero').value = end.numero;
                if(end.bairro) document.getElementById('bairro').value = end.bairro;
                if(end.cidade) document.getElementById('cidade').value = end.cidade;
                if(end.complemento) document.getElementById('complemento').value = end.complemento;
                if(end.nome) document.getElementById('nome-cliente').value = end.nome;
                if(end.tel) document.getElementById('tel-cliente').value = end.tel;
            }
        }

        window.limparEndereco = () => {
            document.getElementById('cep').value = '';
            document.getElementById('endereco').value = '';
            document.getElementById('numero').value = '';
            document.getElementById('bairro').value = '';
            document.getElementById('cidade').value = '';
            document.getElementById('complemento').value = '';
            mostrarNotificacao('Campos limpos para novo endere√ßo', 'sucesso');
        };

        function initListeners() {
            onSnapshot(collection(db, COLLECTIONS.CONFIGURACOES), snap => {
                if(!snap.empty) { configLoja = snap.docs[0].data(); atualizarUIConfig(); }
            });
            onSnapshot(query(collection(db, 'categorias'), orderBy('nome')), snap => {
                categorias = []; snap.forEach(d => categorias.push(d.data())); renderCatalogo();
            });
            onSnapshot(query(collection(db, COLLECTIONS.PRODUTOS), orderBy('nome')), snap => {
                produtos = []; snap.forEach(d => produtos.push({id:d.id, ...d.data()}));
                document.getElementById('loading').classList.add('hidden'); renderCatalogo();
            });
        }

        function atualizarUIConfig() {
            if(configLoja.nome) document.getElementById('nome-restaurante').textContent = configLoja.nome;
            if(configLoja.logoUrl) { 
                const img = document.getElementById('logo-img'); 
                img.src = configLoja.logoUrl; 
                img.style.display = 'block'; 
                document.getElementById('logo-text').style.display = 'none'; 
            }
            if(configLoja.slogan) document.getElementById('slogan-texto').textContent = configLoja.slogan;
            document.getElementById('tempo-entrega').textContent = `üïí ${configLoja.tempoEntrega || '-- min'}`;
            const badge = document.getElementById('status-loja');
            if(configLoja.lojaAberta) { badge.className = 'status-badge status-aberta'; badge.textContent = '‚óè Aberta'; }
            else { badge.className = 'status-badge status-fechada'; badge.textContent = '‚óè Fechada'; }
            
            const whatsBtn = document.getElementById('btn-whats-flutuante');
            if(configLoja.whatsapp) {
                whatsBtn.href = `https://wa.me/${configLoja.whatsapp.replace(/\D/g,'')}`;
                whatsBtn.classList.remove('hidden');
            }
        }

        function renderCatalogo() {
            const nav = document.getElementById('nav-categorias'); const main = document.getElementById('catalogo');
            nav.innerHTML = ''; main.innerHTML = '';
            if(produtos.length === 0) { document.getElementById('sem-produtos').classList.remove('hidden'); return; }
            document.getElementById('sem-produtos').classList.add('hidden');
            
            const maisVendidos = produtos.filter(p => p.maisVendido === true);
            if (maisVendidos.length > 0) {
                nav.innerHTML += `<li><a href="#cat-mais-vendidos" class="cat-btn" onclick="scrollCat(event, 'cat-mais-vendidos')">üî• Mais Vendidos</a></li>`;
                
                const section = document.createElement('section'); section.id = `cat-mais-vendidos`; section.className = 'secao-categoria';
                section.innerHTML = `<h2 class="secao-titulo">üî• Mais Vendidos</h2><div class="produtos-grid"></div>`;
                const grid = section.querySelector('.produtos-grid');
                maisVendidos.forEach(p => grid.appendChild(criarCard(p)));
                main.appendChild(section);
            }

            const catsAtivas = categorias.filter(c => produtos.some(p => p.categoria === c.slug));
            catsAtivas.forEach(cat => {
                nav.innerHTML += `<li><a href="#cat-${cat.slug}" class="cat-btn" onclick="scrollCat(event, 'cat-${cat.slug}')">${cat.nome}</a></li>`;
                const prodsCat = produtos.filter(p => p.categoria === cat.slug);
                const section = document.createElement('section'); section.id = `cat-${cat.slug}`; section.className = 'secao-categoria';
                section.innerHTML = `<h2 class="secao-titulo">${cat.nome}</h2><div class="produtos-grid"></div>`;
                const grid = section.querySelector('.produtos-grid');
                prodsCat.forEach(p => grid.appendChild(criarCard(p)));
                main.appendChild(section);
            });
        }

        function criarCard(p) {
            const div = document.createElement('div'); div.className = 'produto-card'; 
            
            const isEsgotado = (p.estoque !== null && p.estoque !== undefined && p.estoque <= 0);
            let pode = configLoja.lojaAberta || p.sobEncomenda;
            
            let btnTexto = '+';
            if (isEsgotado) {
                pode = false;
                btnTexto = 'üö´';
            } else if (!pode) {
                btnTexto = 'üîí';
            }

            if(!pode) div.style.opacity = '0.6';
            
            div.onclick = () => {
                if (isEsgotado) return mostrarNotificacao('Produto Esgotado!', 'erro');
                abrirModalProduto(p);
            };

            const preco = (p.emPromocao && p.precoPromocional) ? p.precoPromocional : p.preco;
            const precoHtml = (p.emPromocao && p.precoPromocional) ? `<span class="preco-antigo">${formatarPreco(p.preco)}</span> <span class="preco-novo">${formatarPreco(preco)}</span>` : formatarPreco(preco);
            const badgeEnc = p.sobEncomenda ? '<span class="badge-encomenda">ENCOMENDA</span>' : '';
            const badgeMaisVendido = p.maisVendido ? '<span class="badge-destaque">üî• MAIS VENDIDO</span>' : '';
            const tagEsg = isEsgotado ? '<span class="tag-esgotado">Esgotado</span>' : '';

            let tagEstoque = '';
            if (p.estoque !== null && p.estoque !== undefined && p.estoque > 0) {
                const txtEstoque = p.estoque <= 5 ? `üî• Restam s√≥ ${p.estoque}!` : `üì¶ ${p.estoque} dispon√≠veis`;
                const classeEstoque = p.estoque <= 5 ? 'badge-estoque baixo' : 'badge-estoque';
                tagEstoque = `<span class="${classeEstoque}">${txtEstoque}</span>`;
            }

            div.innerHTML = `${badgeMaisVendido}${badgeEnc}<img src="${p.imagemUrl}" class="produto-imagem" onerror="this.src='https://placehold.co/200?text=Foto'"><div class="produto-info"><h3 class="produto-titulo">${p.nome}</h3>${tagEsg}${tagEstoque}<p class="produto-descricao">${p.descricao || ''}</p><div class="produto-footer"><div class="produto-preco">${precoHtml}</div><button class="btn-add">${btnTexto}</button></div></div>`;
            return div;
        }

        window.abrirModalProduto = (p) => {
            const pode = configLoja.lojaAberta || p.sobEncomenda;
            if(!pode) return mostrarNotificacao('Loja fechada no momento.', 'erro');
            
            prodSel = p; qtdSel = 1;
            
            document.getElementById('md-titulo').textContent = p.nome;
            document.getElementById('md-desc').textContent = p.descricao || '';
            
            const avisoEstoque = document.getElementById('md-estoque-aviso');
            if (p.estoque !== null && p.estoque !== undefined && p.estoque > 0) {
                avisoEstoque.textContent = `Estoque dispon√≠vel: ${p.estoque} un.`;
                avisoEstoque.style.color = p.estoque <= 5 ? '#ea580c' : '#10b981';
                avisoEstoque.classList.remove('hidden');
            } else {
                avisoEstoque.classList.add('hidden');
            }

            const boxDetalhes = document.getElementById('md-detalhes-container');
            const txtDetalhes = document.getElementById('md-detalhes');
            if (p.detalhes && p.detalhes.trim() !== "") {
                txtDetalhes.textContent = p.detalhes;
                boxDetalhes.classList.remove('hidden');
            } else {
                boxDetalhes.classList.add('hidden');
            }

            document.getElementById('md-img').src = p.imagemUrl;
            document.getElementById('md-qtd').textContent = 1;
            
            const campoObs = document.getElementById('md-obs');
            const avisoObs = document.getElementById('md-obs-aviso');
            const boxRemoviveis = document.getElementById('md-itens-removiveis-container');
            const listaRemoviveis = document.getElementById('md-lista-removiveis');
            
            campoObs.value = '';
            listaRemoviveis.innerHTML = '';
            
            if (p.bloquearObs) {
                campoObs.classList.add('hidden');
                avisoObs.classList.remove('hidden');
                
                if (p.itensRemoviveis && p.itensRemoviveis.length > 0) {
                    p.itensRemoviveis.forEach(item => {
                        listaRemoviveis.innerHTML += `
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 0.95rem; color: #4b5563; cursor: pointer;">
                                <input type="checkbox" class="chk-removivel" value="${item}" style="width: 18px; height: 18px;">
                                <span>Sem <b>${item}</b></span>
                            </label>
                        `;
                    });
                    boxRemoviveis.classList.remove('hidden');
                } else {
                    boxRemoviveis.classList.add('hidden');
                }
            } else {
                campoObs.classList.remove('hidden');
                avisoObs.classList.add('hidden');
                boxRemoviveis.classList.add('hidden');
            }
            
            if(p.sobEncomenda) { document.getElementById('md-encomenda-opt').classList.remove('hidden'); document.getElementById('md-check-enc').checked = false; document.getElementById('md-agendamento').classList.add('hidden'); } else { document.getElementById('md-encomenda-opt').classList.add('hidden'); }
            
            atualizarPrecoModal(); 
            document.getElementById('modal-produto').classList.add('active');
        };

        window.mudarQtd = (v) => { 
            let novaQtd = qtdSel + v;
            if(novaQtd >= 1) {
                if (prodSel.estoque !== null && prodSel.estoque !== undefined) {
                    if (novaQtd > prodSel.estoque) {
                        return mostrarNotificacao(`Apenas ${prodSel.estoque} unidades em estoque!`, 'erro');
                    }
                }
                qtdSel = novaQtd; 
                document.getElementById('md-qtd').textContent = qtdSel; 
                atualizarPrecoModal(); 
            } 
        };

        function atualizarPrecoModal() {
            const preco = (prodSel.emPromocao && prodSel.precoPromocional) ? prodSel.precoPromocional : prodSel.preco;
            document.getElementById('md-preco').textContent = formatarPreco(preco * qtdSel);
        }
        window.toggleAgendamento = (chk) => { if(chk.checked) { document.getElementById('md-agendamento').classList.remove('hidden'); const d = new Date(); d.setDate(d.getDate()+1); document.getElementById('md-data').min = d.toISOString().split('T')[0]; } else { document.getElementById('md-agendamento').classList.add('hidden'); } }

        window.addCarrinho = () => {
            const isAgendado = document.getElementById('md-check-enc').checked;
            let agendamento = null;
            if(isAgendado) { const data = document.getElementById('md-data').value; const hora = document.getElementById('md-hora').value; if(!data || !hora) return mostrarNotificacao('Informe data e hora!', 'erro'); agendamento = { data, hora }; }
            
            const precoNormal = prodSel.preco;
            const precoFinal = (prodSel.emPromocao && prodSel.precoPromocional) ? prodSel.precoPromocional : prodSel.preco;

            let obsFinal = document.getElementById('md-obs').value.trim();
            if (prodSel.bloquearObs && prodSel.itensRemoviveis && prodSel.itensRemoviveis.length > 0) {
                const removidos = Array.from(document.querySelectorAll('.chk-removivel:checked')).map(chk => chk.value);
                if (removidos.length > 0) {
                    obsFinal = "Retirar: " + removidos.join(', ');
                }
            }

            carrinho.push({ 
                id: prodSel.id, 
                nome: prodSel.nome, 
                preco: precoFinal, 
                precoNormal: precoNormal, 
                qtd: qtdSel, 
                obs: obsFinal, 
                sobEncomenda: prodSel.sobEncomenda || false, 
                agendamento: agendamento 
            });
            salvarCarrinho(); fecharModal('modal-produto'); mostrarNotificacao('Adicionado!', 'sucesso');
        };

        function salvarCarrinho() { localStorage.setItem('carrinho', JSON.stringify(carrinho)); atualizarCarrinhoUI(); }

        function atualizarCarrinhoUI() {
            const subtotalNormal = carrinho.reduce((a,b) => a + (b.precoNormal * (b.qtd || b.quantidade || 1)), 0);
            const totalReal = carrinho.reduce((a,b) => a + (b.preco * (b.qtd || b.quantidade || 1)), 0);
            const desconto = subtotalNormal - totalReal;

            const dskList = document.getElementById('lista-carrinho-desktop');
            const dskFooter = document.getElementById('footer-carrinho-desktop');
            if(dskList) {
                dskList.innerHTML = '';
                if(carrinho.length === 0) { dskList.innerHTML = '<p style="text-align:center;color:#9ca3af;padding:20px;">Carrinho vazio üò¢</p>'; dskFooter.classList.add('hidden'); }
                else {
                    dskFooter.classList.remove('hidden');
                    document.getElementById('dsk-subtotal').textContent = formatarPreco(subtotalNormal);
                    document.getElementById('total-carrinho-desktop').textContent = formatarPreco(totalReal);
                    
                    if(desconto > 0) {
                        document.getElementById('dsk-box-desc').classList.remove('hidden');
                        document.getElementById('dsk-desconto').textContent = `- ${formatarPreco(desconto)}`;
                    } else {
                        document.getElementById('dsk-box-desc').classList.add('hidden');
                    }

                    carrinho.forEach((item, idx) => {
                        let enc = item.sobEncomenda ? '<small style="color:#2563eb;">(Enc)</small>' : '';
                        const q = item.qtd || item.quantidade || 1;
                        dskList.innerHTML += `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f3f4f6;"><div style="flex:1"><div style="font-weight:600;color:#374151;">${q}x ${item.nome} ${enc}</div><div style="font-size:0.85rem;color:#6b7280;">${formatarPreco(item.preco * q)}</div></div><button onclick="window.removeItem(${idx})" style="color:#ef4444;border:none;background:none;cursor:pointer;">√ó</button></div>`;
                    });
                }
            }
            const btn = document.getElementById('btn-carrinho');
            if(carrinho.length > 0) { btn.classList.remove('hidden'); document.getElementById('float-total').textContent = formatarPreco(totalReal); } else { btn.classList.add('hidden'); }
            const mobList = document.getElementById('lista-carrinho'); mobList.innerHTML = '';
            if(carrinho.length === 0) mobList.innerHTML = '<p style="text-align:center;color:#999;">Vazio.</p>';
            carrinho.forEach((item, idx) => { 
                const q = item.qtd || item.quantidade || 1;
                mobList.innerHTML += `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee;"><div><strong>${q}x ${item.nome}</strong><br>${formatarPreco(item.preco * q)}</div><button onclick="window.removeItem(${idx})" style="color:red;border:none;background:none;">üóëÔ∏è</button></div>`; 
            });
        }
        window.removeItem = (idx) => { carrinho.splice(idx, 1); salvarCarrinho(); };
        window.irParaCheckout = () => { if(carrinho.length === 0) return; fecharModal('modal-carrinho'); trocarTela('checkout'); atualizarResumoCheckout(); };

        window.mudarEntrega = (t) => { tipoEntrega = t; document.getElementById('opt-entrega').className = `entrega-option ${t==='entrega'?'selected':''}`; document.getElementById('opt-retirada').className = `entrega-option ${t==='retirada'?'selected':''}`; if(t==='entrega') { document.getElementById('box-endereco').classList.remove('hidden'); document.getElementById('box-retirada').classList.add('hidden'); } else { document.getElementById('box-endereco').classList.add('hidden'); document.getElementById('box-retirada').classList.remove('hidden'); } atualizarResumoCheckout(); };
        window.selPag = (t, el) => { pagSel = t; document.querySelectorAll('.pagamento-option').forEach(e => e.classList.remove('selected')); el.classList.add('selected'); document.getElementById('box-pix').classList.add('hidden'); document.getElementById('box-dinheiro').classList.add('hidden'); if(t==='pix') { document.getElementById('box-pix').classList.remove('hidden'); atualizarResumoCheckout(); } else if(t==='dinheiro') { document.getElementById('box-dinheiro').classList.remove('hidden'); } };

        window.aplicarCupom = async () => {
            const input = document.getElementById('input-cupom');
            const codigo = input.value.trim().toUpperCase();
            const msg = document.getElementById('msg-cupom');
            
            if(!codigo) return;

            msg.textContent = 'Verificando...'; msg.className = 'cupom-msg';

            try {
                const q = query(collection(db, 'cupons'), where('codigo', '==', codigo));
                const snap = await getDocs(q);

                if (snap.empty) {
                    msg.textContent = 'Cupom inv√°lido ou n√£o encontrado.'; msg.className = 'cupom-msg erro';
                    cupomAplicado = null;
                } else {
                    const docCupom = snap.docs[0];
                    const dados = docCupom.data();
                    const hoje = new Date().toISOString().split('T')[0];

                    if (dados.validade < hoje) {
                        msg.textContent = 'Este cupom venceu.'; msg.className = 'cupom-msg erro';
                        cupomAplicado = null;
                    } else if (dados.usos >= dados.limite) {
                        msg.textContent = 'Limite de uso deste cupom atingido.'; msg.className = 'cupom-msg erro';
                        cupomAplicado = null;
                    } else {
                        cupomAplicado = { id: docCupom.id, ...dados };
                        msg.textContent = `Desconto de ${formatarPreco(dados.valor)} aplicado!`;
                        msg.className = 'cupom-msg sucesso';
                    }
                }
                atualizarResumoCheckout();

            } catch(e) {
                console.error(e);
                msg.textContent = 'Erro ao validar cupom.'; msg.className = 'cupom-msg erro';
            }
        };

        function atualizarResumoCheckout() {
            const subtotalNormal = carrinho.reduce((a,b) => a + (b.precoNormal * (b.qtd || b.quantidade || 1)), 0);
            const totalProdutos = carrinho.reduce((a,b) => a + (b.preco * (b.qtd || b.quantidade || 1)), 0);
            const descontoProdutos = subtotalNormal - totalProdutos;
            
            let descontoCupom = 0;
            if (cupomAplicado) {
                descontoCupom = cupomAplicado.valor;
                if (descontoCupom > totalProdutos) descontoCupom = totalProdutos;
            }

            const taxa = tipoEntrega === 'entrega' ? (configLoja.taxaEntrega || 0) : 0;
            const totalFinal = (totalProdutos - descontoCupom) + taxa;

            document.getElementById('lista-resumo-checkout').innerHTML = carrinho.map(i => {
                const q = i.qtd || i.quantidade || 1;
                return `<div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.9rem;"><span>${q}x ${i.nome}</span> <span>${formatarPreco(i.preco*q)}</span></div>`;
            }).join('');
            
            document.getElementById('chk-subtotal').textContent = formatarPreco(subtotalNormal);
            document.getElementById('chk-entrega').textContent = taxa === 0 ? 'Gr√°tis' : formatarPreco(taxa);
            document.getElementById('chk-total').textContent = formatarPreco(totalFinal);

            if(descontoProdutos > 0) {
                document.getElementById('chk-box-desc').classList.remove('hidden');
                document.getElementById('chk-desconto').textContent = `- ${formatarPreco(descontoProdutos)}`;
            } else {
                document.getElementById('chk-box-desc').classList.add('hidden');
            }

            if (cupomAplicado) {
                document.getElementById('chk-box-cupom').classList.remove('hidden');
                document.getElementById('chk-valor-cupom').textContent = `- ${formatarPreco(descontoCupom)}`;
            } else {
                document.getElementById('chk-box-cupom').classList.add('hidden');
            }

            const temEnc = carrinho.some(i => i.sobEncomenda);
            if(temEnc) {
                document.getElementById('alert-sinal').classList.remove('hidden'); document.getElementById('resumo-sinal').classList.remove('hidden'); document.getElementById('lbl-total').textContent = 'Total Geral';
                const sinal = totalFinal / 2;
                document.getElementById('chk-sinal').textContent = formatarPreco(sinal);
                document.getElementById('chk-restante').textContent = formatarPreco(totalFinal - sinal);
                if(pagSel === 'pix') gerarPix(sinal);
            } else {
                document.getElementById('alert-sinal').classList.add('hidden'); document.getElementById('resumo-sinal').classList.add('hidden'); document.getElementById('lbl-total').textContent = 'Total a Pagar';
                if(pagSel === 'pix') gerarPix(totalFinal);
            }
        }

        window.finalizarPedido = async () => {
            if(carrinho.length === 0) return;
            if(!document.getElementById('nome-cliente').value || !document.getElementById('tel-cliente').value) return mostrarNotificacao('Preencha seus dados!', 'erro');
            if(!pagSel) return mostrarNotificacao('Selecione pagamento!', 'erro');
            if(tipoEntrega === 'entrega' && !document.getElementById('endereco').value) return mostrarNotificacao('Endere√ßo incompleto!', 'erro');

            const totalProdutos = carrinho.reduce((a,b) => a + (b.preco * (b.qtd || b.quantidade || 1)), 0);
            let descCupom = 0;
            if(cupomAplicado) {
                descCupom = cupomAplicado.valor;
                if(descCupom > totalProdutos) descCupom = totalProdutos;
            }
            const total = (totalProdutos - descCupom) + (tipoEntrega==='entrega'?(configLoja.taxaEntrega||0):0);
            
            const enc = carrinho.some(i=>i.sobEncomenda);
            
            const dadosSalvar = {
                nome: document.getElementById('nome-cliente').value,
                tel: document.getElementById('tel-cliente').value,
                cep: document.getElementById('cep').value,
                logradouro: document.getElementById('endereco').value,
                numero: document.getElementById('numero').value,
                bairro: document.getElementById('bairro').value,
                cidade: document.getElementById('cidade').value,
                complemento: document.getElementById('complemento').value
            };
            localStorage.setItem('ultimo_endereco', JSON.stringify(dadosSalvar));

            const pedido = {
                idDisplay: '#'+Math.floor(1000+Math.random()*9000),
                cliente: { nome: dadosSalvar.nome, telefone: dadosSalvar.tel },
                tipoEntrega,
                endereco: tipoEntrega==='entrega' ? dadosSalvar : null,
                itens: carrinho, total: total, isEncomenda: enc, valorSinal: enc?total/2:total, valorRestante: enc?total/2:0, saldoDevedor: enc,
                pagamento: { forma: pagSel, troco: document.getElementById('troco').value, status: enc?'parcial_sinal':'pendente' },
                status: 'recebido', criadoEm: new Date(), atualizadoEm: new Date(),
                cupom: cupomAplicado ? { codigo: cupomAplicado.codigo, desconto: descCupom } : null
            };

            try {
                const ref = await addDoc(collection(db, COLLECTIONS.PEDIDOS), pedido);
                
                if (cupomAplicado) {
                    const cupomRef = doc(db, 'cupons', cupomAplicado.id);
                    await updateDoc(cupomRef, { usos: increment(1) });
                }

                for (let item of carrinho) {
                    try {
                        const prodRef = doc(db, COLLECTIONS.PRODUTOS, item.id);
                        const pData = produtos.find(p => p.id === item.id);
                        if (pData && pData.estoque !== null && pData.estoque !== undefined) {
                            await updateDoc(prodRef, {
                                estoque: increment(-item.qtd)
                            });
                        }
                    } catch (err) {
                        console.error("Erro ao baixar estoque", err);
                    }
                }

                let meus = JSON.parse(localStorage.getItem('meus_pedidos_ids'))||[]; meus.push(ref.id); localStorage.setItem('meus_pedidos_ids', JSON.stringify(meus));
                localStorage.removeItem('carrinho'); carrinho = [];
                
                enviarWhatsApp(pedido); 
                
                mostrarNotificacao('Pedido enviado!', 'sucesso');
                setTimeout(() => window.location.reload(), 2000);
            } catch(e) { console.error(e); mostrarNotificacao('Erro ao enviar', 'erro'); }
        };

        function enviarWhatsApp(p) {
            let msg = `*NOVO PEDIDO ${p.idDisplay}*\n`;
            msg += `üë§ ${p.cliente.nome}\n`;
            msg += `üì¶ *Tipo:* ${p.tipoEntrega === 'entrega' ? 'üõµ Entrega' : 'üè™ Retirada'}\n\n`;

            p.itens.forEach(i => {
                const q = i.qtd || i.quantidade || 1;
                msg += `‚ñ™Ô∏è ${q}x ${i.nome}`;
                if(i.sobEncomenda) msg += ` (Enc)`;
                msg += `\n`;
                if(i.obs) msg += `   _Obs: ${i.obs}_\n`;
                if(i.agendamento) msg += `   üìÖ *Agendado:* ${new Date(i.agendamento.data+'T00:00:00').toLocaleDateString()} √†s ${i.agendamento.hora}\n`;
            });

            if (p.cupom) {
                msg += `\nüé´ *Cupom:* ${p.cupom.codigo} (-${formatarPreco(p.cupom.desconto)})`;
            }

            msg += `\nüí∞ *Total:* ${formatarPreco(p.total)}`;
            if(p.isEncomenda) {
                msg += `\nüîµ *Sinal:* ${formatarPreco(p.valorSinal)}`;
                msg += `\nüî¥ *Restante:* ${formatarPreco(p.valorRestante)}`;
            }

            msg += `\nüí≥ *Pagamento:* ${p.pagamento.forma.toUpperCase()}`;
            if(p.pagamento.troco) msg += ` (Troco p/ ${p.pagamento.troco})`;

            if(p.tipoEntrega === 'entrega' && p.endereco) {
                msg += `\n\nüìç *Endere√ßo:*\n${p.endereco.logradouro}, ${p.endereco.numero}\n${p.endereco.bairro}`;
                if(p.endereco.complemento) msg += `\nComp: ${p.endereco.complemento}`;
            }

            const tel = configLoja.whatsapp ? configLoja.whatsapp.replace(/\D/g, '') : '';
            if(tel) {
                window.open(`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`, '_blank');
            }
        }

        window.abrirRastreio = async () => {
            document.getElementById('modal-rastreio').classList.add('active');
            const lista = document.getElementById('lista-pedidos-rastreio');
            const ids = JSON.parse(localStorage.getItem('meus_pedidos_ids')) || [];

            rastreioListeners.forEach(unsub => unsub());
            rastreioListeners = [];

            if (ids.length === 0) {
                lista.innerHTML = '<p style="text-align:center;padding:20px;color:#999;">Sem pedidos recentes.</p>';
                return;
            }

            lista.innerHTML = '';
            const ultimos = ids.slice(-5).reverse();

            ultimos.forEach(pid => {
                const div = document.createElement('div');
                div.id = `ped-${pid}`;
                div.style.marginBottom = '10px';
                div.innerHTML = '<div style="padding:15px; border:1px solid #eee; border-radius:12px; text-align:center; color:#999;">Carregando status...</div>';
                
                lista.appendChild(div);

                const unsub = onSnapshot(doc(db, COLLECTIONS.PEDIDOS, pid), (docSnap) => {
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        const cor = d.status === 'entregue' ? '#10b981' : (d.status === 'recebido' ? '#3b82f6' : '#f59e0b');
                        const statusNome = d.status.replace('_', ' ').toUpperCase();

                        div.innerHTML = `
                            <div style="background:#f9fafb; padding:15px; border-radius:12px; border:1px solid #eee; border-left: 5px solid ${cor};">
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                    <strong>Pedido ${d.idDisplay || '#'}</strong>
                                    <span style="color:${cor}; font-weight:800; font-size:0.8rem;">${statusNome}</span>
                                </div>
                                <div style="font-size:0.9rem; color:#666;">
                                    ${d.criadoEm ? d.criadoEm.toDate().toLocaleString() : ''} - ${formatarPreco(d.total)}
                                </div>
                            </div>
                        `;
                    } else {
                        div.innerHTML = '<div style="padding:10px; color:red; text-align:center;">Pedido n√£o encontrado</div>';
                    }
                });
                
                rastreioListeners.push(unsub);
            });
        };

        window.trocarTela = (t) => { document.querySelectorAll('.view-section').forEach(s=>s.classList.remove('active')); document.getElementById('view-'+t).classList.add('active'); window.scrollTo(0,0); if(t==='cardapio') atualizarCarrinhoUI(); };
        window.scrollCat = (e, id) => { e.preventDefault(); document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); const el = document.getElementById(id); if(el) window.scrollTo({top: el.offsetTop-130, behavior:'smooth'}); };
        window.abrirModalCarrinho = () => document.getElementById('modal-carrinho').classList.add('active');
        window.fecharModal = (id) => document.getElementById(id).classList.remove('active');
        window.buscarCep = async (cep) => { if(validarCEP(cep)) { const end = await buscarEnderecoPorCEP(cep); if(end) { document.getElementById('endereco').value = end.logradouro; document.getElementById('bairro').value = end.bairro; document.getElementById('cidade').value = end.cidade; document.getElementById('numero').focus(); } } }
        let pixPayload = ''; function gerarPix(v) { if(!configLoja.chavePix || v<=0) return; const p = gerarPayloadPixString(configLoja.chavePix, configLoja.nomeBeneficiario||'Loja', configLoja.cidadeBeneficiario||'Cidade', v.toFixed(2)); pixPayload = p; new QRious({ element: document.getElementById('qr-code'), value: p, size: 150 }); document.getElementById('pix-code-text').textContent = p; }
        window.copiarPix = () => { navigator.clipboard.writeText(pixPayload); mostrarNotificacao('Copiado!', 'sucesso'); };
        function gerarPayloadPixString(chave, nome, cidade, valor) { const n=nome.substring(0,25).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase(); const c=cidade.substring(0,15).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase(); const p=["000201","26",(("0014BR.GOV.BCB.PIX01"+chave.length.toString().padStart(2,'0')+chave).length).toString().padStart(2,'0'),"0014BR.GOV.BCB.PIX01"+chave.length.toString().padStart(2,'0')+chave,"52040000","5303986","54"+valor.length.toString().padStart(2,'0')+valor,"5802BR","59"+n.length.toString().padStart(2,'0')+n,"60"+c.length.toString().padStart(2,'0')+c,"62070503***","6304"].join(""); return p+crc16(p); }
        function crc16(p) { let c=0xFFFF; for(let i=0;i<p.length;i++){ c^=p.charCodeAt(i)<<8; for(let j=0;j<8;j++) if((c&0x8000)!==0) c=(c<<1)^0x1021; else c=c<<1; } return (c&0xFFFF).toString(16).toUpperCase().padStart(4,"0"); }
    </script>
</body>
</html>
